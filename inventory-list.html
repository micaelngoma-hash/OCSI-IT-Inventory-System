<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Inventory List</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}
  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 52px);}
  .sidebar{background:var(--bg2);color:white;padding:14px;}
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:0.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .nav .icon{width:18px;text-align:center;opacity:.8;}
  .content{padding:18px;max-width:1150px;margin:0 auto;width:100%;}
  h1{margin:0 0 10px;font-size:1.4rem;}
  .badge{padding:2px 7px;border-radius:999px;font-size:.75rem;}
  .badge-admin{background:rgba(34,197,94,.12);color:#16a34a;}
  .badge-it{background:rgba(59,130,246,.12);color:#1d4ed8;}
  .badge-viewer{background:rgba(148,163,184,.2);color:#475569;}
  .toolbar{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:10px;gap:10px;flex-wrap:wrap;
  }
  .search-box{
    display:flex;align-items:center;gap:6px;
    background:white;border:1px solid var(--border);
    border-radius:999px;padding:4px 10px;
    max-width:280px;width:100%;
  }
  .search-box input{
    border:none;outline:none;font-size:.88rem;width:100%;
  }
  .filters{display:flex;gap:8px;flex-wrap:wrap;}
  select{
    padding:6px 8px;border-radius:999px;
    border:1px solid var(--border);font-size:.85rem;background:white;
  }
  .btn{
    border:none;cursor:pointer;
    padding:6px 12px;border-radius:999px;
    font-size:.85rem;font-weight:500;
    display:inline-flex;align-items:center;gap:5px;
    text-decoration:none;
  }
  .btn-primary{background:var(--brand);color:white;}
  .btn-ghost{background:transparent;border:1px solid #cbd5e1;color:#0f172a;}

  /* Small row buttons */
  .btn-row{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid #cbd5e1;
    background:white;
    font-size:.8rem;
    text-decoration:none;
    color:#0f172a;
  }
  .btn-row + .btn-row{margin-left:4px;}
  .btn-row-primary{
    border-color:var(--brand);
    color:white;
    background:var(--brand);
  }

  .table-wrap{
    background:white;border:1px solid var(--border);
    border-radius:12px;overflow:auto;
  }
  table{border-collapse:collapse;width:100%;min-width:850px;}
  th,td{
    padding:8px 10px;border-bottom:1px solid #f1f5f9;
    font-size:.88rem;text-align:left;
  }
  th{background:#f8fafc;font-weight:600;color:#475569;position:sticky;top:0;z-index:5;}
  tr:hover td{background:#f9fafb;}
  .pill{
    display:inline-flex;padding:2px 8px;border-radius:999px;
    font-size:.75rem;
  }
  .pill-green{background:#dcfce7;color:#166534;}
  .pill-blue{background:#dbeafe;color:#1d4ed8;}
  .pill-gray{background:#e5e7eb;color:#374151;}
  .pill-red{background:#fee2e2;color:#b91c1c;}
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Inventory List</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üè†</span><span>Main Dashboard</span></a>
      <a class="active" href="inventory-list.html"><span class="icon">üìã</span><span>Inventory List</span></a>
      <a href="software-dashboard.html"><span class="icon">üíª</span><span>Software</span></a>
      <a href="software-licenses.html"><span class="icon">üîë</span><span>Licenses</span></a>
      <a href="admin-console.html"><span class="icon">‚öôÔ∏è</span><span>Admin Console</span></a>
      <a href="export.html"><span class="icon">‚¨áÔ∏è</span><span>Export</span></a>
      <a href="audits.html"><span class="icon">üïí</span><span>Audits</span></a>
      <a href="login.html"><span class="icon">üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1>Inventory</h1>

    <div class="toolbar">
      <div class="search-box">
        <span>üîç</span>
        <input id="search" placeholder="Search by Asset ID, name, user, location‚Ä¶"/>
      </div>
      <div class="filters">
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option value="in-use">In use</option>
          <option value="in-storage">In storage</option>
          <option value="loaned">Loaned</option>
          <option value="retired">Retired</option>
          <option value="repair">Under repair</option>
        </select>
        <button id="addBtn" class="btn btn-primary" type="button">
          ‚ûï New Device
        </button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Asset ID</th>
            <th>Device Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Location</th>
            <th>IP</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8">Loading devices‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, getDocs, getDoc, doc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  const ALLOWED_ROLES = ["admin","it","viewer"];
  const EDIT_ROLES = ["admin","it"];

  const whoEl = document.getElementById("who");
  const tbody = document.getElementById("tbody");
  const searchInput = document.getElementById("search");
  const statusFilter = document.getElementById("statusFilter");
  const addBtn = document.getElementById("addBtn");

  let currentRole = "viewer";
  let allItems = [];

  onAuthStateChanged(auth, async user=>{
    if(!user){
      location.href="login.html";
      return;
    }

    const uSnap = await getDoc(doc(db,"users",user.uid));
    const role  = uSnap.exists()? (uSnap.data().role || "viewer") : "viewer";
    currentRole = role;

    if(!ALLOWED_ROLES.includes(role)){
      alert("Access denied.");
      location.href="index.html";
      return;
    }

    const badgeClass = role==="admin" ? "badge-admin"
                      : role==="it" ? "badge-it" : "badge-viewer";
    whoEl.innerHTML = `${user.email} <span class="badge ${badgeClass}">${role}</span>`;

    if(!EDIT_ROLES.includes(role)){
      addBtn.style.display="none";
    } else {
      addBtn.onclick = ()=> location.href="item-form.html";
    }

    await loadItems();
  });

  async function loadItems(){
    const snap = await getDocs(collection(db,"items"));
    allItems = [];
    snap.forEach(docSnap=>{
      allItems.push({ id: docSnap.id, ...docSnap.data() });
    });
    render();
  }

  function render(){
    const term = (searchInput.value || "").toLowerCase();
    const st   = statusFilter.value;

    const rows = allItems.filter(it=>{
      if(st && (it.status||"")!==st) return false;
      if(!term) return true;
      const hay = [
        it.assetId, it.deviceName, it.assetType,
        it.assignedTo, it.location, it.department, it.ipAddress
      ].join(" ").toLowerCase();
      return hay.includes(term);
    });

    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="8">No devices found.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(it=>{
      const status = (it.status || "unknown");
      let pillClass = "pill-gray";
      if(status==="in-use") pillClass="pill-green";
      else if(status==="loaned") pillClass="pill-blue";
      else if(status==="retired" || status==="repair") pillClass="pill-red";

      const label = status.replace(/-/g," ");

      const viewUrl = `item.html?id=${encodeURIComponent(it.id)}`;
      const editUrl = `item-form.html?id=${encodeURIComponent(it.id)}`;

      const editButton = EDIT_ROLES.includes(currentRole)
        ? `<a class="btn-row btn-row-primary" href="${editUrl}">Edit</a>`
        : "";

      return `
        <tr>
          <td>${escapeHtml(it.assetId || "")}</td>
          <td>${escapeHtml(it.deviceName || "")}</td>
          <td>${escapeHtml(it.assetType || "")}</td>
          <td><span class="pill ${pillClass}">${escapeHtml(label)}</span></td>
          <td>${escapeHtml(it.assignedTo || "")}</td>
          <td>${escapeHtml((it.location || "") + (it.buildingFloor ? " ‚Äì "+it.buildingFloor:""))}</td>
          <td>${escapeHtml(it.ipAddress || "")}</td>
          <td>
            <a class="btn-row" href="${viewUrl}">View</a>
            ${editButton}
          </td>
        </tr>`;
    }).join("");
  }

  function escapeHtml(s){
    return s ? s.replace(/[&<>"']/g, c=>(
      { "&":"&amp;","<":"&lt;"," >":"&gt;","\"":"&quot;","'":"&#39;" }[c] || c
    )) : "";
  }

  searchInput.addEventListener("input", render);
  statusFilter.addEventListener("change", render);
</script>

</body>
</html>
