<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory ‚Äì Inventory List</title>

<!-- QR Library -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  :root{
    --bg:#0f172a;
    --bg2:#0b1020;
    --brand:#1a73e8;
    --border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .layout{
    display:grid;grid-template-columns:240px 1fr;
    min-height:calc(100vh - 52px);
  }
  .sidebar{
    background:var(--bg2);color:white;padding:14px;
  }
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
  }
  .nav a.active,.nav a:hover{background:#111a33;}

  .content{padding:18px;max-width:1150px;margin:0 auto;}

  .table-wrap{
    background:white;border:1px solid var(--border);
    border-radius:12px;overflow:auto;margin-top:10px;
  }
  table{border-collapse:collapse;width:100%;min-width:950px;}
  th,td{
    padding:8px 10px;border-bottom:1px solid #f1f5f9;
    font-size:.88rem;text-align:left;
  }
  th{
    background:#f8fafc;font-weight:600;color:#475569;
    position:sticky;top:0;z-index:5;
  }
  tr:hover td{background:#f9fafb;}

  /* QR Modal */
  #qrModal{
    display:none;position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.55);backdrop-filter:blur(3px);
    justify-content:center;align-items:center;z-index:5000;
  }
  #qrBox svg{width:100%;}

  /* Floating Print Button (FAB) */
  #fabPrint{
    position:fixed;
    bottom:24px;right:24px;
    width:62px;height:62px;
    background:var(--brand);
    border-radius:50%;
    display:flex;
    justify-content:center;
    align-items:center;
    color:white;
    font-size:28px;
    cursor:pointer;
    box-shadow:0 6px 18px rgba(0,0,0,0.25);
    transition:transform .2s ease, opacity .2s;
    opacity:0;
    visibility:hidden;
    z-index:4000;
  }
  #fabPrint:hover{
    transform:scale(1.08);
  }
  /* Tooltip */
  #fabPrint::after{
    content:"Print Selected Labels";
    position:absolute;
    right:75px;
    background:black;
    color:white;
    padding:6px 12px;
    border-radius:6px;
    font-size:.78rem;
    white-space:nowrap;
    opacity:0;
    transform:translateY(6px);
    transition:opacity .2s, transform .2s;
    pointer-events:none;
  }
  #fabPrint:hover::after{
    opacity:1;
    transform:translateY(0);
  }
</style>
</head>

<body>

<!-- üîπ TOP BAR -->
<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Inventory List</div>
  <div id="who" style="opacity:.9;font-size:.85rem;">Checking session‚Ä¶</div>
</div>

<div class="layout">

  <!-- üîπ SIDEBAR -->
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html">üìä Main Dashboard</a>
      <a href="software-licenses.html">üîë Software Licenses</a>
      <a class="active" href="inventory-list.html">üíª Hardware</a>
      <a href="scan.html">üì± QR Scan Device</a>
      <a href="audits.html">üïí Audits</a>
      <a href="admin-console.html">‚öôÔ∏è Admin Console</a>
      <a href="login.html">üö™ Logout</a>
    </nav>
  </aside>

  <!-- üîπ MAIN CONTENT -->
  <main class="content">

    <h1>Inventory</h1>
    <p class="subtitle">Browse, search, manage devices, and generate QR labels.</p>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="checkAll"/></th>
            <th>Asset ID</th>
            <th>Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>Assigned</th>
            <th>Location</th>
            <th>QR</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9">Loading...</td></tr>
        </tbody>
      </table>
    </div>

  </main>
</div>

<!-- üîπ Floating Print FAB -->
<div id="fabPrint" onclick="bulkPrint()">üñ®</div>

<!-- üîπ QR Modal UI -->
<div id="qrModal">
  <div style="background:white;padding:20px;border-radius:14px;width:320px;text-align:center;">
    <h3>Device QR Code</h3>
    <div id="qrBox" style="margin:15px auto;"></div>

    <button id="btnDownloadQR"
            style="padding:8px 16px;background:#1a73e8;color:white;border-radius:999px;border:none;cursor:pointer;">
      ‚¨áÔ∏è Download SVG
    </button>
    <br/>
    <button onclick="closeQR()"
            style="margin-top:10px;padding:6px 12px;border-radius:999px;
                   border:1px solid #cbd5e1;background:white;cursor:pointer;">
      Close
    </button>
  </div>
</div>

<!-- ------------------------------- -->
<!-- üîπ JAVASCRIPT SECTION -->
<!-- ------------------------------- -->
<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const tbody = document.getElementById("tbody");
  const checkAll = document.getElementById("checkAll");
  const fabPrint = document.getElementById("fabPrint");
  let selected = new Set();
  let allItems = [];

  watchAuth({
    allowedRoles:["admin","it","viewer"],
    whoEl: document.getElementById("who"),
    onReady: async () => loadItems()
  });

  async function loadItems(){
    const snap = await getDocs(collection(db,"items"));
    allItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderTable();
  }

  function renderTable(){
    tbody.innerHTML = allItems.map(item => {
      return `
      <tr>
        <td><input type="checkbox" class="chk" data-id="${item.id}"></td>
        <td>${item.assetId || ""}</td>
        <td>${item.deviceName || ""}</td>
        <td>${item.assetType || ""}</td>
        <td>${item.status || ""}</td>
        <td>${item.assignedTo || ""}</td>
        <td>${item.location || ""}</td>

        <!-- QR Button -->
        <td>
          <button onclick="openQR('${item.id}', '${item.assetId}', '${item.deviceName}')"
                  style="padding:4px 8px;border-radius:8px;border:1px solid #cbd5e1;background:white;cursor:pointer;">
            üì±
          </button>
        </td>

        <!-- View/Edit -->
        <td>
          <a href="item.html?id=${item.id}" class="btn btn-ghost" style="padding:4px 8px;">View</a>
        </td>
      </tr>`;
    }).join("");

    document.querySelectorAll(".chk").forEach(chk => {
      chk.addEventListener("change", () => updateSelection(chk));
    });

    checkAll.onchange = () => {
      selected.clear();
      document.querySelectorAll(".chk").forEach(chk => {
        chk.checked = checkAll.checked;
        if(chk.checked) selected.add(chk.dataset.id);
      });
      updateFAB();
    };
  }

  function updateSelection(chk){
    if(chk.checked) selected.add(chk.dataset.id);
    else selected.delete(chk.dataset.id);
    updateFAB();
  }

  function updateFAB(){
    if(selected.size > 0){
      fabPrint.style.opacity = "1";
      fabPrint.style.visibility = "visible";
    } else {
      fabPrint.style.opacity = "0";
      fabPrint.style.visibility = "hidden";
    }
  }

  /* ---------------------------
      QR CODE MODAL
  ----------------------------*/
  window.openQR = async function(id, assetId, name){
    const qrData = `${location.origin}/item.html?id=${id}`;
    const svg = await QRCode.toString(qrData, {
      type:"svg",
      margin:2,
      scale:12,
      errorCorrectionLevel:"H"
    });
    document.getElementById("qrBox").innerHTML = svg;

    document.getElementById("btnDownloadQR").onclick = () => {
      const blob = new Blob([svg], { type:"image/svg+xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `${assetId || name || "qr"}.svg`;
      a.click();
    };

    document.getElementById("qrModal").style.display = "flex";
  };

  window.closeQR = () => {
    document.getElementById("qrModal").style.display = "none";
  };

  /* ---------------------------
      BULK PRINT LABELS
  ----------------------------*/
  window.bulkPrint = () => {
    if(selected.size === 0) return;
    const ids = Array.from(selected);
    window.location.href = `print-labels.html?ids=${ids.join(",")}`;
  };
</script>

</body>
</html>
