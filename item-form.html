<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Device ‚Äì Add / Edit | OCSI IT</title>
  <style>
    :root{ --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb; }
    *{box-sizing:border-box;}
    body{margin:0;font-family:system-ui;background:#f5f7fb;color:#1e293b;}
    .topbar{ position:sticky;top:0;z-index:20;background:var(--bg);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center; }
    .layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 52px);}
    .sidebar{background:var(--bg2);color:white;padding:14px;}
    .nav a{ display:flex;align-items:center;gap:8px;padding:9px 11px;border-radius:9px;color:#dbe4ff;text-decoration:none;margin-bottom:6px;font-size:0.92rem; }
    .nav a:hover{background:#111a33;}
    .content{padding:18px;max-width:1100px;margin:0 auto;width:100%;}
    h1{margin:0 0 14px;font-size:1.4rem;}
    .card{ background:white;border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:14px; }
    .card h2{margin:0 0 10px;font-size:1.05rem;border-bottom:1px solid #f1f5f9;padding-bottom:8px;}
    .grid-2{ display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:10px 16px; }
    label{display:block;font-size:0.82rem;color:#475569;margin-bottom:3px;font-weight:600;}
    input,select,textarea{ width:100%;padding:8px;border-radius:8px;border:1px solid #cbd5e1;font-size:0.9rem; }
    .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:14px;padding:20px 0;}
    .btn{ border:none;cursor:pointer;padding:10px 20px;border-radius:999px;font-size:.9rem;font-weight:600; }
    .btn-primary{background:var(--brand);color:white;}
    .btn-ghost{background:transparent;color:#475569;}
    .danger-text{color:#b91c1c;font-size:.8rem;margin-right:auto;display:flex;align-items:center;}
    @media(max-width:768px){ .layout{grid-template-columns:1fr;} .sidebar{display:none;} }
  </style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Device Form</div>
  <div id="who">Checking session‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span>üè†</span><span>Dashboard</span></a>
      <a href="inventory-list.html"><span>üíª</span><span>Inventory</span></a>
      <a href="scan.html"><span>üì±</span><span>QR Scanner</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1 id="formTitle">New Device</h1>

    <form id="deviceForm">
      <section class="card">
        <h2>Identification</h2>
        <div class="grid-2">
          <div>
            <label for="assetId">Asset ID</label>
            <input id="assetId" name="assetId" required placeholder="e.g., OCSI-2025-01" />
          </div>
          <div>
            <label for="deviceName">Device Name</label>
            <input id="deviceName" name="deviceName" required />
          </div>
          <div>
            <label for="assetType">Asset Type</label>
            <input id="assetType" name="assetType" placeholder="Laptop, Desktop, iPad..." />
          </div>
          <div>
            <label for="manufacturer">Manufacturer & Model</label>
            <input id="manufacturer" name="manufacturer" />
          </div>
          <div>
            <label for="serialNumber">Serial Number</label>
            <input id="serialNumber" name="serialNumber" />
          </div>
          <div>
            <label for="status">Status</label>
            <select id="status" name="status">
              <option value="In Use">In Use</option>
              <option value="In Storage">In Storage</option>
              <option value="Repair">Repair</option>
              <option value="Retired">Retired</option>
            </select>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Assignment & Network</h2>
        <div class="grid-2">
          <div><label for="assignedTo">Assigned To</label><input id="assignedTo" name="assignedTo" /></div>
          <div><label for="department">Department</label><input id="department" name="department" /></div>
          <div><label for="location">Location</label><input id="location" name="location" /></div>
          <div><label for="ipAddress">IP Address</label><input id="ipAddress" name="ipAddress" /></div>
          <div><label for="macAddress">MAC Address</label><input id="macAddress" name="macAddress" /></div>
        </div>
      </section>

      <section class="card">
        <h2>Notes</h2>
        <textarea id="notes" name="notes"></textarea>
      </section>

      <div class="actions">
        <div id="editWarning" class="danger-text"></div>
        <button type="button" class="btn btn-ghost" onclick="history.back()">Cancel</button>
        <button class="btn btn-primary" type="submit" id="saveBtn">Save Device</button>
      </div>
    </form>
  </main>
</div>

<script type="module">
  import { db, watchAuth, logAudit } from "./firebase.js";
  import { doc, getDoc, setDoc, addDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const form = document.getElementById("deviceForm");
  const formTitle = document.getElementById("formTitle");
  const editWarning = document.getElementById("editWarning");
  const params = new URLSearchParams(location.search);
  const itemId = params.get("id");

  let currentRole = "viewer";

  watchAuth({
    allowedRoles: ["admin", "it", "viewer"],
    whoEl: document.getElementById("who"),
    onReady: async (user, role) => {
      currentRole = role;
      if (role === "viewer") {
        editWarning.textContent = "‚ö†Ô∏è Read-only mode";
        form.querySelectorAll("input, select, textarea").forEach(el => el.disabled = true);
        document.getElementById("saveBtn").style.display = "none";
      }

      if (itemId) {
        formTitle.textContent = "Edit Device";
        await loadItem(itemId);
      }
    }
  });

  async function loadItem(id) {
    const snap = await getDoc(doc(db, "items", id));
    if (!snap.exists()) return;
    const d = snap.data();

    // Map fields to form inputs
    Object.keys(d).forEach(key => {
      const el = document.getElementById(key);
      if (el) el.value = d[key] || "";
    });
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (currentRole === "viewer") return;

    const btn = document.getElementById("saveBtn");
    btn.disabled = true;
    btn.textContent = "Saving...";

    const fd = new FormData(form);
    const data = Object.fromEntries(fd.entries());
    data.updatedAt = serverTimestamp();

    try {
      if (itemId) {
        await setDoc(doc(db, "items", itemId), data, { merge: true });
        await logAudit("update", data.assetId, `Modified device: ${data.deviceName}`);
      } else {
        data.createdAt = serverTimestamp();
        await addDoc(collection(db, "items"), data);
        await logAudit("create", data.assetId, `Added new device: ${data.deviceName}`);
      }
      alert("Success!");
      location.href = `item.html?id=${itemId || ''}`;
    } catch (err) {
      alert("Error: " + err.message);
    } finally {
      btn.disabled = false;
      btn.textContent = "Save Device";
    }
  });
</script>
</body>
</html>
