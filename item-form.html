<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory ‚Äì Edit Device</title>

<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }

  .layout{
    display:grid;grid-template-columns:240px 1fr;
    min-height:calc(100vh - 52px);
  }

  .sidebar{background:var(--bg2);color:white;padding:14px;}
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}

  .content{
    padding:18px;
    max-width:1100px;margin:0 auto;width:100%;
  }

  h1{margin:0 0 6px;font-size:1.4rem;}
  .sub{color:#64748b;font-size:.9rem;margin-bottom:12px;}

  .card{
    background:white;border:1px solid var(--border);
    border-radius:12px;padding:16px;margin-bottom:18px;
  }
  .card h2{margin:0 0 12px;font-size:1.07rem;}

  label{font-size:.82rem;color:#475569;font-weight:600;}
  input,select,textarea{
    width:100%;padding:8px 10px;margin-top:4px;
    border:1px solid var(--border);
    border-radius:8px;background:white;
    font-size:.9rem;
  }
  textarea{min-height:100px;}

  .grid-2{
    display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:14px 20px;
  }

  .toolbar{
    display:flex;justify-content:flex-end;gap:10px;
    margin-bottom:18px;
  }

  .btn{
    padding:8px 14px;border-radius:999px;
    border:none;cursor:pointer;
    font-size:.88rem;font-weight:500;
    display:inline-flex;align-items:center;gap:6px;
  }
  .btn-primary{background:var(--brand);color:white;}
  .btn-ghost{background:white;border:1px solid #cbd5e1;color:#0f172a;}

  /* QR PREVIEW */
  .qr-box{
    text-align:center;padding:12px 0;
  }
  .qr-box svg{
    width:170px;height:170px;
  }
</style>
</head>

<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Edit Device</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">

    <h1 id="title">New Device</h1>
    <p class="sub" id="subtitle">Fill the fields below to register the device.</p>

    <div class="toolbar">
      <button id="btnSave" class="btn btn-primary">üíæ Save</button>
      <button onclick="history.back()" class="btn btn-ghost">Back</button>
    </div>

    <!-- QR CODE LIVE PREVIEW -->
    <section class="card">
      <h2>QR Code Preview</h2>

      <div id="qrPreview" class="qr-box">
        <p style="color:#64748b;">Enter an Asset ID to generate QR‚Ä¶</p>
      </div>

      <div style="text-align:center;margin-top:10px;">
        <button id="btnDownloadQR" class="btn btn-primary" disabled>‚¨áÔ∏è Download QR</button>
        <button id="btnPrintQR" class="btn btn-ghost" disabled>üñ® Print Label</button>
      </div>
    </section>

    <!-- FORM -->
    <form id="deviceForm">

      <section class="card">
        <h2>Identification</h2>
        <div class="grid-2">
          <div>
            <label>Asset ID *</label>
            <input id="assetId" required>
          </div>

          <div>
            <label>Device Name</label>
            <input id="deviceName">
          </div>

          <div>
            <label>Asset Type *</label>
            <select id="assetType" required>
              <option value="">Choose‚Ä¶</option>
              <option>Laptop</option>
              <option>iPad</option>
              <option>Desktop</option>
              <option>Monitor</option>
              <option>Printer</option>
              <option>Network Device</option>
              <option>Phone</option>
              <option>Other</option>
            </select>
          </div>

          <div>
            <label>Manufacturer & Model</label>
            <input id="manufacturer">
          </div>

          <div>
            <label>Serial Number</label>
            <input id="serialNumber">
          </div>

          <div>
            <label>Status</label>
            <select id="status">
              <option value="in-use">In use</option>
              <option value="in-storage">In storage</option>
              <option value="loaned">Loaned</option>
              <option value="retired">Retired</option>
              <option value="repair">Under repair</option>
            </select>
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Location & Assignment</h2>
        <div class="grid-2">
          <div>
            <label>Assigned To</label>
            <input id="assignedTo">
          </div>
          <div>
            <label>Department</label>
            <input id="department">
          </div>
          <div>
            <label>Location</label>
            <input id="location">
          </div>
          <div>
            <label>Building / Floor</label>
            <input id="buildingFloor">
          </div>
        </div>
      </section>

      <section class="card">
        <h2>Network & System</h2>
        <div class="grid-2">
          <div><label>IP Address</label><input id="ipAddress"></div>
          <div><label>MAC Address</label><input id="macAddress"></div>
          <div><label>OS / Version</label><input id="osVersion"></div>
        </div>
      </section>

      <section class="card">
        <h2>Lifecycle & Procurement</h2>
        <div class="grid-2">
          <div><label>Purchase Date</label><input type="date" id="purchaseDate"></div>
          <div><label>Installation Date</label><input type="date" id="installationDate"></div>
          <div><label>Vendor</label><input id="vendor"></div>
          <div><label>Warranty End Date</label><input type="date" id="warrantyEndDate"></div>
          <div><label>Replacement Date</label><input type="date" id="replacementDate"></div>
          <div><label>Replacement Alert</label><select id="replacementAlert"><option value="false">No</option><option value="true">Yes</option></select></div>
          <div><label>Removed Date</label><input type="date" id="removedDate"></div>
        </div>
      </section>

      <section class="card">
        <h2>Notes</h2>
        <textarea id="notes" placeholder="Optional notes‚Ä¶"></textarea>
      </section>

    </form>

  </main>
</div>

<script src="sidebar.js"></script>

<!-- QR Library -->
<script type="module">
  import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.esm.js";
  import { db, watchAuth } from "./firebase.js";
  import {
    doc, getDoc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const params = new URLSearchParams(location.search);
  const itemId = params.get("id");

  const whoEl = document.getElementById("who");
  const qrPreview = document.getElementById("qrPreview");
  const btnDownloadQR = document.getElementById("btnDownloadQR");
  const btnPrintQR = document.getElementById("btnPrintQR");

  const btnSave = document.getElementById("btnSave");

  let QR_SVG = "";

  watchAuth({
    allowedRoles:["admin","it"],
    whoEl,
    onReady: async (_user, role)=>{
      if(itemId){
        document.getElementById("title").textContent = "Edit Device";
        await loadItem();
      }
    }
  });

  /* ============================
     LOAD EXISTING ITEM
  ============================ */
  async function loadItem(){
    const snap = await getDoc(doc(db,"items",itemId));
    if (!snap.exists()) return;

    const d = snap.data();

    for (const key in d){
      const field = document.getElementById(key);
      if (field){
        if (field.type === "date"){
          if (d[key]?.toDate) field.value = d[key].toDate().toISOString().slice(0,10);
        } else {
          field.value = d[key];
        }
      }
    }

    generateQR();
  }

  /* ============================
     LIVE QR GENERATION
  ============================ */
  document.getElementById("assetId").addEventListener("input", generateQR);

  async function generateQR(){
    const asset = document.getElementById("assetId").value.trim();
    if (!asset){
      qrPreview.innerHTML = `<p style="color:#64748b;">Enter an Asset ID‚Ä¶</p>`;
      btnDownloadQR.disabled = true;
      btnPrintQR.disabled = true;
      return;
    }

    // QR text based on item page
    const qrText = `${location.origin}/item.html?id=${itemId || asset}`;

    QR_SVG = await QRCode.toString(qrText,{
      type:"svg", scale:10, margin:2, errorCorrectionLevel:"H"
    });

    qrPreview.innerHTML = QR_SVG;
    btnDownloadQR.disabled = false;
    btnPrintQR.disabled = false;
  }

  /* ============================
     QR DOWNLOAD
  ============================ */
  btnDownloadQR.onclick = ()=>{
    const blob = new Blob([QR_SVG], {type:"image/svg+xml"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "QR-" + document.getElementById("assetId").value + ".svg";
    a.click();
  };

  /* ============================
     PRINT QR LABEL
  ============================ */
  btnPrintQR.onclick = ()=>{
    const w = window.open("", "_blank");
    w.document.write(`
      <html><body style="display:flex;justify-content:center;align-items:center;height:100vh;">
        ${QR_SVG}
        <script>window.print()</script>
      </body></html>
    `);
  };

  /* ============================
     SAVE DEVICE
  ============================ */
  btnSave.onclick = async ()=>{
    const data = collectFormData();

    if (!data.assetId.trim()){
      alert("Asset ID is required.");
      return;
    }

    const id = itemId || data.assetId;

    await setDoc(doc(db,"items",id),{
      ...data,
      updatedAt: serverTimestamp(),
      createdAt: itemId ? data.createdAt || serverTimestamp() : serverTimestamp()
    },{merge:true});

    alert("Device saved.");
    location.href = `item.html?id=${id}`;
  };

  function collectFormData(){
    const f = id => document.getElementById(id)?.value || "";

    return {
      assetId: f("assetId"),
      deviceName: f("deviceName"),
      assetType: f("assetType"),
      manufacturer: f("manufacturer"),
      serialNumber: f("serialNumber"),
      status: f("status"),

      assignedTo: f("assignedTo"),
      department: f("department"),
      location: f("location"),
      buildingFloor: f("buildingFloor"),

      ipAddress: f("ipAddress"),
      macAddress: f("macAddress"),
      osVersion: f("osVersion"),

      purchaseDate: f("purchaseDate") || null,
      installationDate: f("installationDate") || null,
      vendor: f("vendor"),
      warrantyEndDate: f("warrantyEndDate") || null,
      replacementDate: f("replacementDate") || null,
      replacementAlert: f("replacementAlert") === "true",
      removedDate: f("removedDate") || null,

      notes: f("notes")
    };
  }

</script>

</body>
</html>
