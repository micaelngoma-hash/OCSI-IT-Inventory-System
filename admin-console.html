<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Admin Console</title>

<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    background:var(--bg);color:white;padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .content{padding:26px;max-width:1100px;margin:0 auto;}

  h1{margin-bottom:14px;}
  h2{margin-top:34px;margin-bottom:10px;}

  .card{
    background:white;border-radius:12px;
    padding:18px;border:1px solid var(--border);
    margin-bottom:20px;
  }

  table{width:100%;border-collapse:collapse;}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left;}
  th{background:#f8fafc;}

  .btn{padding:6px 12px;background:var(--brand);color:white;border-radius:8px;text-decoration:none;border:none;cursor:pointer;}
  .btn-small{padding:4px 8px;font-size:.75rem;}

  select,input{
    padding:6px;border-radius:6px;border:1px solid var(--border);font-size:.85rem;
  }
</style>
</head>

<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> – Admin Console</div>
  <div id="who" style="opacity:.85;">Checking session…</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">

    <h1>Admin Console</h1>

    <!-- USERS -->
    <h2>User Management</h2>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Email</th>
            <th>Role</th>
            <th>Promote/Demote</th>
          </tr>
        </thead>
        <tbody id="users-body">
          <tr><td colspan="3">Loading users…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- CATEGORIES -->
    <h2>Device/Software Categories</h2>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Category Name</th>
            <th>Code</th>
            <th>Default Fields</th>
          </tr>
        </thead>
        <tbody id="cat-body">
          <tr><td colspan="3">Loading categories…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- CUSTOM FIELDS -->
    <h2>Custom Fields</h2>
    <div class="card">
      <p>You may add additional fields at any time.</p>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <input id="cf-name" placeholder="Field Name"/>
        <input id="cf-key" placeholder="Field key (machine)"/>
        <select id="cf-type">
          <option value="text">Text</option>
          <option value="number">Number</option>
          <option value="date">Date</option>
          <option value="select">Dropdown</option>
        </select>
        <button id="addField" class="btn">Add Field</button>
      </div>

      <table style="margin-top:14px;">
        <thead>
          <tr>
            <th>Name</th><th>Key</th><th>Type</th>
          </tr>
        </thead>
        <tbody id="fields-body">
          <tr><td colspan="3">Loading fields…</td></tr>
        </tbody>
      </table>
    </div>

    <!-- IMPORT -->
    <h2>Bulk Import</h2>
    <div class="card">
      <p>Import many items from Excel or CSV.</p>
      <a href="import-excel.html" class="btn">Go to Import Tool</a>
    </div>

  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
import { auth, db, watchAuth } from "./firebase.js";
import {
  getDocs, collection, updateDoc, doc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const who = document.getElementById("who");
const usersBody = document.getElementById("users-body");
const catBody   = document.getElementById("cat-body");
const fieldsBody= document.getElementById("fields-body");

const addFieldBtn = document.getElementById("addField");
const cfName = document.getElementById("cf-name");
const cfKey  = document.getElementById("cf-key");
const cfType = document.getElementById("cf-type");

watchAuth({
  allowedRoles:["admin"], 
  whoEl: who,
  onReady: loadAll
});

async function loadAll(){
  loadUsers();
  loadCategories();
  loadFields();
}

async function loadUsers(){
  const snap = await getDocs(collection(db,"users"));
  usersBody.innerHTML = "";

  snap.forEach(u=>{
    const d = u.data();
    const role = d.role || "viewer";

    usersBody.innerHTML += `
      <tr>
        <td>${d.email}</td>
        <td>${role}</td>
        <td>
          <button class="btn-small" onclick="setRole('${u.id}','viewer')">Viewer</button>
          <button class="btn-small" onclick="setRole('${u.id}','it')">IT</button>
          <button class="btn-small" onclick="setRole('${u.id}','admin')">Admin</button>
        </td>
      </tr>
    `;
  });
}

window.setRole = async function(uid, role){
  await updateDoc(doc(db,"users",uid),{ role });
  loadUsers();
};

async function loadCategories(){
  const snap = await getDocs(collection(db,"categories"));
  catBody.innerHTML = "";
  snap.forEach(c=>{
    const d = c.data();
    catBody.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.code}</td>
        <td>${(d.defaultFields||[]).length} fields</td>
      </tr>`;
  });
}

async function loadFields(){
  const snap = await getDocs(collection(db,"custom_fields"));
  fieldsBody.innerHTML = "";
  snap.forEach(f=>{
    const d = f.data();
    fieldsBody.innerHTML += `
      <tr>
        <td>${d.name}</td>
        <td>${d.key}</td>
        <td>${d.type}</td>
      </tr>`;
  });
}

addFieldBtn.onclick = async ()=>{
  const name = cfName.value.trim();
  const key  = cfKey.value.trim();
  const type = cfType.value;
  if(!name || !key) return alert("All fields required.");

  await updateDoc(doc(db,"custom_fields", key),{
    name, key, type
  });

  cfName.value = "";
  cfKey.value = "";
  loadFields();
};
</script>

</body>
</html>
