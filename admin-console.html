<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory ‚Äì Admin Console</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
    --good:#22c55e;--warn:#f97316;--bad:#ef4444;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:8px 16px;
    display:flex;justify-content:space-between;align-items:center;
    height: 54px;
  }
  .user-control { display: flex; flex-direction: column; align-items: flex-end; }
  #who { font-size: 0.85rem; font-weight: 500; opacity: 0.9; }
  .logout-link { font-size: 0.72rem; color: #94a3b8; text-decoration: none; margin-top: -2px; }

  .layout{ display:grid; grid-template-columns:240px 1fr; min-height:calc(100vh - 54px); }
  .sidebar{ background:var(--bg2);color:white;padding:14px; }
  .nav a{ display:flex;align-items:center;gap:8px; padding:9px 11px;border-radius:9px; color:#dbe4ff;text-decoration:none;margin-bottom:6px; font-size:0.92rem; }
  .nav a.active{background:#111a33;}

  .content{ padding:18px; max-width:1200px; margin:0 auto; width:100%; }
  .grid{ display:grid; grid-template-columns:1fr 350px; gap:16px; }

  .card{ background:white; border:1px solid var(--border); border-radius:14px; padding:16px; margin-bottom:12px; }
  .card h2{ margin:0 0 12px; font-size:1.1rem; }
  
  /* Form Styles */
  .form-group { margin-bottom: 12px; }
  label { display: block; font-size: 0.8rem; font-weight: 600; color: #475569; margin-bottom: 4px; }
  input, select { width: 100%; padding: 8px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9rem; }
  .btn-primary { background: var(--brand); color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: 600; }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Table Styles */
  .table-wrap{ border-radius:12px; border:1px solid var(--border); overflow:auto; }
  table{ border-collapse:collapse; width:100%; }
  th,td{ padding:10px; border-bottom:1px solid #f1f5f9; font-size:.85rem; text-align:left; }
  th{ background:#f8fafc; color:#475569; }

  .pill{ padding:2px 8px; border-radius:999px; font-size:.7rem; font-weight: 600; text-transform: uppercase; }
  .pill-admin{background:#dcfce7;color:#166534;}
  .pill-it{background:#dbeafe;color:#1d4ed8;}
  .pill-viewer{background:#f1f5f9;color:#475569;}

  .status-bar{ font-size:.8rem; margin-top:10px; padding:8px; border-radius:6px; }
  .status-ok{ background:#dcfce7; color:#166534; }
  .status-error{ background:#fee2e2; color:#b91c1c; }
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong></div>
  <div class="user-control">
    <div id="who">Checking session‚Ä¶</div>
    <a href="login.html" class="logout-link">Logout</a>
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üìä</span><span>Dashboard</span></a>
      <a href="inventory-list.html"><span class="icon">üíª</span><span>Hardware</span></a>
      <a class="active" href="admin-console.html"><span class="icon">‚öôÔ∏è</span><span>Admin Console</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1>Admin Console</h1>
    <p style="color:#64748b; margin-top:-10px; margin-bottom:20px;">Manage access and invite new team members.</p>

    <div class="grid">
      <section class="card">
        <h2>Active Users</h2>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>User / Email</th>
                <th>Role Access</th>
                <th>Permissions</th>
              </tr>
            </thead>
            <tbody id="userBody">
              <tr><td colspan="3" style="text-align:center; padding:20px;">Loading users...</td></tr>
            </tbody>
          </table>
        </div>
        <div id="adminStatus" class="status-bar"></div>
      </section>

      <section class="card">
        <h2>Add New User</h2>
        <form id="addUserForm">
          <div class="form-group">
            <label>Full Name</label>
            <input type="text" id="newName" placeholder="John Doe" required>
          </div>
          <div class="form-group">
            <label>Email Address</label>
            <input type="email" id="newEmail" placeholder="john@ocsi.org" required>
          </div>
          <div class="form-group">
            <label>Assign Role</label>
            <select id="newRole">
              <option value="viewer">Viewer (Read Only)</option>
              <option value="it">IT Staff (Editor)</option>
              <option value="admin">Admin (Full Access)</option>
            </select>
          </div>
          <button type="submit" id="submitBtn" class="btn-primary">Add & Notify User</button>
        </form>
      </section>
    </div>
  </main>
</div>

<script type="module">
  import { db, watchAuth, logAudit } from "./firebase.js";
  import { 
    collection, onSnapshot, doc, setDoc, updateDoc, query, orderBy, addDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const whoEl = document.getElementById("who");
  const userBody = document.getElementById("userBody");
  const addUserForm = document.getElementById("addUserForm");
  const adminStatus = document.getElementById("adminStatus");

  watchAuth({
    allowedRoles: ["admin"],
    whoEl,
    onReady: () => initRealtimeUsers()
  });

  // 1. Real-time User List
  function initRealtimeUsers() {
    const q = query(collection(db, "users"), orderBy("email"));
    onSnapshot(q, (snap) => {
      userBody.innerHTML = "";
      snap.forEach(ds => {
        const u = ds.data();
        const role = u.role || "viewer";
        const pillClass = `pill pill-${role}`;
        
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div style="font-weight:600;">${u.displayName || 'Pending...'}</div>
            <div style="font-size:0.75rem; color:#64748b;">${u.email}</div>
          </td>
          <td>
            <select class="role-update" data-uid="${ds.id}">
              <option value="admin" ${role==='admin'?'selected':''}>Admin</option>
              <option value="it" ${role==='it'?'selected':''}>IT Staff</option>
              <option value="viewer" ${role==='viewer'?'selected':''}>Viewer</option>
            </select>
          </td>
          <td><span class="${pillClass}">${role}</span></td>
        `;
        userBody.appendChild(tr);
      });

      document.querySelectorAll(".role-update").forEach(sel => {
        sel.addEventListener("change", handleRoleUpdate);
      });
    });
  }

  // 2. Add User & Send Notification
  addUserForm.addEventListener("submit", async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById("submitBtn");
    const name = document.getElementById("newName").value;
    const email = document.getElementById("newEmail").value.toLowerCase().trim();
    const role = document.getElementById("newRole").value;

    submitBtn.disabled = true;
    showStatus("Processing...", "");

    try {
      // Create user record (using email as ID if UID is unknown)
      const userRef = doc(db, "users", email); 
      await setDoc(userRef, {
        displayName: name,
        email: email,
        role: role,
        invitedAt: new Date()
      }, { merge: true });

      // 3. Send Notification Email (via Firestore Trigger Email Extension)
      await addDoc(collection(db, "mail"), {
        to: email,
        message: {
          subject: "Welcome to OCSI IT Inventory",
          html: `
            <h3>Hello ${name},</h3>
            <p>You have been granted <strong>${role}</strong> access to the OCSI IT Inventory System.</p>
            <p>You can now log in using your school email.</p>
            <br>
            <a href="https://your-app-url.web.app" style="background:#1a73e8; color:white; padding:10px 20px; text-decoration:none; border-radius:5px;">Access Inventory</a>
          `
        }
      });

      await logAudit("user-invited", `Invited ${email} as ${role}`);
      showStatus(`Success! ${email} has been added and notified.`, "status-ok");
      addUserForm.reset();
    } catch (err) {
      showStatus("Error: " + err.message, "status-error");
    } finally {
      submitBtn.disabled = false;
    }
  });

  async function handleRoleUpdate(e) {
    const uid = e.target.dataset.uid;
    const newRole = e.target.value;
    try {
      await updateDoc(doc(db, "users", uid), { role: newRole });
      showStatus("Role updated successfully", "status-ok");
    } catch (err) {
      showStatus("Update failed", "status-error");
    }
  }

  function showStatus(msg, cls) {
    adminStatus.textContent = msg;
    adminStatus.className = "status-bar " + cls;
  }
</script>
</body>
</html>
