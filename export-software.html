<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory ‚Äì Export Software & Licenses</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
    --good:#22c55e;--warn:#f97316;--bad:#ef4444;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }

  .layout{
    display:grid;
    grid-template-columns:240px 1fr;
    min-height:calc(100vh - 52px);
  }

  .sidebar{
    background:var(--bg2);color:white;padding:14px;
  }
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:0.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .nav .icon{width:18px;text-align:center;opacity:.8;}

  .content{
    padding:18px;
    max-width:1100px;
    margin:0 auto;
    width:100%;
  }

  h1{margin:0 0 4px;font-size:1.4rem;}
  .subtitle{margin:0 0 14px;font-size:.9rem;color:#94a3b8;}

  .badge{padding:2px 7px;border-radius:999px;font-size:.75rem;}
  .badge-admin{background:rgba(34,197,94,.12);color:#16a34a;}
  .badge-it{background:rgba(59,130,246,.12);color:#1a56db;}
  .badge-viewer{background:rgba(148,163,184,.2);color:#475569;}

  .grid{
    display:grid;
    grid-template-columns:2fr 1.2fr;
    gap:16px;
  }
  @media(max-width:960px){
    .layout{grid-template-columns:1fr;}
    .grid{grid-template-columns:1fr;}
  }

  .card{
    background:white;
    border:1px solid var(--border);
    border-radius:14px;
    padding:14px 16px;
    margin-bottom:12px;
  }
  .card h2{
    margin:0 0 8px;
    font-size:1.05rem;
    display:flex;
    justify-content:space-between;
    align-items:center;
  }
  .muted{font-size:.82rem;color:#94a3b8;margin-bottom:10px;}

  .btn{
    border:none;cursor:pointer;
    padding:7px 13px;border-radius:999px;
    font-size:.86rem;font-weight:500;
    display:inline-flex;align-items:center;gap:6px;
    text-decoration:none;
  }
  .btn-primary{background:var(--brand);color:white;}
  .btn-ghost{background:transparent;border:1px solid #cbd5e1;color:#0f172a;}

  .btn:disabled{
    opacity:.6;
    cursor:not-allowed;
  }

  .btn-row{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:8px;
  }

  .status-bar{
    font-size:.82rem;
    margin-top:4px;
    min-height:18px;
  }
  .status-ok{color:#166534;}
  .status-warn{color:#b45309;}
  .status-error{color:#b91c1c;}

  ul.hints{
    margin:6px 0 0;
    padding-left:18px;
    font-size:.82rem;
    color:#6b7280;
  }
  ul.hints li{margin-bottom:3px;}

  code{
    font-size:.82rem;
    background:#f3f4f6;
    padding:1px 4px;
    border-radius:4px;
  }
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Export Software & Licenses</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üìä</span><span>Main Dashboard</span></a>
      <a href="software-licenses.html"><span class="icon">üîë</span><span>Software Licenses</span></a>
      <a href="inventory-list.html"><span class="icon">üíª</span><span>Hardware</span></a>
      <a href="scan.html"><span class="icon">üì±</span><span>QR Scan Device</span></a>
      <a class="active" href="export-software.html"><span class="icon">‚¨áÔ∏è</span><span>Export Software</span></a>
      <a href="audits.html"><span class="icon">üïí</span><span>Audits</span></a>
      <a href="admin-console.html"><span class="icon">‚öôÔ∏è</span><span>Admin Console</span></a>
      <a href="login.html"><span class="icon">üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1>Export Software & Licenses</h1>
    <p class="subtitle">
      Download CSV snapshots of software products and license pools for compliance and audits.
    </p>

    <div class="grid">
      <!-- LEFT: main export actions -->
      <section class="card">
        <h2>Software Exports</h2>
        <p class="muted">
          Reads live data from Firestore (<code>software_product</code> and <code>software_license</code>) and generates CSV files in your browser.
        </p>

        <div class="btn-row">
          <button class="btn btn-primary" id="btnExportSoftware">üíª Export Software Products CSV</button>
          <button class="btn btn-primary" id="btnExportLicenses">üîë Export Licenses CSV</button>
        </div>

        <div id="exportStatus" class="status-bar"></div>

        <ul class="hints">
          <li>Files are generated locally in your browser ‚Äì no data is sent anywhere else.</li>
          <li>You can open CSV files directly in Excel, Google Sheets, or Numbers.</li>
          <li>For very large collections, exporting may take a few seconds.</li>
          <li>Need device export? Open <a href="export-devices.html">Devices Export</a>.</li>
        </ul>
      </section>

      <!-- RIGHT: structure info / tips -->
      <section class="card">
        <h2>Export Structure</h2>
        <p class="muted">Overview of what‚Äôs included in each CSV.</p>

        <h3 style="font-size:.9rem;margin:10px 0 4px;">Software Products (<code>software_product</code>)</h3>
        <ul class="hints">
          <li>Fields: <code>id</code>, <code>name</code>, <code>vendor</code>, <code>category</code>, <code>version</code>, <code>platform</code>, <code>notes</code>.</li>
        </ul>

        <h3 style="font-size:.9rem;margin:10px 0 4px;">Licenses (<code>software_license</code>)</h3>
        <ul class="hints">
          <li>Fields: <code>id</code>, <code>softwareName</code>, <code>licenseKey</code>, <code>totalSeats</code>, <code>assignedSeats</code>, <code>expiryDate</code>, <code>vendor</code>, <code>notes</code>.</li>
          <li>Useful for tracking overuse and approaching expiries.</li>
        </ul>
      </section>
    </div>
  </main>
</div>

<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import {
    collection, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const whoEl         = document.getElementById("who");
  const btnSoftware   = document.getElementById("btnExportSoftware");
  const btnLicenses   = document.getElementById("btnExportLicenses");
  const exportStatus  = document.getElementById("exportStatus");

  watchAuth({
    allowedRoles:["admin","it","viewer"], // adjust if needed
    whoEl,
    onReady: ()=>{
      btnSoftware.addEventListener("click", exportSoftwareProducts);
      btnLicenses.addEventListener("click", exportSoftwareLicenses);
    }
  });

  function setStatus(msg, type=""){
    exportStatus.textContent = msg;
    exportStatus.className = "status-bar" + (type ? " " + type : "");
  }

  function toDateStr(v){
    if(!v) return "";
    try{
      if(v.toDate) return v.toDate().toISOString();
      if(typeof v === "number") return new Date(v).toISOString();
      return String(v);
    }catch{
      return String(v);
    }
  }

  async function exportSoftwareProducts(){
    await runExport({
      label: "software products",
      fileName: "software_products.csv",
      collectionName: "software_product",
      mapDoc: (id,data)=>{
        return {
          id,
          name: data.name || "",
          vendor: data.vendor || "",
          category: data.category || "",
          version: data.version || "",
          platform: data.platform || "",
          notes: (data.notes || "").replace(/\s+/g," ").trim()
        };
      }
    });
  }

  async function exportSoftwareLicenses(){
    await runExport({
      label: "software licenses",
      fileName: "software_licenses.csv",
      collectionName: "software_license",
      mapDoc: (id,data)=>{
        return {
          id,
          softwareName: data.softwareName || "",
          licenseKey: data.licenseKey || "",
          totalSeats: Number(data.totalSeats || 0),
          assignedSeats: Number(data.assignedSeats || 0),
          expiryDate: toDateStr(data.expiryDate),
          vendor: data.vendor || "",
          notes: (data.notes || "").replace(/\s+/g," ").trim()
        };
      }
    });
  }

  async function runExport({label,fileName,collectionName,mapDoc}){
    try{
      setStatus(`Exporting ${label}‚Ä¶`, "status-warn");
      btnSoftware.disabled = true;
      btnLicenses.disabled = true;

      const snap = await getDocs(collection(db,collectionName));
      if(snap.empty){
        setStatus(`No ${label} found in collection "${collectionName}".`, "status-warn");
        btnSoftware.disabled = false;
        btnLicenses.disabled = false;
        return;
      }

      const rows = [];
      snap.forEach(ds=>{
        rows.push(mapDoc(ds.id, ds.data()));
      });

      const csv = toCsv(rows);
      downloadCsv(fileName,csv);

      setStatus(`Exported ${rows.length} ${label}. File: ${fileName}`, "status-ok");
    }catch(err){
      console.error(err);
      setStatus("Export failed: " + err.message, "status-error");
    }finally{
      btnSoftware.disabled = false;
      btnLicenses.disabled = false;
    }
  }

  function toCsv(rows){
    if(!rows || !rows.length) return "";
    const headers = Object.keys(rows[0]);
    const lines = [];
    lines.push(headers.join(","));
    for(const row of rows){
      const vals = headers.map(h=>{
        let v = row[h] ?? "";
        v = String(v);
        if(v.includes('"')){
          v = v.replace(/"/g,'""');
        }
        if(v.search(/[",\n]/) !== -1){
          v = `"${v}"`;
        }
        return v;
      });
      lines.push(vals.join(","));
    }
    return lines.join("\n");
  }

  function downloadCsv(filename, text){
    const blob = new Blob([text],{type:"text/csv;charset=utf-8;"});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
</script>

</body>
</html>
