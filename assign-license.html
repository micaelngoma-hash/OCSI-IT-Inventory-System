<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Assign License</title>
<style>
  :root{--bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}
  .topbar{background:var(--bg);color:white;padding:12px 16px;font-weight:700;display:flex;justify-content:space-between;}
  .wrap{max-width:900px;margin:0 auto;padding:18px;}
  .box{background:white;border:1px solid #e5e7eb;border-radius:12px;padding:14px;}
  label{display:block;margin-top:8px;font-size:.9rem;}
  select,input{width:100%;padding:8px;border:1px solid #cbd5e1;border-radius:7px;}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
  button{background:var(--brand);color:white;border:none;padding:9px 12px;border-radius:8px;cursor:pointer;margin-top:12px;}
  .muted{color:#64748b;font-size:.9rem;}
</style>
</head>
<body>

<div class="topbar">
  <div>Assign Software License</div>
  <div id="who" style="opacity:.8;">Loadingâ€¦</div>
</div>

<div class="wrap">
  <div class="box">
    <label>Select License</label>
    <select id="licSel"></select>

    <div class="row">
      <div>
        <label>Assign to Device (optional)</label>
        <select id="devSel"><option value="">-- none --</option></select>
      </div>
      <div>
        <label>Assign to User (optional)</label>
        <select id="usrSel"><option value="">-- none --</option></select>
      </div>
    </div>

    <label>Assignment Date</label>
    <input id="dateInp" type="date"/>

    <button id="assignBtn">Assign Seat</button>
    <div id="msg" class="muted"></div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, getDoc, increment, serverTimestamp }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };
  const app=initializeApp(firebaseConfig);
  const db=getFirestore(app);
  const auth=getAuth(app);

  const ALLOWED_ROLES=["admin","it"]; // REQUIRED

  const who=document.getElementById("who");
  const licSel=document.getElementById("licSel");
  const devSel=document.getElementById("devSel");
  const usrSel=document.getElementById("usrSel");
  const msg=document.getElementById("msg");

  const presetLic=new URLSearchParams(location.search).get("licenseId");

  onAuthStateChanged(auth, async user=>{
    if(!user){ location.href="login.html"; return; }
    const uSnap=await getDoc(doc(db,"users",user.uid));
    const role=uSnap.exists()? (uSnap.data().role||"viewer"):"viewer";
    if(!ALLOWED_ROLES.includes(role)){ alert("Admin/IT only."); location.href="software-dashboard.html"; return;}
    who.textContent=user.email+" ("+role+")";
    await loadAll();
  });

  async function loadAll(){
    // licenses
    const licSnap=await getDocs(collection(db,"software_license"));
    licSel.innerHTML="";
    licSnap.forEach(d=>{
      const l=d.data();
      const o=document.createElement("option");
      o.value=d.id; o.textContent=(l.softwareName||d.id)+" ("+(l.assignedSeats||0)+"/"+(l.totalSeats||0)+")";
      licSel.appendChild(o);
    });
    if(presetLic) licSel.value=presetLic;

    // devices
    const itemSnap=await getDocs(collection(db,"items"));
    devSel.innerHTML='<option value="">-- none --</option>';
    itemSnap.forEach(d=>{
      const it=d.data();
      const o=document.createElement("option");
      o.value=d.id; o.textContent=(it.assetId||d.id)+" - "+(it.deviceName||it.name||"");
      devSel.appendChild(o);
    });

    // users
    const userSnap=await getDocs(collection(db,"users"));
    usrSel.innerHTML='<option value="">-- none --</option>';
    userSnap.forEach(d=>{
      const u=d.data();
      const o=document.createElement("option");
      o.value=d.id; o.textContent=(u.name||u.email||d.id);
      usrSel.appendChild(o);
    });
  }

  document.getElementById("assignBtn").addEventListener("click", async ()=>{
    msg.textContent="";
    const licenseId=licSel.value;
    const deviceId=devSel.value;
    const userId=usrSel.value;
    if(!licenseId){ msg.textContent="Choose a license."; return; }
    if(!deviceId && !userId){ msg.textContent="Assign to device OR user."; return; }

    const assignmentDate = document.getElementById("dateInp").value
      ? new Date(document.getElementById("dateInp").value)
      : new Date();

    await addDoc(collection(db,"software_assignment"),{
      softwareLicenseId: licenseId,
      deviceId: deviceId||null,
      userId: userId||null,
      assignmentDate,
      createdAt: serverTimestamp()
    });

    await updateDoc(doc(db,"software_license",licenseId),{
      assignedSeats: increment(1)
    });

    msg.textContent="Assigned successfully.";
    location.href="software-license.html?id="+licenseId;
  });
</script>
</body>
</html>
