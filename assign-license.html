<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Assign License Seats</title>

<style>
  :root{ --bg:#0f172a; --bg2:#0b1020; --brand:#1a73e8; --border:#e5e7eb; }
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    background:var(--bg);color:white;padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .sidebar{background:var(--bg2);padding:14px;color:white;}

  .content{padding:26px;max-width:900px;margin:0 auto;width:100%;}

  table{width:100%;border-collapse:collapse;background:white;border-radius:10px;overflow:hidden;}
  th,td{padding:10px;border-bottom:1px solid #f1f5f9;font-size:.88rem;}
  th{background:#f8fafc;text-align:left;}
  .btn{padding:6px 12px;background:var(--brand);color:white;border-radius:8px;text-decoration:none;cursor:pointer;font-size:.85rem;}
  .btn-red{background:#dc2626;}
</style>

</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> – Assign License</div>
  <div id="who" style="opacity:.8;font-size:.85rem;">Checking session…</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">
    <h1 id="title">Assign License</h1>
    <p id="subtitle">Loading…</p>

    <h2>Assigned Devices</h2>

    <table>
      <thead>
        <tr>
          <th>Device</th>
          <th>Serial</th>
          <th>Location</th>
          <th>Revoke</th>
        </tr>
      </thead>
      <tbody id="assigned-body">
        <tr><td colspan="4">Loading…</td></tr>
      </tbody>
    </table>

    <h2 style="margin-top:30px;">Assign New Device</h2>

    <button id="assignBtn" class="btn">Assign to Device</button>

  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import {
    doc, getDoc, updateDoc, collection, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const who       = document.getElementById("who");
  const title     = document.getElementById("title");
  const subtitle  = document.getElementById("subtitle");
  const assignedBody = document.getElementById("assigned-body");
  const assignBtn = document.getElementById("assignBtn");

  const params = new URLSearchParams(location.search);
  const licenseId = params.get("license");

  let licenseData = null;

  watchAuth({
    allowedRoles:["admin","it"],
    whoEl: who,
    onReady: loadLicense
  });

  async function loadLicense(){
    if(!licenseId){
      subtitle.textContent = "Missing license ID.";
      return;
    }

    const snap = await getDoc(doc(db,"software_license",licenseId));
    if(!snap.exists()){
      subtitle.textContent = "License not found.";
      return;
    }

    licenseData = snap.data();

    title.textContent = "Assign License — " + (licenseData.licenseKey || "No Key");
    subtitle.textContent = `Seats: ${licenseData.assignedSeats}/${licenseData.totalSeats}`;

    renderAssigned();
  }

  async function renderAssigned(){
    const devices = await getDocs(collection(db,"items"));

    const assigned = (licenseData.assignedTo || []);

    if(assigned.length === 0){
      assignedBody.innerHTML = `<tr><td colspan="4">No devices assigned.</td></tr>`;
      return;
    }

    assignedBody.innerHTML = "";

    for(const devId of assigned){
      const dSnap = await getDoc(doc(db,"items",devId));
      if(!dSnap.exists()) continue;
      const d = dSnap.data();

      assignedBody.innerHTML += `
        <tr>
          <td>${d.deviceName||"(no name)"}</td>
          <td>${d.serialNumber||"—"}</td>
          <td>${d.location||"—"}</td>
          <td><button class="btn-red" onclick="revoke('${devId}')">Revoke</button></td>
        </tr>`;
    }
  }

  window.revoke = async function(id){
    const arr = (licenseData.assignedTo || []).filter(x=>x!==id);

    await updateDoc(doc(db,"software_license",licenseId),{
      assignedTo: arr,
      assignedSeats: arr.length
    });

    licenseData.assignedTo = arr;
    licenseData.assignedSeats = arr.length;

    subtitle.textContent = `Seats: ${arr.length}/${licenseData.totalSeats}`;
    renderAssigned();
  };

  assignBtn.onclick = ()=>{
    location.href = `assign-device-select.html?license=${licenseId}`;
  };

</script>

</body>
</html>
