<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Software License Form • OCSI IT Inventory</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="topbar">
  <div>
    <div class="topbar-title">Software License</div>
    <div class="topbar-sub">Create or update a license pool</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <span id="roleBadge" class="badge viewer">…</span>
    <span id="who" style="opacity:.85;">Loading…</span>
    <button id="logoutBtn" class="logout">Logout</button>
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html">Dashboard</a>
      <a href="inventory-list.html">Inventory</a>
      <a class="active" href="software-dashboard.html">Software</a>
      <a href="admin-fields.html">Admin Fields</a>
      <a href="admin-categories.html">Admin Categories</a>
      <a href="admin-users.html">User Roles</a>
    </nav>
  </aside>

  <main class="content">
    <div class="card">
      <h3 id="formTitle">New Software License</h3>
      <p class="muted" id="formSubtitle">
        Link this license pool to an existing software product and define seats, expiry and vendor.
      </p>

      <form id="form">
        <label>Software Product</label>
        <select id="softwareProduct">
          <option value="">Loading products…</option>
        </select>

        <label>License Key (optional)</label>
        <input id="licenseKey" placeholder="Key, subscription ID, account ID…">

        <label>Total Seats</label>
        <input id="totalSeats" type="number" min="0" value="0">

        <label>Assigned Seats (usually auto-managed)</label>
        <input id="assignedSeats" type="number" min="0" value="0">

        <label>Purchase Date</label>
        <input id="purchaseDate" type="date">

        <label>Expiry Date</label>
        <input id="expiryDate" type="date">

        <label>Vendor</label>
        <input id="vendor" placeholder="e.g. Microsoft, Adobe, Distributor">

        <label>Cost (total)</label>
        <input id="cost" type="number" step="0.01" min="0" placeholder="e.g. 1200">

        <div class="spacer"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button type="submit" class="btn" id="saveBtn">Save</button>
          <a href="software-licenses.html" class="btn secondary">Back to Licenses</a>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, getDocs, serverTimestamp, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };

  const app=initializeApp(firebaseConfig);
  try{getAnalytics(app);}catch(e){}
  const auth=getAuth(app);
  const db=getFirestore(app);

  const ALLOWED_ROLES=["admin","it"];

  function setBadge(role){
    const badge=document.getElementById("roleBadge");
    if(!badge) return;
    const r=(role||"viewer").toLowerCase();
    badge.className="badge "+r;
    badge.textContent=r.toUpperCase();
  }

  document.getElementById("logoutBtn").addEventListener("click",()=>{
    signOut(auth).then(()=>location.href="login.html");
  });

  function getId(){
    const p=new URLSearchParams(location.search);
    return p.get("id");
  }
  const id=getId();

  const productSelect=document.getElementById("softwareProduct");
  const form=document.getElementById("form");
  const statusEl=document.getElementById("status");
  const saveBtn=document.getElementById("saveBtn");
  const formTitle=document.getElementById("formTitle");
  const formSub=document.getElementById("formSubtitle");

  let productsMap={};

  async function loadProducts(){
    const snap=await getDocs(collection(db,"software_product"));
    if(snap.empty){
      productSelect.innerHTML='<option value="">No products. Create one first.</option>';
      return;
    }
    const opts=[];
    snap.forEach(d=>{
      const data=d.data();
      const name=data.softwareName || data.name || d.id;
      productsMap[d.id]=name;
      opts.push(`<option value="${d.id}">${name}</option>`);
    });
    productSelect.innerHTML='<option value="">Select product…</option>'+opts.join("");
  }

  async function loadIfEditing(){
    if(!id) return;
    formTitle.textContent="Edit Software License";
    formSub.textContent="Update license details. Assigned seats may be managed automatically by assignments.";

    const ref=doc(db,"software_license",id);
    const snap=await getDoc(ref);
    if(!snap.exists()){
      statusEl.textContent="License not found.";
      return;
    }
    const l=snap.data();
    if(l.softwareProductId){
      productSelect.value=l.softwareProductId;
    }
    document.getElementById("licenseKey").value   = l.licenseKey || "";
    document.getElementById("totalSeats").value   = l.totalSeats || 0;
    document.getElementById("assignedSeats").value= l.assignedSeats || 0;
    document.getElementById("vendor").value       = l.vendor || "";
    document.getElementById("cost").value         = l.cost || "";

    if(l.purchaseDate && l.purchaseDate.toDate){
      document.getElementById("purchaseDate").value = l.purchaseDate.toDate().toISOString().slice(0,10);
    }
    if(l.expiryDate && l.expiryDate.toDate){
      document.getElementById("expiryDate").value   = l.expiryDate.toDate().toISOString().slice(0,10);
    }
  }

  onAuthStateChanged(auth, async (u)=>{
    if(!u){location.href="login.html";return;}
    const who=document.getElementById("who");
    if(who) who.textContent=u.email||"";

    const us=await getDoc(doc(db,"users",u.uid));
    const role=us.exists()? (us.data().role||"viewer"):"viewer";
    setBadge(role);
    if(!ALLOWED_ROLES.includes(role)){
      alert("Only Admin or IT may manage licenses.");
      location.href="software-licenses.html";
      return;
    }

    await loadProducts();
    await loadIfEditing();
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    statusEl.textContent="";
    saveBtn.disabled=true;
    saveBtn.textContent="Saving…";

    try{
      const productId=document.getElementById("softwareProduct").value||"";
      const name = productId ? productsMap[productId] : "";
      const totalSeats=parseInt(document.getElementById("totalSeats").value||"0",10) || 0;
      const assignedSeats=parseInt(document.getElementById("assignedSeats").value||"0",10) || 0;
      const purchase=document.getElementById("purchaseDate").value;
      const expiry  =document.getElementById("expiryDate").value;

      const data={
        softwareProductId: productId,
        softwareName: name,
        licenseKey: document.getElementById("licenseKey").value.trim(),
        totalSeats,
        assignedSeats,
        vendor: document.getElementById("vendor").value.trim(),
        cost: parseFloat(document.getElementById("cost").value||"0")||0,
        updatedAt: serverTimestamp()
      };
      if(purchase){
        data.purchaseDate = Timestamp.fromDate(new Date(purchase));
      }
      if(expiry){
        data.expiryDate = Timestamp.fromDate(new Date(expiry));
      }

      if(!productId){
        statusEl.textContent="Software Product is required.";
        saveBtn.disabled=false;
        saveBtn.textContent="Save";
        return;
      }

      if(!id){
        const newRef=doc(collection(db,"software_license"));
        data.createdAt=serverTimestamp();
        await setDoc(newRef,data);
      }else{
        await updateDoc(doc(db,"software_license",id),data);
      }
      statusEl.textContent="Saved.";
      setTimeout(()=>location.href="software-licenses.html",800);
    }catch(err){
      statusEl.textContent="Error: "+err.message;
    }finally{
      saveBtn.disabled=false;
      saveBtn.textContent="Save";
    }
  });
</script>
</body>
</html>
