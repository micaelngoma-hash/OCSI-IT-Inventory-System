<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Import Data</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}
  .topbar{
    background:var(--bg);color:white;
    padding:12px 16px;display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .content{padding:22px;max-width:1000px;margin:0 auto;}

  h1{margin:0 0 6px;font-size:1.4rem;}
  .subtitle{color:#64748b;font-size:.9rem;margin-bottom:16px;}

  .card{
    background:white;border-radius:12px;
    padding:16px;border:1px solid var(--border);
    margin-bottom:20px;
  }
  .label{font-size:.86rem;font-weight:600;margin-bottom:4px;}
  .hint{font-size:.8rem;color:#6b7280;margin-bottom:8px;}
  input[type="file"]{margin-top:8px;}

  .btn{
    border:none;cursor:pointer;
    padding:7px 13px;border-radius:999px;
    font-size:.85rem;font-weight:500;
    display:inline-flex;align-items:center;gap:6px;
    background:var(--brand);color:white;margin-top:10px;
  }
  .btn[disabled]{opacity:.5;cursor:not-allowed;}

  table{width:100%;border-collapse:collapse;margin-top:10px;font-size:.83rem;}
  th,td{padding:6px 8px;border-bottom:1px solid #f1f5f9;text-align:left;}
  th{background:#f8fafc;}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;font-size:.75rem;}
  .pill-ok{background:#dcfce7;color:#166534;}
  .pill-warn{background:#ffedd5;color:#c2410c;}
  .log{font-family:monospace;font-size:.78rem;background:#0b1020;color:#e5e7eb;
       padding:8px;border-radius:8px;max-height:220px;overflow:auto;margin-top:10px;}
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Import Data</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">
    <h1>Bulk Import from CSV</h1>
    <p class="subtitle">
      Upload a CSV exported from your IT inventory spreadsheet and push records into Firestore.
    </p>

    <section class="card">
      <div class="label">1. Prepare your CSV</div>
      <p class="hint">
        Export your Excel as <strong>CSV (UTF-8)</strong>. Recommended headers:
        <code>assetId,deviceName,assetType,status,assignedTo,department,location,buildingFloor,ipAddress,macAddress,purchaseDate,warrantyEndDate,replacementDate,replacementAlert,notes</code>
      </p>
      <div class="label">2. Upload file</div>
      <input type="file" id="fileInput" accept=".csv"/>
      <button id="parseBtn" class="btn" type="button">üìÇ Load Preview</button>
      <p id="fileInfo" class="hint"></p>
    </section>

    <section class="card" id="previewCard" style="display:none;">
      <div class="label">Preview (first 10 rows)</div>
      <p class="hint">
        Only known columns are imported. Unknown columns are ignored.
        You can safely test with a small file first.
      </p>
      <table>
        <thead id="previewHead"></thead>
        <tbody id="previewBody"></tbody>
      </table>
      <p class="hint" id="rowCount"></p>
      <button id="importBtn" class="btn" type="button">‚¨ÜÔ∏è Import into Firestore</button>
    </section>

    <section class="card">
      <div class="label">Import Log</div>
      <div id="log" class="log">Waiting‚Ä¶</div>
    </section>

  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
import { db, watchAuth } from "./firebase.js";
import {
  collection, addDoc, serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const whoEl       = document.getElementById("who");
const fileInput   = document.getElementById("fileInput");
const parseBtn    = document.getElementById("parseBtn");
const previewCard = document.getElementById("previewCard");
const previewHead = document.getElementById("previewHead");
const previewBody = document.getElementById("previewBody");
const rowCountEl  = document.getElementById("rowCount");
const importBtn   = document.getElementById("importBtn");
const logEl       = document.getElementById("log");
const fileInfo    = document.getElementById("fileInfo");

let parsedRows = [];
let headers = [];

watchAuth({
  allowedRoles:["admin","it"],
  whoEl,
  onReady: ()=>{}
});

function log(msg){
  const time = new Date().toISOString().slice(11,19);
  logEl.textContent += `\n[${time}] ${msg}`;
  logEl.scrollTop = logEl.scrollHeight;
}

parseBtn.onclick = ()=>{
  const file = fileInput.files?.[0];
  if(!file){ alert("Please select a CSV file first.");return; }
  fileInfo.textContent = `Selected: ${file.name} (${Math.round(file.size/1024)} KB)`;
  const reader = new FileReader();
  reader.onload = e=>{
    const text = e.target.result;
    parseCsv(text);
  };
  reader.readAsText(file);
};

function parseCsv(text){
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length>0);
  if(lines.length<2){
    alert("CSV seems empty or missing rows.");
    return;
  }
  headers = lines[0].split(",").map(h=>h.trim());
  parsedRows = lines.slice(1).map(line=>{
    const cols = line.split(",");
    const obj = {};
    headers.forEach((h,i)=>{ obj[h] = (cols[i]||"").trim(); });
    return obj;
  });

  // build preview (first 10 rows)
  previewHead.innerHTML = "<tr>"+headers.map(h=>`<th>${escapeHtml(h)}</th>`).join("")+"</tr>";
  const first10 = parsedRows.slice(0,10);
  previewBody.innerHTML = first10.map(row=>{
    return "<tr>"+headers.map(h=>`<td>${escapeHtml(row[h]||"")}</td>`).join("")+"</tr>";
  }).join("");

  rowCountEl.textContent = `Rows detected: ${parsedRows.length}. Only the first 10 shown above.`;
  previewCard.style.display = "block";
  log("CSV parsed successfully.");
}

function mapRowToItem(row){
  // You can extend this mapping as needed
  return {
    assetId: row.assetId || row.AssetID || "",
    deviceName: row.deviceName || row.DeviceName || "",
    assetType: row.assetType || row.Type || "",
    status: row.status || "in-use",
    assignedTo: row.assignedTo || "",
    department: row.department || "",
    location: row.location || "",
    buildingFloor: row.buildingFloor || "",
    ipAddress: row.ipAddress || "",
    macAddress: row.macAddress || "",
    purchaseDate: row.purchaseDate || "",
    installationDate: row.installationDate || "",
    vendor: row.vendor || "",
    warrantyEndDate: row.warrantyEndDate || "",
    replacementDate: row.replacementDate || "",
    replacementAlert: (row.replacementAlert||"").toLowerCase()==="yes",
    removedDate: row.removedDate || "",
    notes: row.notes || "",
    createdAt: serverTimestamp()
  };
}

importBtn.onclick = async ()=>{
  if(!parsedRows.length){
    alert("No rows parsed yet.");
    return;
  }
  importBtn.disabled = true;
  log("Starting import into Firestore‚Ä¶");

  let success = 0, fail = 0;
  for(const row of parsedRows){
    const docData = mapRowToItem(row);
    try{
      await addDoc(collection(db,"items"), docData);
      success++;
    }catch(e){
      fail++;
      log("Error: "+(e.message||e));
    }
  }
  log(`Import finished. Success: ${success}, Failed: ${fail}`);
  importBtn.disabled = false;
};

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,c=>(
    { "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]
  ));
}

</script>
</body>
</html>
