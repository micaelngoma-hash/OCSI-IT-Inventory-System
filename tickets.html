<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Service Request â€“ Tickets</title>
  <style>
    :root{ --red1:#c53030; --red2:#f56565; --brand:#1a73e8; --border:#e5e7eb; }
    *{box-sizing:border-box;}
    body{ margin:0; font-family:system-ui; background:#f7fafc; color:#1a202c; }

    /* Login Modal Styles */
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    .login-card { background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; }
    .login-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin: 15px 0; }
    
    .hero{ background:linear-gradient(90deg,var(--red1),var(--red2)); color:white; padding:12px 26px; display:flex; align-items:center; justify-content:space-between; }
    .hero-title{ font-size:1.5rem; font-weight:600; }
    .hero-right{ display:flex; align-items:center; gap:14px; }
    .btn-primary{ border:none; border-radius:8px; padding:8px 16px; font-size:.9rem; font-weight:600; background:#0b7285; color:white; cursor:pointer; display:flex; align-items:center; gap:5px; }
    
    .wrap{ display:flex; justify-content:center; padding:20px 16px; }
    .card{ background:white; border-radius:12px; border:1px solid var(--border); max-width:1100px; width:100%; padding:18px; box-shadow:0 1px 3px rgba(0,0,0,0.1); }
    
    table{ width:100%; border-collapse:collapse; font-size:.86rem; margin-bottom: 20px;}
    th,td{ padding:12px; border-bottom:1px solid #f1f5f9; text-align:left; }
    th{ background:#f8fafc; color:#4b5563; text-transform: uppercase; font-size: 0.75rem;}
    tbody tr { cursor: pointer; }
    tbody tr:hover { background: #f8fafc; }

    .pill{ padding:2px 8px; border-radius:4px; font-size:.7rem; font-weight: bold; text-transform: uppercase; }
    .pill-open{background:#ebf8ff; color:#2b6cb0;}
    .pill-progress{background:#fffaf0; color:#dd6b20;}

    /* Detail / Edit View */
    .edit-section { margin-top: 30px; border-top: 1px solid var(--border); padding-top: 20px; }
    .row { display: flex; gap: 20px; margin-bottom: 15px; }
    .col { flex: 1; }
    label { display: block; font-size: 0.85rem; font-weight: bold; margin-bottom: 5px; }
    input, select, textarea { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-family: inherit; }
    
    /* Conversation Styles */
    .conversation-box { background: #f8fafc; border: 1px solid var(--border); border-radius: 6px; padding: 10px; max-height: 200px; overflow-y: auto; margin-bottom: 10px; }
    .comment { padding: 8px; border-bottom: 1px solid #edf2f7; font-size: 0.9rem; }
    .comment:last-child { border: none; }
    .comment b { display: block; font-size: 0.75rem; color: #4a5568; }
    
    .hidden { display: none !important; }
    .btn-save { background: #1a73e8; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 8px;}
    .btn-reply { background: white; border: 1px solid var(--border); padding: 8px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px;}
  </style>
</head>
<body>

  <div id="loginOverlay" class="hidden">
    <div class="login-card">
      <h2>OCSI Login</h2>
      <input type="email" id="loginEmail" class="login-input" placeholder="email@ocsi.org">
      <button id="sendLinkBtn" class="btn-primary" style="width:100%; justify-content: center;">Send Magic Link</button>
    </div>
  </div>

  <header class="hero">
    <div class="hero-title">OCSI Service Request</div>
    <div class="hero-right">
      <button id="submitBtn" class="btn-primary"><span>+</span> Submit a ticket</button>
      <div id="who" class="hero-email">...</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <table>
        <thead>
          <tr><th>#</th><th>Summary</th><th>Group</th><th>Status</th><th>Created</th></tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>

      <div id="editView" class="edit-section hidden">
        <div class="row">
          <div class="col">
            <label>Status</label>
            <select id="detStatus">
              <option value="Open">Open</option>
              <option value="In progress">In progress</option>
              <option value="Resolved">Resolved</option>
              <option value="Closed">Closed</option>
            </select>
          </div>
          <div class="col">
            <label>Priority</label>
            <select id="detPriority">
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div class="detail-field" style="margin-bottom:15px;">
          <label>Subject</label>
          <input type="text" id="detSummary">
        </div>

        <label>Conversation</label>
        <div id="conversation" class="conversation-box"></div>

        <textarea id="replyText" placeholder="Add reply..." rows="3" style="margin-bottom:10px;"></textarea>

        <div style="display:flex; gap:10px;">
          <button id="updateTicketBtn" class="btn-save">ðŸ’¾ Save Status</button>
          <button id="replyBtn" class="btn-reply">ðŸ’¬ Post Reply</button>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db, watchAuth } from "./firebase.js";
    import { isSignInWithEmailLink, signInWithEmailLink, sendSignInLinkToEmail } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { collection, getDocs, query, where, orderBy, doc, getDoc, setDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const tbody = document.getElementById("tbody");
    const editView = document.getElementById("editView");
    let currentUser = null;
    let selectedTicketId = null;

    // Load tickets and add IDs for the table (1, 2, 3...)
    async function loadTickets(user, role) {
      const q = (role === 'admin' || role === 'it') 
        ? query(collection(db, "tickets"), orderBy("createdAt", "desc"))
        : query(collection(db, "tickets"), where("requesterUid", "==", user.uid), orderBy("createdAt", "desc"));

      const snap = await getDocs(q);
      tbody.innerHTML = "";
      snap.docs.forEach((d, index) => {
        const t = d.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${snap.docs.length - index}</td>
          <td>${t.summary}</td>
          <td>${t.group || 'IT'}</td>
          <td><span class="pill ${t.status === 'In progress' ? 'pill-progress' : 'pill-open'}">${t.status || 'OPEN'}</span></td>
          <td>${t.createdAt ? new Date(t.createdAt.seconds*1000).toLocaleDateString() : ''}</td>
        `;
        tr.onclick = () => openEditView(d.id, t);
        tbody.appendChild(tr);
      });
    }

    function openEditView(id, data) {
      selectedTicketId = id;
      editView.classList.remove("hidden");
      document.getElementById("detSummary").value = data.summary;
      document.getElementById("detStatus").value = data.status || "Open";
      document.getElementById("detPriority").value = data.priority || "Medium";
      
      const conv = document.getElementById("conversation");
      conv.innerHTML = (data.comments || []).map(c => `
        <div class="comment">
          <b>${c.user}</b>
          ${c.text}
        </div>
      `).join('');
      conv.scrollTop = conv.scrollHeight;
    }

    // Save Status & Priority
    document.getElementById("updateTicketBtn").onclick = async () => {
      try {
        await updateDoc(doc(db, "tickets", selectedTicketId), {
          status: document.getElementById("detStatus").value,
          priority: document.getElementById("detPriority").value,
          summary: document.getElementById("detSummary").value,
          updatedAt: serverTimestamp()
        });
        alert("Changes saved!");
        loadTickets(currentUser, currentUser.role);
      } catch (err) { alert(err.message); }
    };

    // Post a Reply
    document.getElementById("replyBtn").onclick = async () => {
      const text = document.getElementById("replyText").value.trim();
      if(!text) return;
      try {
        await updateDoc(doc(db, "tickets", selectedTicketId), {
          comments: arrayUnion({
            user: currentUser.email,
            text: text,
            date: new Date().toISOString()
          })
        });
        document.getElementById("replyText").value = "";
        const snap = await getDoc(doc(db, "tickets", selectedTicketId));
        openEditView(selectedTicketId, snap.data());
      } catch (err) { alert(err.message); }
    };

    // --- Standard Init Logic ---
    watchAuth({
      allowedRoles: ["admin", "it", "staff"],
      whoEl: document.getElementById("who"),
      onReady: async (user, role) => {
        if (!user) { document.getElementById("loginOverlay").classList.remove("hidden"); return; }
        currentUser = user;
        currentUser.role = role;
        loadTickets(user, role);
      }
    });

    document.getElementById("submitBtn").onclick = () => window.location.href = "submit-request.html";
  </script>
</body>
</html>
