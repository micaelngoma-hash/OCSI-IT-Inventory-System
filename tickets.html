<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Service Request ‚Äì Tickets</title>
  <style>
    :root{ --red1:#c53030; --red2:#f56565; --brand:#1a73e8; --border:#e5e7eb; }
    *{box-sizing:border-box;}
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,sans-serif; background:#f7fafc; color:#1a202c; }

    /* --- LOGIN OVERLAY --- */
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.98); display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    .login-card { background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center; box-shadow: 0 20px 25px rgba(0,0,0,0.1); }
    .login-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 8px; margin: 15px 0; font-size: 1rem; }
    
    /* --- HERO & HEADER --- */
    .hero{ background:linear-gradient(90deg,var(--red1),var(--red2)); color:white; padding:18px 26px; display:flex; align-items:center; justify-content:space-between; }
    .hero-title{ font-size:1.6rem; font-weight:600; }
    .hero-right{ display:flex; align-items:center; gap:14px; }
    .btn-primary{ border:none; border-radius:999px; padding:8px 16px; font-size:.9rem; font-weight:600; background:#0b7285; color:white; cursor:pointer; }
    .btn-logout { background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 12px; border-radius: 999px; cursor: pointer; font-size: 0.8rem; }

    .wrap{ display:flex; flex-direction: column; align-items:center; padding:34px 16px; gap: 20px; }
    .card{ background:white; border-radius:12px; border:1px solid var(--border); max-width:950px; width:100%; padding:20px; box-shadow:0 10px 30px rgba(15,23,42,.06); }
    
    /* --- TOOLBAR & TABLE --- */
    .toolbar{ display:flex; gap:12px; margin-bottom:15px; }
    .search-box{ flex:1; display:flex; align-items:center; gap:8px; border-radius:999px; border:1px solid var(--border); padding:6px 14px; background: white; }
    .search-box input{ border:none; outline:none; width:100%; font-size:.9rem; background: transparent; }
    
    .table-wrap{ border-radius:10px; border:1px solid var(--border); overflow:auto; background: white; }
    table{ width:100%; border-collapse:collapse; font-size:.88rem; }
    th,td{ padding:12px; border-bottom:1px solid #f1f5f9; text-align:left; }
    th{ background:#f8fafc; color:#4b5563; font-weight: 600; text-transform: uppercase; font-size: 0.75rem; }
    tbody tr{ cursor: pointer; transition: background 0.2s; }
    tbody tr:hover { background: #f9fafb; }

    /* --- DETAIL VIEW --- */
    .detail-view { margin-top: 20px; padding: 20px; border: 1px solid var(--border); background: #fcfcfc; border-radius: 12px; }
    .detail-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 15px; }
    .detail-col label { display: block; font-size: 0.75rem; font-weight: bold; color: #718096; text-transform: uppercase; margin-bottom: 5px; }
    .detail-input { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; }
    
    .conv-box { background: white; border: 1px solid var(--border); border-radius: 8px; padding: 12px; height: 200px; overflow-y: auto; margin: 10px 0; }
    .comment { padding: 8px 0; border-bottom: 1px solid #edf2f7; font-size: 0.85rem; }
    .comment b { color: var(--brand); font-size: 0.75rem; display: block; }

    .pill { padding: 2px 10px; border-radius: 999px; font-size: .75rem; font-weight: bold; text-transform: uppercase; }
    .pill-open { background: #ebf8ff; color: #2b6cb0; }
    .pill-closed { background: #f7fafc; color: #4a5568; }
    
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loginOverlay" class="hidden">
    <div class="login-card">
      <h2 style="margin:0 0 10px">OCSI Service Portal</h2>
      <p id="loginMsg" style="color:#718096; font-size:0.9rem">Enter your school email to sign in via magic link.</p>
      <input type="email" id="loginEmail" class="login-input" placeholder="user@ocsi.org">
      <button id="sendLinkBtn" class="btn-primary" style="width:100%">Send Sign-In Link</button>
    </div>
  </div>

  <header class="hero">
    <div class="hero-left">
      <div class="hero-title">OCSI Service Request</div>
    </div>
    <div class="hero-right">
      <button id="submitBtn" class="btn-primary">+ Submit Ticket</button>
      <div id="who" class="hero-email">...</div>
      <button id="logoutBtn" class="btn-logout">Logout</button>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div id="viewHint" style="font-size: 0.8rem; color: #718096; margin-bottom: 12px; padding: 8px; background: #f8fafc; border-radius: 6px;">
        Loading your tickets...
      </div>
      
      <div class="toolbar">
        <select id="statusFilter" class="detail-input" style="width: auto;">
          <option value="open">Open Tickets</option>
          <option value="closed">Closed Tickets</option>
          <option value="">All Tickets</option>
        </select>
        <div class="search-box">
          <span>üîç</span>
          <input id="search" placeholder="Search subject or group..." />
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>ID</th><th>Summary</th><th>Group</th><th>Status</th><th>Updated</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="ticketDetail" class="detail-view hidden">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
          <h3 style="margin:0">Ticket Update</h3>
          <button onclick="document.getElementById('ticketDetail').classList.add('hidden')" style="background:none; border:none; cursor:pointer; font-size:1.2rem;">‚úï</button>
        </div>
        
        <div class="detail-grid">
          <div class="detail-col">
            <label>Status</label>
            <select id="detStatus" class="detail-input">
              <option value="open">Open</option>
              <option value="in progress">In Progress</option>
              <option value="resolved">Resolved</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div class="detail-col">
            <label>Priority</label>
            <select id="detPriority" class="detail-input">
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Urgent">Urgent</option>
            </select>
          </div>
        </div>

        <div class="detail-col" style="margin-bottom:15px;">
          <label>Subject</label>
          <input type="text" id="detSummary" class="detail-input">
        </div>
        
        <label style="font-size:0.75rem; font-weight:bold; color:#718096; text-transform:uppercase;">Conversation</label>
        <div id="convBox" class="conv-box"></div>
        
        <textarea id="replyText" class="detail-input" placeholder="Type your message here..." rows="3"></textarea>
        
        <div style="margin-top:15px; display:flex; gap:10px;">
          <button id="saveUpdateBtn" class="btn-primary">üíæ Save Status</button>
          <button id="postReplyBtn" style="background:#4a5568;" class="btn-primary">üí¨ Post Reply</button>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db, watchAuth } from "./firebase.js";
    import { isSignInWithEmailLink, signInWithEmailLink, sendSignInLinkToEmail, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { collection, getDocs, query, where, orderBy, doc, getDoc, updateDoc, arrayUnion, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const overlay = document.getElementById("loginOverlay");
    const tbody = document.getElementById("tbody");
    const detailView = document.getElementById("ticketDetail");
    const searchInput = document.getElementById("search");
    const statusFilter = document.getElementById("statusFilter");
    
    let currentUser = null;
    let selectedId = null;
    let allLoadedTickets = [];

    // --- 1. AUTH LOGIC ---
    if (isSignInWithEmailLink(auth, window.location.href)) {
      let email = window.localStorage.getItem('emailForSignIn') || window.prompt('Confirm your email:');
      signInWithEmailLink(auth, email, window.location.href).then(() => window.localStorage.removeItem('emailForSignIn'));
    }

    document.getElementById("sendLinkBtn").onclick = async () => {
      const email = document.getElementById("loginEmail").value.trim();
      if(!email) return alert("Enter email");
      await sendSignInLinkToEmail(auth, email, { url: window.location.href, handleCodeInApp: true });
      window.localStorage.setItem('emailForSignIn', email);
      document.getElementById("loginMsg").innerHTML = "<b style='color:green'>Link Sent!</b> Check your inbox.";
    };

    document.getElementById("logoutBtn").onclick = () => signOut(auth).then(() => location.reload());

    // --- 2. TICKET LOADING ---
    async function loadTickets(user, role) {
      const isAgent = (role === 'admin' || role === 'it');
      const q = isAgent 
        ? query(collection(db, "tickets"), orderBy("createdAt", "desc"))
        : query(collection(db, "tickets"), where("requesterUid", "==", user.uid), orderBy("createdAt", "desc"));

      const snap = await getDocs(q);
      allLoadedTickets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      
      document.getElementById("viewHint").innerText = isAgent ? "Admin: Viewing all system tickets" : "Staff: Viewing your tickets";
      renderTable();
    }

    function renderTable() {
      const term = searchInput.value.toLowerCase();
      const statusVal = statusFilter.value;

      const filtered = allLoadedTickets.filter(t => {
        const matchesSearch = t.summary.toLowerCase().includes(term);
        const st = (t.status || 'open').toLowerCase();
        const matchesStatus = statusVal === "" || (statusVal === 'open' ? st !== 'closed' : st === 'closed');
        return matchesSearch && matchesStatus;
      });

      tbody.innerHTML = filtered.map(t => `
        <tr onclick="openTicket('${t.id}')">
          <td>${t.id.slice(-4)}</td>
          <td><b>${t.summary}</b></td>
          <td>${t.group || 'IT'}</td>
          <td><span class="pill ${t.status==='closed'?'pill-closed':'pill-open'}">${t.status||'open'}</span></td>
          <td>${t.updatedAt ? new Date(t.updatedAt.seconds*1000).toLocaleDateString() : 'New'}</td>
        </tr>
      `).join('');
    }

    window.openTicket = async (id) => {
      selectedId = id;
      const t = allLoadedTickets.find(x => x.id === id);
      detailView.classList.remove("hidden");
      document.getElementById("detSummary").value = t.summary;
      document.getElementById("detStatus").value = t.status || "open";
      document.getElementById("detPriority").value = t.priority || "Medium";
      
      const isAgent = (currentUser.role === 'admin' || currentUser.role === 'it');
      document.getElementById("detStatus").disabled = !isAgent;
      document.getElementById("detPriority").disabled = !isAgent;
      document.getElementById("saveUpdateBtn").style.display = isAgent ? "block" : "none";

      renderComments(t.comments || []);
      detailView.scrollIntoView({ behavior: 'smooth' });
    };

    function renderComments(comments) {
      const box = document.getElementById("convBox");
      box.innerHTML = comments.map(c => `
        <div class="comment"><b>${c.user}</b> ${c.text}</div>
      `).join('');
      box.scrollTop = box.scrollHeight;
    }

    // --- 3. ACTIONS ---
    document.getElementById("postReplyBtn").onclick = async () => {
      const text = document.getElementById("replyText").value.trim();
      if(!text || !selectedId) return;
      await updateDoc(doc(db, "tickets", selectedId), {
        comments: arrayUnion({ user: currentUser.email, text, date: new Date().toISOString() }),
        updatedAt: serverTimestamp()
      });
      document.getElementById("replyText").value = "";
      location.reload();
    };

    document.getElementById("saveUpdateBtn").onclick = async () => {
      await updateDoc(doc(db, "tickets", selectedId), {
        status: document.getElementById("detStatus").value,
        priority: document.getElementById("detPriority").value,
        summary: document.getElementById("detSummary").value,
        updatedAt: serverTimestamp()
      });
      alert("Status Updated");
      location.reload();
    };

    searchInput.oninput = renderTable;
    statusFilter.onchange = renderTable;

    // --- 4. START ---
    watchAuth({
      allowedRoles: ["admin", "it", "staff"],
      whoEl: document.getElementById("who"),
      onReady: (user, role) => {
        if (!user) overlay.classList.remove("hidden");
        else {
          overlay.classList.add("hidden");
          currentUser = { ...user, role };
          loadTickets(user, role);
        }
      }
    });

    document.getElementById("submitBtn").onclick = () => window.location.href = "submit-request.html";
  </script>
</body>
</html>
