<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Service Request – Tickets</title>
  <style>
    :root{ --red1:#c53030; --red2:#f56565; --brand:#1a73e8; --border:#e5e7eb; }
    *{box-sizing:border-box;}
    body{ margin:0; font-family:system-ui; background:#f7fafc; color:#1a202c; }

    /* Login Modal Styles */
    #loginOverlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(15, 23, 42, 0.95); display: flex; align-items: center; justify-content: center; z-index: 10000;
    }
    .login-card {
      background: white; padding: 30px; border-radius: 12px; max-width: 400px; width: 90%; text-align: center;
    }
    .login-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 8px; margin: 15px 0; }
    
    .hero{ background:linear-gradient(90deg,var(--red1),var(--red2)); color:white; padding:18px 26px; display:flex; align-items:center; justify-content:space-between; }
    .hero-left{ display:flex; align-items:center; gap:22px; }
    .hero-title{ font-size:1.8rem; font-weight:600; }
    .hero-right{ display:flex; align-items:center; gap:14px; }
    .hero-email{ font-size:.85rem; opacity:.9; }
    .btn-primary{ border:none; border-radius:999px; padding:8px 16px; font-size:.9rem; font-weight:600; background:#0b7285; color:white; cursor:pointer; }
    .wrap{ display:flex; justify-content:center; padding:34px 16px; }
    .card{ background:white; border-radius:12px; border:1px solid var(--border); max-width:900px; width:100%; padding:18px; box-shadow:0 10px 30px rgba(15,23,42,.06); }
    .table-wrap{ border-radius:10px; border:1px solid var(--border); overflow:auto; margin-top: 15px; }
    table{ width:100%; border-collapse:collapse; font-size:.86rem; }
    th,td{ padding:10px; border-bottom:1px solid #f1f5f9; text-align:left; }
    th{ background:#f8fafc; color:#4b5563; }
    .pill{ padding:2px 8px; border-radius:999px; font-size:.75rem; }
    .pill-open{background:#ebf8ff;color:#2b6cb0;}
    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="loginOverlay" class="hidden">
    <div class="login-card">
      <h2 style="margin-top:0">OCSI Login</h2>
      <p id="loginMsg" style="font-size:0.9rem; color:#4a5568;">Enter your school email to receive a secure login link.</p>
      <input type="email" id="loginEmail" class="login-input" placeholder="email@ocsi.org">
      <button id="sendLinkBtn" class="btn-primary" style="width:100%">Send Magic Link</button>
    </div>
  </div>

  <header class="hero">
    <div class="hero-left">
      <div class="hero-title">OCSI Service Request</div>
    </div>
    <div class="hero-right">
      <button id="submitBtn" class="btn-primary">+ Submit a ticket</button>
      <div id="who" class="hero-email">Checking session…</div>
    </div>
  </header>

  <main class="wrap">
    <section class="card">
      <div id="viewHint" style="font-size:0.85rem; margin-bottom:10px; color:#718096;">Loading your tickets...</div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>ID</th><th>Summary</th><th>Group</th><th>Status</th><th>Updated</th></tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <script type="module">
    import { auth, db, watchAuth } from "./firebase.js";
    import { 
      isSignInWithEmailLink, signInWithEmailLink, sendSignInLinkToEmail 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { 
      collection, getDocs, query, where, orderBy, doc, getDoc, setDoc, serverTimestamp 
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const overlay = document.getElementById("loginOverlay");
    const loginEmail = document.getElementById("loginEmail");
    const sendLinkBtn = document.getElementById("sendLinkBtn");
    const loginMsg = document.getElementById("loginMsg");
    const tbody = document.getElementById("tbody");
    const whoEl = document.getElementById("who");

    let currentUser = null;
    let currentRole = "staff";

    // --- MAGIC LINK HANDLER ---
    async function handleAuthTransition() {
      if (isSignInWithEmailLink(auth, window.location.href)) {
        let email = window.localStorage.getItem('emailForSignIn');
        if (!email) email = window.prompt('Please confirm your email for sign-in:');
        
        try {
          const result = await signInWithEmailLink(auth, email, window.location.href);
          window.localStorage.removeItem('emailForSignIn');
          
          // ACTIVATION NOTIFICATION
          const userRef = doc(db, "users", result.user.uid);
          const userSnap = await getDoc(userRef);
          if (!userSnap.exists()) {
            await setDoc(userRef, { email: result.user.email, role: "staff", activatedAt: serverTimestamp() });
            alert("✅ Account Activated! You can now access your tickets.");
          }
        } catch (err) { alert("Error: " + err.message); }
      }
    }

    // --- SEND EMAIL LINK ---
    sendLinkBtn.onclick = async () => {
      const email = loginEmail.value.trim();
      if(!email) return alert("Email required");
      try {
        await sendSignInLinkToEmail(auth, email, { url: window.location.href, handleCodeInApp: true });
        window.localStorage.setItem('emailForSignIn', email);
        loginMsg.innerHTML = "<b>Check your email!</b> A link has been sent.";
      } catch (err) { alert(err.message); }
    };

    // --- LOAD TICKETS ---
    async function loadTickets(user, role) {
      const q = (role === 'admin' || role === 'it') 
        ? query(collection(db, "tickets"), orderBy("createdAt", "desc"))
        : query(collection(db, "tickets"), where("requesterUid", "==", user.uid), orderBy("createdAt", "desc"));

      const snap = await getDocs(q);
      tbody.innerHTML = snap.docs.map(d => {
        const t = d.data();
        return `<tr>
          <td>${d.id.slice(-4)}</td>
          <td>${t.summary}</td>
          <td>${t.group || 'IT'}</td>
          <td><span class="pill pill-open">${t.status || 'open'}</span></td>
          <td>${t.createdAt ? new Date(t.createdAt.seconds*1000).toLocaleDateString() : ''}</td>
        </tr>`;
      }).join('');
      document.getElementById("viewHint").innerText = role === 'admin' ? "Admin View: All Tickets" : "Personal View: My Tickets";
    }

    // --- INIT ---
    handleAuthTransition();
    watchAuth({
      allowedRoles: ["admin", "it", "viewer", "staff"],
      whoEl,
      onReady: async (user, role) => {
        if (!user) { overlay.classList.remove("hidden"); return; }
        overlay.classList.add("hidden");
        currentUser = user;
        currentRole = role;
        await loadTickets(user, role);
      }
    });

    document.getElementById("submitBtn").onclick = () => window.location.href = "submit-request.html";
  </script>
</body>
</html>
