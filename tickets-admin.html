<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Admin â€“ Command Center</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{
      --red1:#c53030; --red2:#f56565; --brand:#1a73e8;
      --border:#e2e8f0; --bg:#f8fafc; --success: #10b981; --danger: #ef4444;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family: 'Inter', -apple-system, sans-serif; background: var(--bg); color:#1e293b; overflow-x: hidden; }

    /* HEADER */
    .hero{ position:sticky; top:0; z-index:1000; background:linear-gradient(135deg, var(--red1), var(--red2)); color:white; padding:12px 24px; display:flex; align-items:center; justify-content:space-between; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
    .hero-title{ font-size:1.1rem; font-weight:800; letter-spacing: -0.025em; }

    /* LAYOUT */
    .main-container { display: grid; grid-template-columns: 1fr 340px; gap: 24px; padding: 24px; max-width: 1600px; margin: 0 auto; transition: margin-right 0.3s ease; }
    @media(max-width: 1100px) { .main-container { grid-template-columns: 1fr; } }

    /* TICKETS & ANALYTICS */
    .card-shell{ background:white; border-radius:16px; border:1px solid var(--border); padding:24px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.05); }
    .analytics-sidebar { position: sticky; top: 80px; height: calc(100vh - 100px); display: flex; flex-direction: column; gap: 16px; }
    .mini-card { background: white; padding: 16px; border-radius: 16px; border: 1px solid var(--border); box-shadow: 0 1px 3px rgba(0,0,0,0.05); }

    /* TABLE */
    .table-wrap{ border-radius:12px; border:1px solid var(--border); overflow:auto; max-height:600px; background: white; }
    table{ width:100%; border-collapse:collapse; font-size:0.875rem; }
    th{ background:#f8fafc; padding:12px 16px; text-align:left; font-weight:600; color:#64748b; position:sticky; top:0; z-index:10; }
    td{ padding:14px 16px; border-top:1px solid #f1f5f9; }
    tr:hover td{ background:#f8fafc; cursor: pointer; }

    /* EDIT DRAWER */
    #editDrawer {
      position: fixed; top: 0; right: -450px; width: 450px; height: 100%;
      background: white; box-shadow: -5px 0 15px rgba(0,0,0,0.1);
      z-index: 2000; transition: right 0.3s ease; padding: 30px;
      overflow-y: auto;
    }
    #editDrawer.open { right: 0; }
    .drawer-overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.3); z-index: 1500; display: none;
    }
    .drawer-overlay.active { display: block; }

    /* FORM UI */
    .field-group { margin-bottom: 20px; }
    .sidebar-label { font-size: 0.65rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 8px; display: block; }
    .input-ui { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border); font-size: 0.9rem; }
    
    .pill{ padding:4px 10px; border-radius:8px; font-size:0.7rem; font-weight:700; text-transform: uppercase; }
    .pill-open{ background:#dcfce7; color:#166534; }
    .pill-closed{ background:#f1f5f9; color:#475569; }
    .pill-in-progress{ background:#fef9c3; color:#854d0e; }

    .btn{ border:none; cursor:pointer; padding:10px 20px; border-radius:10px; font-size:0.875rem; font-weight:600; }
    .btn-primary{ background:var(--brand); color:white; width: 100%; }
    .chart-box { height: 100px; }
  </style>
</head>
<body>

<header class="hero">
  <div class="hero-title">OCSI COMMAND CENTER</div>
  <div id="who" style="font-size: 0.8rem;">Session checking...</div>
</header>

<div id="overlay" class="drawer-overlay"></div>

<div id="editDrawer">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
    <h2 style="margin:0; font-size:1.2rem;">Ticket Details</h2>
    <button onclick="closeDrawer()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
  </div>
  
  <div class="field-group">
    <span class="sidebar-label">Summary</span>
    <p id="drawSummary" style="font-weight:600; margin:0;"></p>
  </div>

  <div class="field-group">
    <span class="sidebar-label">Status</span>
    <select id="drawStatus" class="input-ui">
      <option value="open">Open</option>
      <option value="in-progress">In Progress</option>
      <option value="closed">Closed</option>
    </select>
  </div>

  <div class="field-group">
    <span class="sidebar-label">Priority</span>
    <select id="drawPriority" class="input-ui">
      <option value="low">Low</option>
      <option value="medium">Medium</option>
      <option value="high">High</option>
    </select>
  </div>

  <div class="field-group">
    <span class="sidebar-label">Assignee Name</span>
    <input type="text" id="drawAssignee" class="input-ui" placeholder="Name or Email">
  </div>

  <div class="field-group">
    <span class="sidebar-label">Description</span>
    <p id="drawDesc" style="font-size:0.85rem; color:#475569; background:#f8fafc; padding:12px; border-radius:8px;"></p>
  </div>

  <button id="updateTicketBtn" class="btn btn-primary">Update Ticket</button>
  <p id="drawStatusMsg" style="font-size:0.75rem; text-align:center; margin-top:10px;"></p>
</div>

<main class="main-container">
  <section class="card-shell">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
      <h1 style="font-size: 1.4rem; margin:0;">Service Requests</h1>
      <div style="display:flex; gap:10px;">
        <button id="logoutBtn" class="btn" style="background:#f1f5f9; font-size:0.75rem;">Log out</button>
      </div>
    </div>

    <div style="display:flex; gap:12px; margin-bottom:20px; flex-wrap:wrap;">
      <input id="search" placeholder="ðŸ” Search summary..." style="padding:10px; border-radius:10px; border:1px solid var(--border); flex:1; min-width:200px;">
      <select id="groupFilter" style="padding:10px; border-radius:10px; border:1px solid var(--border);">
        <option value="">All Groups</option>
        <option value="IT">IT</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Front Office">Front Office</option>
        <option value="Nurse">Nurse</option>
      </select>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Ticket</th>
            <th>Group</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Assignee</th>
          </tr>
        </thead>
        <tbody id="ticketsBody"></tbody>
      </table>
    </div>
  </section>

  <aside class="analytics-sidebar">
    <div class="mini-card">
      <span class="sidebar-label">Team Speed (MTTR)</span>
      <div class="chart-box"><canvas id="efficiencyChart"></canvas></div>
      <div id="statMTTR" style="text-align:center; font-weight:800; font-size:1.2rem; margin-top:5px;">0d</div>
    </div>
    <div class="mini-card"><span class="sidebar-label">Priority Ratio</span><div class="chart-box"><canvas id="priorityChart"></canvas></div></div>
    <div class="mini-card"><span class="sidebar-label">Workload Split</span><div class="chart-box"><canvas id="groupChart"></canvas></div></div>
  </aside>
</main>

<script type="module">
import { db, watchAuth } from "./firebase.js";
import { collection, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

let allTickets = [];
let charts = {};
let selectedId = null;

watchAuth({
  allowedRoles: ["admin", "it"],
  onReady: async (user, role) => {
    document.getElementById("who").textContent = user.email;
    await loadTickets();
  }
});

async function loadTickets() {
  const snap = await getDocs(collection(db, "tickets"));
  allTickets = snap.docs.map(ds => ({ id: ds.id, ...ds.data() }));
  allTickets.sort((a, b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
  render();
}

function render() {
  const term = document.getElementById("search").value.toLowerCase();
  const gfilt = document.getElementById("groupFilter").value;

  const filtered = allTickets.filter(t => {
    return (!gfilt || t.group === gfilt) && (!term || (t.summary || "").toLowerCase().includes(term));
  });

  const gCounts = { IT: 0, Maintenance: 0, "Front Office": 0, Nurse: 0 };
  const pCounts = { High: 0, Medium: 0, Low: 0 };
  let mttrSum = 0, closed = 0;

  filtered.forEach(t => {
    if(gCounts.hasOwnProperty(t.group)) gCounts[t.group]++;
    const p = (t.priority || "medium").charAt(0).toUpperCase() + (t.priority || "medium").slice(1);
    if(pCounts.hasOwnProperty(p)) pCounts[p]++;
    if(t.status === "closed" && t.createdAt && t.updatedAt) {
      closed++; mttrSum += (t.updatedAt.toDate() - t.createdAt.toDate()) / (1000*60*60*24);
    }
  });

  const avg = closed ? (mttrSum/closed) : 0;
  document.getElementById("statMTTR").textContent = avg.toFixed(1) + "d";

  document.getElementById("ticketsBody").innerHTML = filtered.map(t => `
    <tr onclick="openDrawer('${t.id}')">
      <td><div style="font-weight:600;">${t.summary || 'Untitled'}</div></td>
      <td>${t.group}</td>
      <td>${t.priority || 'medium'}</td>
      <td><span class="pill pill-${t.status || 'open'}">${t.status || 'open'}</span></td>
      <td>${t.assigneeName || '--'}</td>
    </tr>`).join("");

  updateCharts(gCounts, pCounts, avg);
}

window.openDrawer = (id) => {
  selectedId = id;
  const t = allTickets.find(x => x.id === id);
  document.getElementById("drawSummary").textContent = t.summary;
  document.getElementById("drawDesc").textContent = t.description || "No description provided.";
  document.getElementById("drawStatus").value = t.status || "open";
  document.getElementById("drawPriority").value = t.priority || "medium";
  document.getElementById("drawAssignee").value = t.assigneeName || "";
  document.getElementById("editDrawer").classList.add("open");
  document.getElementById("overlay").classList.add("active");
};

window.closeDrawer = () => {
  document.getElementById("editDrawer").classList.remove("open");
  document.getElementById("overlay").classList.remove("active");
  document.getElementById("drawStatusMsg").textContent = "";
};

document.getElementById("updateTicketBtn").onclick = async () => {
  const btn = document.getElementById("updateTicketBtn");
  btn.disabled = true;
  document.getElementById("drawStatusMsg").textContent = "Updating...";

  try {
    await updateDoc(doc(db, "tickets", selectedId), {
      status: document.getElementById("drawStatus").value,
      priority: document.getElementById("drawPriority").value,
      assigneeName: document.getElementById("drawAssignee").value,
      updatedAt: serverTimestamp()
    });
    document.getElementById("drawStatusMsg").textContent = "âœ… Updated successfully!";
    await loadTickets();
    setTimeout(closeDrawer, 1000);
  } catch (e) {
    document.getElementById("drawStatusMsg").textContent = "Error: " + e.message;
  } finally {
    btn.disabled = false;
  }
};

function updateCharts(groups, priorities, mttr) {
  Object.values(charts).forEach(c => c.destroy());
  const opt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };

  charts.g = new Chart(document.getElementById('groupChart'), { type: 'bar', data: { labels: Object.keys(groups), datasets: [{ data: Object.values(groups), backgroundColor: '#3b82f6' }] }, options: opt });
  charts.p = new Chart(document.getElementById('priorityChart'), { type: 'doughnut', data: { labels: Object.keys(priorities), datasets: [{ data: Object.values(priorities), backgroundColor: ['#ef4444', '#f59e0b', '#10b981'] }] }, options: { ...opt, cutout: '70%' } });
  charts.e = new Chart(document.getElementById('efficiencyChart'), { type: 'doughnut', data: { datasets: [{ data: [100 - (mttr*10), mttr*10], backgroundColor: ['#10b981', '#f1f5f9'] }] }, options: { ...opt, circumference: 180, rotation: 270, cutout: '80%' } });
}

document.getElementById("search").oninput = render;
document.getElementById("groupFilter").onchange = render;
document.getElementById("overlay").onclick = closeDrawer;
document.getElementById("logoutBtn").onclick = () => window.location.href="login.html";
</script>
</body>
</html>
