<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Admin ‚Äì Analytics Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    :root{
      --red1:#c53030;
      --red2:#f56565;
      --brand:#1a73e8;
      --border:#e5e7eb;
      --chip-bg:#edf2f7;
      --chip-text:#2d3748;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,sans-serif;
      background:#f7fafc;
      color:#1a202c;
    }

    /* HEADER */
    .hero{
      position:sticky;
      top:0;
      z-index:2000;
      background:linear-gradient(90deg,var(--red1),var(--red2));
      color:white;
      padding:18px 26px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }

    .hero-left, .hero-right{ display:flex; align-items:center; gap:20px; }
    .hero-title{ font-size:1.8rem; font-weight:600; }
    .hero-menu a{ color:white; text-decoration:none; opacity:.95; }
    .btn-hero-small{ border:none; border-radius:999px; padding:6px 14px; background:rgba(255,255,255,.16); color:white; cursor:pointer; }

    /* LAYOUT */
    .wrap{ display:flex; justify-content:center; padding:34px 16px; }
    .card-shell{ background:white; border-radius:12px; border:1px solid var(--border); max-width:1100px; width:100%; padding:25px; box-shadow:0 10px 30px rgba(15,23,42,.06); }

    /* ANALYTICS SECTION */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }
    .stat-card {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      text-align: center;
    }
    .stat-value { display: block; font-size: 1.8rem; font-weight: 700; color: var(--brand); }
    .stat-label { font-size: 0.75rem; color: #64748b; text-transform: uppercase; font-weight: 600; }
    .stat-open { color: #2b6cb0; }
    .stat-progress { color: #b7791f; }
    .stat-closed { color: #2c7a7b; }

    .charts-container { display: flex; gap: 20px; margin-bottom: 25px; flex-wrap: wrap; }
    .chart-wrapper { flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: 10px; border: 1px solid var(--border); height: 250px; }

    /* TABLES & TOOLBAR */
    .toolbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:10px; flex-wrap:wrap; }
    .search-box{ display:flex; align-items:center; gap:6px; border:1px solid var(--border); border-radius:999px; padding:4px 10px; width:100%; max-width:320px; }
    .search-box input{ border:none; outline:none; width:100%; }
    
    .table-wrap{ border-radius:10px; border:1px solid var(--border); overflow-y:auto; max-height:400px; }
    table{ width:100%; border-collapse:collapse; font-size:.85rem; }
    th, td{ padding:10px; border-bottom:1px solid #f1f5f9; text-align:left; }
    th{ background:#f8fafc; position:sticky; top:0; z-index:10; }
    tr:hover td{ background:#f9fafb; cursor: pointer; }

    .pill{ padding:2px 8px; border-radius:999px; font-size:.75rem; }
    .pill-open{ background:#ebf8ff; color:#2b6cb0; }
    .pill-closed{ background:#e6fffa; color:#2c7a7b; }
    .pill-progress{ background:#fff3cd; color:#b7791f; }

    /* EDITING & COMMENTS */
    .ticket-edit{ border-radius:8px; border:1px solid #e5e7eb; padding:15px; background:#fdfefe; margin-bottom:10px; }
    .hidden{ display:none; }
    .field-label{ font-size:.8rem; font-weight:600; margin: 10px 0 3px; }
    .field-input, .field-select, .field-textarea{ width:100%; padding:8px; border-radius:8px; border:1px solid #cbd5e1; }
    .comment-list{ max-height:200px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:10px; background:#f9fafb; }
    
    .btn{ border:none; cursor:pointer; padding:8px 16px; border-radius:999px; font-size:.85rem; font-weight:500; }
    .btn-primary{ background:var(--brand); color:white; }

    @media(max-width: 600px) { .charts-container { flex-direction: column; } }
  </style>
</head>
<body>

<header class="hero">
  <div class="hero-left">
    <div class="hero-title">OCSI Service Request</div>
    <nav class="hero-menu"><a href="tickets.html">Requester view</a></nav>
  </div>
  <div class="hero-right">
    <div id="who" class="hero-user-inline">Checking session‚Ä¶</div>
    <button id="logoutBtn" class="btn-hero-small">Log out</button>
  </div>
</header>

<main class="wrap">
  <section class="card-shell" id="reportContent">

    <h1>Admin Analytics Dashboard</h1>
    <p style="color:#64748b; margin-bottom: 20px;">Performance metrics and ticket distribution for the current period.</p>

    <div class="stats-grid">
      <div class="stat-card">
        <span id="statTotal" class="stat-value">0</span>
        <span class="stat-label">Total</span>
      </div>
      <div class="stat-card">
        <span id="statOpen" class="stat-value stat-open">0</span>
        <span class="stat-label">Open</span>
      </div>
      <div class="stat-card">
        <span id="statProgress" class="stat-value stat-progress">0</span>
        <span class="stat-label">In Progress</span>
      </div>
      <div class="stat-card">
        <span id="statClosed" class="stat-value stat-closed">0</span>
        <span class="stat-label">Closed</span>
      </div>
      <div class="stat-card">
        <span id="statMTTR" class="stat-value" style="color: #6b46c1;">0d</span>
        <span class="stat-label">Avg. Resolution</span>
      </div>
    </div>

    <div class="charts-container">
      <div class="chart-wrapper"><canvas id="groupChart"></canvas></div>
      <div class="chart-wrapper"><canvas id="priorityChart"></canvas></div>
      <div class="chart-wrapper"><canvas id="trendChart"></canvas></div>
    </div>

    <div class="toolbar">
      <div class="search-box">
        <span>üîç</span>
        <input id="search" placeholder="Search tickets..."/>
      </div>
      <div class="filters">
        <select id="groupFilter">
          <option value="">All groups</option>
          <option value="IT">IT</option>
          <option value="Maintenance">Maintenance</option>
          <option value="Front Office">Front Office</option>
          <option value="Nurse">Nurse</option>
        </select>
        <button id="downloadReportBtn" class="btn" style="background:#4a5568; color:white;">üì• Export PDF</button>
        <button id="newTicketBtn" class="btn btn-primary">‚ûï New ticket</button>
      </div>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Summary</th>
            <th>Group</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Assignee</th>
            <th>Created</th>
          </tr>
        </thead>
        <tbody id="ticketsBody"></tbody>
      </table>
    </div>

    <hr style="margin: 40px 0; border: 0; border-top: 1px solid #eee;">

    <section id="detailsSection">
      <h2>Ticket Details & Replies</h2>
      <div id="detailsPlaceholder" style="color:#94a3b8; padding: 20px; border: 2px dashed #e2e8f0; border-radius: 10px; text-align: center;">
        Select a ticket from the list above to view details.
      </div>

      <div id="ticketEditBlock" class="ticket-edit hidden">
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px;">
          <div>
            <div class="field-label">Status</div>
            <select id="statusInput" class="field-select">
              <option value="open">Open</option>
              <option value="in-progress">In progress</option>
              <option value="closed">Closed</option>
            </select>
          </div>
          <div>
            <div class="field-label">Priority</div>
            <select id="priorityInput" class="field-select">
              <option value="low">Low</option>
              <option value="medium">Medium</option>
              <option value="high">High</option>
            </select>
          </div>
          <div>
            <div class="field-label">Assignee</div>
            <input id="assigneeInput" class="field-input" placeholder="Name"/>
          </div>
        </div>

        <div class="field-label">Description</div>
        <textarea id="descriptionInput" class="field-textarea" readonly></textarea>

        <button id="saveTicketBtn" class="btn btn-primary" style="margin-top:15px;">üíæ Save Changes</button>
        
        <div class="field-label" style="margin-top:20px;">Conversation</div>
        <div id="commentsList" class="comment-list"></div>
        <textarea id="replyInput" class="field-textarea" style="margin-top:10px;" placeholder="Write a reply..."></textarea>
        <button id="addReplyBtn" class="btn" style="margin-top:5px; background:#e2e8f0;">üí¨ Add Reply</button>
      </div>
    </section>

  </section>
</main>

<script type="module">
import { db, watchAuth } from "./firebase.js";
import { collection, doc, addDoc, getDocs, updateDoc, serverTimestamp, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* STATE & CHARTS */
let allTickets = [];
let selectedTicketId = null;
let groupChart = null, priorityChart = null, trendChart = null;

const ticketsBody = document.getElementById("ticketsBody");
const searchEl = document.getElementById("search");
const groupFilterEl = document.getElementById("groupFilter");

/* AUTH */
watchAuth({
  allowedRoles:["admin","it"],
  onReady: async (user, role) => {
    document.getElementById("who").textContent = user.email;
    await loadTickets();
  }
});

/* LOAD DATA */
async function loadTickets(){
  const snap = await getDocs(collection(db, "tickets"));
  allTickets = snap.docs.map(ds => ({ id: ds.id, ...ds.data() }));
  allTickets.sort((a,b) => (b.createdAt?.toMillis() || 0) - (a.createdAt?.toMillis() || 0));
  renderTickets();
}

/* RENDER & ANALYTICS */
function renderTickets(){
  const term = searchEl.value.toLowerCase();
  const gfilt = groupFilterEl.value;

  const filtered = allTickets.filter(t => {
    const matchGroup = !gfilt || t.group === gfilt;
    const matchSearch = !term || [t.summary, t.description, t.requesterEmail].join(" ").toLowerCase().includes(term);
    return matchGroup && matchSearch;
  });

  // Calculate Stats
  const stats = { total: filtered.length, open: 0, progress: 0, closed: 0, mttrTotal: 0 };
  const groupCounts = { IT:0, Maintenance:0, "Front Office":0, Nurse:0 };
  const priorityCounts = { High:0, Medium:0, Low:0 };
  
  // Trend Logic (Last 7 Days)
  const last7Days = [...Array(7)].map((_, i) => {
    const d = new Date(); d.setDate(d.getDate() - i);
    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
  }).reverse();
  const trendData = {}; last7Days.forEach(day => trendData[day] = 0);

  filtered.forEach(t => {
    if(t.status === "open" || !t.status) stats.open++;
    else if(t.status === "in-progress") stats.progress++;
    else if(t.status === "closed") {
      stats.closed++;
      if(t.createdAt && t.updatedAt) {
        const diff = (t.updatedAt.toDate() - t.createdAt.toDate()) / (1000*60*60*24);
        stats.mttrTotal += Math.max(0, diff);
      }
    }
    
    if(groupCounts[t.group] !== undefined) groupCounts[t.group]++;
    const p = (t.priority || "medium").charAt(0).toUpperCase() + (t.priority || "medium").slice(1);
    if(priorityCounts[p] !== undefined) priorityCounts[p]++;

    if(t.createdAt) {
      const dStr = t.createdAt.toDate().toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
      if(trendData[dStr] !== undefined) trendData[dStr]++;
    }
  });

  // Update UI
  document.getElementById("statTotal").textContent = stats.total;
  document.getElementById("statOpen").textContent = stats.open;
  document.getElementById("statProgress").textContent = stats.progress;
  document.getElementById("statClosed").textContent = stats.closed;
  document.getElementById("statMTTR").textContent = (stats.closed ? (stats.mttrTotal / stats.closed).toFixed(1) : 0) + "d";

  updateCharts(groupCounts, priorityCounts, trendData, last7Days);

  ticketsBody.innerHTML = filtered.map((t, i) => `
    <tr onclick="window.selectTicketById('${t.id}')">
      <td>${i+1}</td>
      <td>${t.summary || 'No Summary'}</td>
      <td>${t.group}</td>
      <td>${t.priority || 'medium'}</td>
      <td><span class="pill pill-${t.status || 'open'}">${t.status || 'open'}</span></td>
      <td>${t.assigneeName || 'Unassigned'}</td>
      <td>${t.createdAt ? t.createdAt.toDate().toLocaleDateString() : ''}</td>
    </tr>
  `).join("");
}

/* CHARTING */
function updateCharts(groups, priorities, trend, days) {
  if(groupChart) groupChart.destroy();
  if(priorityChart) priorityChart.destroy();
  if(trendChart) trendChart.destroy();

  groupChart = new Chart(document.getElementById('groupChart'), {
    type: 'bar',
    data: { labels: Object.keys(groups), datasets: [{ label: 'Tickets', data: Object.values(groups), backgroundColor: '#1a73e8' }] },
    options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'By Department' }, legend: {display: false} } }
  });

  priorityChart = new Chart(document.getElementById('priorityChart'), {
    type: 'doughnut',
    data: { labels: Object.keys(priorities), datasets: [{ data: Object.values(priorities), backgroundColor: ['#f56565', '#ed8936', '#48bb78'] }] },
    options: { maintainAspectRatio: false, plugins: { title: { display: true, text: 'Priority Split' } } }
  });

  trendChart = new Chart(document.getElementById('trendChart'), {
    type: 'line',
    data: { labels: days, datasets: [{ label: 'New Tickets', data: days.map(d => trend[d]), borderColor: '#c53030', tension: 0.3, fill: true, backgroundColor: 'rgba(197, 48, 48, 0.1)' }] },
    options: { maintainAspectRatio: false, plugins: { title: { display: true, text: '7-Day Volume' } } }
  });
}

/* PDF EXPORT */
document.getElementById("downloadReportBtn").addEventListener("click", () => {
  const element = document.getElementById("reportContent");
  const buttons = document.querySelectorAll('.btn, .btn-hero-small, select, .search-box');
  buttons.forEach(b => b.style.display = 'none');
  
  html2pdf().from(element).set({
    margin: 0.5,
    filename: 'OCSI-Admin-Report.pdf',
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
  }).save().then(() => {
    buttons.forEach(b => b.style.display = 'inline-flex');
  });
});

/* INTERACTION HOOKS */
window.selectTicketById = (id) => {
  selectedTicketId = id;
  const t = allTickets.find(x => x.id === id);
  document.getElementById("detailsPlaceholder").classList.add("hidden");
  document.getElementById("ticketEditBlock").classList.remove("hidden");
  document.getElementById("statusInput").value = t.status || "open";
  document.getElementById("priorityInput").value = t.priority || "medium";
  document.getElementById("descriptionInput").value = t.description || "";
  document.getElementById("assigneeInput").value = t.assigneeName || "";
};

// Event Listeners for Filters
searchEl.addEventListener("input", renderTickets);
groupFilterEl.addEventListener("change", renderTickets);
</script>

</body>
</html>
