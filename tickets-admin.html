<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Admin ‚Äì Command Center</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --red1:#c53030; --red2:#f56565; --brand:#1a73e8; --border:#e5e7eb;
      --btn-bg:#ffffff; --btn-text:#2d3748; --btn-border:#cbd5e1;
      --chip-bg:#edf2f7; --chip-text:#2d3748;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,sans-serif; background:#f7fafc; color:#1a202c; }

    /* STICKY HEADER */
    .hero{
      position:sticky; top:0; z-index:2000;
      background:linear-gradient(90deg,var(--red1),var(--red2));
      color:white; padding:15px 26px;
      display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }
    .hero-title{ font-size:1.5rem; font-weight:600; }
    .hero-right{ display:flex; align-items:center; gap:20px; }

    /* TWO-COLUMN LAYOUT */
    .main-grid {
      display: grid;
      grid-template-columns: 1fr 320px; /* Left: Main, Right: Analytics */
      gap: 24px;
      max-width: 1400px;
      margin: 0 auto;
      padding: 24px 16px;
    }

    @media(max-width: 1100px) {
      .main-grid { grid-template-columns: 1fr; }
    }

    .card-shell{
      background:white; border-radius:12px; border:1px solid var(--border);
      padding:18px; box-shadow:0 10px 30px rgba(15,23,42,.06);
    }

    /* ANALYTICS SIDEBAR */
    .sidebar-sticky {
      position: sticky;
      top: 90px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .chart-box {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 15px;
      height: 220px;
    }
    .sidebar-label {
      font-size: 0.75rem;
      font-weight: 800;
      color: #94a3b8;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: block;
    }

    /* TOOLBAR & SEARCH */
    .toolbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; gap:10px; flex-wrap:wrap; }
    .search-box{
      display:flex; align-items:center; gap:8px; background:white;
      border:1px solid var(--border); border-radius:999px; padding:6px 14px; width:100%; max-width:400px;
    }
    .search-box input{ border:none; outline:none; font-size:.9rem; width:100%; }

    /* TABLE */
    .table-wrap{ border-radius:10px; border:1px solid var(--border); overflow-y:auto; max-height:430px; }
    table{ width:100%; border-collapse:collapse; font-size:.85rem; }
    th,td{ padding:10px; border-bottom:1px solid #f1f5f9; text-align:left; }
    th{ background:#f8fafc; color:#4b5563; position:sticky; top:0; z-index:10; }
    tr:hover td{ background:#f9fafb; cursor: pointer; }

    /* PILLS & BUTTONS */
    .pill{ padding:2px 8px; border-radius:999px; font-size:.75rem; font-weight: 600; }
    .pill-open{ background:#ebf8ff; color:#2b6cb0; }
    .pill-closed{ background:#e6fffa; color:#2c7a7b; }
    .pill-progress{ background:#fff3cd; color:#b7791f; }
    .btn{ border:none; cursor:pointer; padding:8px 16px; border-radius:999px; font-size:.85rem; font-weight:600; }
    .btn-primary{ background:var(--brand); color:white; }

    .ticket-edit{ border-radius:8px; border:1px solid #e5e7eb; padding:15px; background:#fdfefe; margin-bottom:15px; }
    .field-label{ font-size:.8rem; font-weight:600; margin-bottom:4px; margin-top:10px; }
    .field-input, .field-select, .field-textarea{ width:100%; padding:8px; border-radius:8px; border:1px solid #cbd5e1; font-size:.9rem; }
    .hidden{ display:none; }
  </style>
</head>

<body>

<header class="hero">
  <div class="hero-title">OCSI Service Request</div>
  <div class="hero-right">
    <div id="who" style="font-size:0.9rem;">...</div>
    <button id="logoutBtn" class="btn-hero-small" style="background:rgba(255,255,255,0.2); color:white; border:none; border-radius:20px; padding:5px 15px; cursor:pointer;">Log out</button>
  </div>
</header>

<main class="main-grid">
  <section>
    <div class="card-shell">
      <h1>Admin Dashboard</h1>
      <p style="color:#64748b; font-size:0.9rem; margin-bottom:20px;">Universal search and ticket management for IT and Front Office.</p>

      <div class="toolbar">
        <div class="search-box">
          <span>üîç</span>
          <input id="search" placeholder="Search anything (ID, name, problem, status)..."/>
        </div>
        <div style="display:flex; gap:10px;">
          <select id="groupFilter">
            <option value="">All Groups</option>
            <option value="IT">IT</option>
            <option value="Front Office">Front Office</option>
          </select>
          <button id="newTicketBtn" class="btn btn-primary">‚ûï New ticket</button>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr><th>#</th><th>Summary</th><th>Group</th><th>Status</th><th>Assignee</th><th>Created</th></tr>
          </thead>
          <tbody id="ticketsBody"></tbody>
        </table>
      </div>

      <div style="margin-top:25px;">
        <h2>Ticket Details</h2>
        <div id="detailsPlaceholder" style="padding:20px; background:#f8fafc; border-radius:10px; text-align:center; color:#94a3b8;">Select a ticket to view or edit details</div>
        
        <div id="ticketEditBlock" class="ticket-edit hidden">
          <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;">
            <div>
              <div class="field-label">Status</div>
              <select id="statusInput" class="field-select">
                <option value="open">Open</option>
                <option value="in-progress">In progress</option>
                <option value="closed">Closed</option>
              </select>
            </div>
            <div>
              <div class="field-label">Priority</div>
              <select id="priorityInput" class="field-select">
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
          </div>

          <div class="field-label">Assignee</div>
          <input id="assigneeInput" class="field-input" placeholder="Name of staff member"/>

          <div class="field-label">Admin Reply</div>
          <textarea id="replyInput" class="field-textarea" placeholder="Add a comment..."></textarea>
          
          <button id="saveTicketBtn" class="btn btn-primary" style="margin-top:15px; width:100%;">üíæ Update Ticket & Send Reply</button>
        </div>
      </div>
    </div>
  </section>

  <aside>
    <div class="sidebar-sticky">
      <div class="chart-box">
        <span class="sidebar-label">Volume by Group</span>
        <canvas id="groupChart"></canvas>
      </div>
      <div class="chart-box">
        <span class="sidebar-label">Priority Spread</span>
        <canvas id="priorityChart"></canvas>
      </div>
      <div class="chart-box" style="height: 150px; text-align: center;">
        <span class="sidebar-label">Active Tickets</span>
        <h1 id="activeCount" style="font-size: 3rem; margin: 10px 0; color: var(--brand);">0</h1>
      </div>
    </div>
  </aside>
</main>

<script type="module">
import { db, watchAuth } from "./firebase.js";
import { collection, doc, getDocs, updateDoc, addDoc, serverTimestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

let allTickets = [], selectedId = null, charts = {};

watchAuth({
  allowedRoles: ["admin", "it"],
  onReady: async (user) => {
    document.getElementById("who").textContent = user.email;
    await loadTickets();
  }
});

async function loadTickets() {
  const snap = await getDocs(collection(db, "tickets"));
  // REMOVE Maintenance and Nurse from the data source
  allTickets = snap.docs.map(ds => ({ id: ds.id, ...ds.data() }))
                   .filter(t => t.group === "IT" || t.group === "Front Office");
  renderTickets();
}

function renderTickets() {
  const term = document.getElementById("search").value.toLowerCase();
  const groupFilter = document.getElementById("groupFilter").value;

  // UNIVERSAL SEARCH logic: searches across all properties
  const filtered = allTickets.filter(t => {
    const searchString = Object.values(t).join(" ").toLowerCase();
    const matchSearch = !term || searchString.includes(term);
    const matchGroup = !groupFilter || t.group === groupFilter;
    return matchSearch && matchGroup;
  });

  document.getElementById("ticketsBody").innerHTML = filtered.map((t, i) => `
    <tr onclick="window.selectTicket('${t.id}')">
      <td>${i+1}</td>
      <td><b>${t.summary || 'No Summary'}</b></td>
      <td>${t.group}</td>
      <td><span class="pill pill-${t.status || 'open'}">${t.status || 'open'}</span></td>
      <td>${t.assigneeName || '--'}</td>
      <td>${t.createdAt?.toDate().toLocaleDateString() || ''}</td>
    </tr>
  `).join("");

  updateCharts(filtered);
}

window.selectTicket = (id) => {
  selectedId = id;
  const t = allTickets.find(x => x.id === id);
  document.getElementById("detailsPlaceholder").classList.add("hidden");
  document.getElementById("ticketEditBlock").classList.remove("hidden");
  document.getElementById("statusInput").value = t.status || "open";
  document.getElementById("priorityInput").value = t.priority || "medium";
  document.getElementById("assigneeInput").value = t.assigneeName || "";
};

function updateCharts(data) {
  const g = { IT: 0, "Front Office": 0 }, p = { high: 0, medium: 0, low: 0 };
  let active = 0;

  data.forEach(t => {
    if(g.hasOwnProperty(t.group)) g[t.group]++;
    if(p.hasOwnProperty(t.priority)) p[t.priority]++;
    if(t.status !== 'closed') active++;
  });

  document.getElementById("activeCount").textContent = active;
  Object.values(charts).forEach(c => c.destroy());

  const opt = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } };
  
  charts.g = new Chart(document.getElementById('groupChart'), {
    type: 'bar',
    data: { labels: ['IT', 'Front Office'], datasets: [{ data: [g.IT, g["Front Office"]], backgroundColor: '#3b82f6' }] },
    options: opt
  });

  charts.p = new Chart(document.getElementById('priorityChart'), {
    type: 'doughnut',
    data: { labels: ['High', 'Med', 'Low'], datasets: [{ data: [p.high, p.medium, p.low], backgroundColor: ['#ef4444', '#f59e0b', '#10b981'] }] },
    options: { ...opt, cutout: '70%' }
  });
}

document.getElementById("saveTicketBtn").onclick = async () => {
  if(!selectedId) return;
  const reply = document.getElementById("replyInput").value;
  
  await updateDoc(doc(db, "tickets", selectedId), {
    status: document.getElementById("statusInput").value,
    priority: document.getElementById("priorityInput").value,
    assigneeName: document.getElementById("assigneeInput").value,
    updatedAt: serverTimestamp()
  });

  if(reply) {
    await addDoc(collection(db, "tickets", selectedId, "comments"), {
      message: reply,
      authorName: "Admin",
      createdAt: serverTimestamp()
    });
  }

  alert("Ticket Updated");
  loadTickets();
};

document.getElementById("search").oninput = renderTickets;
document.getElementById("groupFilter").onchange = renderTickets;
document.getElementById("logoutBtn").onclick = () => window.location.href="login.html";
document.getElementById("newTicketBtn").onclick = () => window.location.href="submit-request.html";
</script>

</body>
</html>
