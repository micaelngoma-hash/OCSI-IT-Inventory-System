<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Service Request ‚Äì Admin Tickets</title>

  <style>
    :root {
      /* --------------------------------------------------------------
         OCSI COLOR SYSTEM ‚Äî LIGHT MODE
         -------------------------------------------------------------- */
      --ocsi-red: #C8102E;
      --ocsi-blue: #0033A0;
      --ocsi-blue-light: #E6ECF9;
      --ocsi-bg: #f7f9fc;
      --panel-bg: #ffffff;

      --text-main: #1a1a1a;
      --text-muted: #555;

      --border: #d0d4dc;

      --pill-open: #e6f4ff;
      --pill-open-text: #0050b3;

      --pill-progress: #fff4d2;
      --pill-progress-text: #8a6d1c;

      --pill-closed: #e9fff7;
      --pill-closed-text: #1f8f6b;

      /* Buttons */
      --btn-bg: #ffffff;
      --btn-hover: #f1f4f9;
      --btn-border: #cbd3e1;
      --btn-text: #333;

      /* Dark Mode Tokens (will auto-switch) */
      --dark-bg: #0d1117;
      --dark-panel: #161b22;
      --dark-text: #e6edf3;
      --dark-muted: #8b949e;
      --dark-border: #30363d;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--ocsi-bg);
      color: var(--text-main);
      transition: background 0.3s, color 0.3s;
    }

    /* --------------------------------------------------------------
       FIXED HEADER
       -------------------------------------------------------------- */
    .hero {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: var(--ocsi-red);
      color: white;
      padding: 0 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 9999;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .hero-left {
      display: flex;
      align-items: center;
      gap: 18px;
    }

    .hero-logo {
      height: 40px;
      width: auto;
    }

    .hero-title {
      font-size: 1.45rem;
      font-weight: 600;
    }

    .hero-menu a {
      color: white;
      margin-left: 16px;
      font-size: 0.9rem;
      text-decoration: none;
      opacity: 0.9;
    }

    .hero-right {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    /* Small hero button */
    .btn-hero-small {
      background: rgba(255,255,255,0.18);
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 50px;
      cursor: pointer;
      font-size: 0.85rem;
    }

    /* --------------------------------------------------------------
       LAYOUT (PADDING BELOW FIXED HEADER)
       -------------------------------------------------------------- */
    main {
      padding-top: 90px;
      padding-bottom: 40px;
      width: 100%;
      display: flex;
      justify-content: center;
    }

    .card-shell {
      width: 100%;
      max-width: 1300px;
      background: var(--panel-bg);
      border-radius: 12px;
      border: 1px solid var(--border);
      padding: 20px 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      transition: background 0.3s, border 0.3s;
    }

    h1 {
      margin: 0 0 6px;
      font-size: 1.6rem;
      color: var(--ocsi-blue);
    }

    .subtitle {
      margin: 0 0 18px;
      font-size: 0.92rem;
      color: var(--text-muted);
    }

    /* --------------------------------------------------------------
       TOOLBAR (filters + new ticket + split view toggle)
       -------------------------------------------------------------- */
    .toolbar {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 14px;
      gap: 10px;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 6px;
      background: white;
      border: 1px solid var(--border);
      border-radius: 50px;
      padding: 6px 12px;
      max-width: 320px;
      width: 100%;
    }

    .search-box input {
      border: none;
      outline: none;
      background: transparent;
      width: 100%;
      font-size: 0.9rem;
    }

    .filters {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    select {
      padding: 6px 10px;
      border-radius: 50px;
      border: 1px solid var(--border);
      background: white;
      font-size: 0.88rem;
      cursor: pointer;
    }

    .btn {
      padding: 7px 14px;
      border-radius: 50px;
      border: none;
      cursor: pointer;
      font-size: 0.88rem;
      font-weight: 600;
    }

    .btn-primary {
      background: var(--ocsi-blue);
      color: white;
    }

    /* Split view toggle */
    .btn-split {
      background: var(--btn-bg);
      color: var(--btn-text);
      border: 1px solid var(--btn-border);
      padding: 7px 14px;
      border-radius: 50px;
      cursor: pointer;
    }
    .btn-split:hover {
      background: var(--btn-hover);
    }

    /* --------------------------------------------------------------
       SPLIT VIEW CONTAINER
       -------------------------------------------------------------- */
    .split-container {
      width: 100%;
      display: flex;
      flex-direction: column;
      height: calc(100vh - 160px);
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .top-pane {
      height: 350px; /* default from your selection */
      overflow: auto;
      background: var(--panel-bg);
      transition: height 0.2s ease;
    }

    .drag-divider {
      height: 6px;
      background: var(--ocsi-blue-light);
      cursor: row-resize;
      transition: background 0.2s;
    }
    .drag-divider:hover {
      background: var(--ocsi-blue);
    }

    .bottom-pane {
      flex: 1;
      overflow: auto;
      background: var(--panel-bg);
    }

    /* --------------------------------------------------------------
       TABLE
       -------------------------------------------------------------- */
    .panel {
      background: var(--panel-bg);
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
      margin-bottom: 18px;
    }

    .table-wrap {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: auto;
    }

    table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
      font-size: 0.88rem;
    }

    th {
      background: var(--ocsi-blue-light);
      padding: 10px;
      text-align: left;
      font-weight: 600;
      color: var(--ocsi-blue);
      border-bottom: 1px solid var(--border);
    }

    td {
      padding: 10px;
      border-bottom: 1px solid #eee;
    }

    tr:hover td {
      background: #f8faff;
    }

    /* Status pills */
    .pill {
      padding: 4px 10px;
      border-radius: 50px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
    }
    .pill-open { background: var(--pill-open); color: var(--pill-open-text); }
    .pill-progress { background: var(--pill-progress); color: var(--pill-progress-text); }
    .pill-closed { background: var(--pill-closed); color: var(--pill-closed-text); }
    /* --------------------------------------------------------------
       TICKET DETAILS FORM
       -------------------------------------------------------------- */
    .ticket-edit {
      background: var(--panel-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 14px 16px;
      margin-bottom: 16px;
    }

    .ticket-top-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 14px;
    }

    @media (max-width: 900px) {
      .ticket-top-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .field-label {
      font-size: 0.78rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-muted);
    }

    .field-input,
    .field-select,
    .field-textarea {
      width: 100%;
      padding: 7px 10px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 0.9rem;
      background: white;
      font-family: inherit;
    }

    .field-textarea {
      min-height: 80px;
      resize: vertical;
    }

    /* Assignment row */
    .assign-row {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .user-select {
      max-width: 170px;
    }

    /* Modern buttons */
    .action-btn {
      padding: 6px 14px;
      border-radius: 50px;
      border: 1px solid var(--btn-border);
      background: var(--btn-bg);
      color: var(--btn-text);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: 0.18s;
    }
    .action-btn:hover {
      background: var(--btn-hover);
      transform: translateY(-1px);
    }

    .action-btn.success {
      background: #e6fff7;
      border-color: #b3f7da;
      color: #1e7a58;
    }

    .action-btn.danger {
      background: #fff2f2;
      border-color: #ffcccc;
      color: #b30000;
    }

    .action-btn.primary {
      background: var(--ocsi-blue);
      border-color: var(--ocsi-blue);
      color: white;
    }
    .action-btn.primary:hover {
      background: #002a82;
    }

    .ticket-btn-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .status-bar {
      font-size: 0.8rem;
      margin-top: 6px;
      color: var(--text-muted);
      min-height: 20px;
    }

    /* --------------------------------------------------------------
       COMMENTS
       -------------------------------------------------------------- */
    .comment-list {
      max-height: 240px;
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      background: #fafbfd;
    }

    .comment {
      padding-bottom: 8px;
      margin-bottom: 8px;
      border-bottom: 1px dashed var(--border);
    }
    .comment:last-child {
      border-bottom: none;
      margin-bottom: 0;
      padding-bottom: 0;
    }

    .comment-meta {
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-bottom: 2px;
    }

    .comment-muted {
      font-size: 0.85rem;
      color: #888;
    }

    /* --------------------------------------------------------------
       EMAIL CHIP SYSTEM
       -------------------------------------------------------------- */
    .chip-area {
      min-height: 40px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      background: var(--ocsi-blue-light);
      color: var(--ocsi-blue);
      padding: 4px 10px;
      border-radius: 999px;
      margin: 3px;
      font-size: 0.82rem;
      font-weight: 600;
    }

    .chip button {
      margin-left: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      color: var(--ocsi-red);
      font-size: 0.9rem;
      padding: 0;
    }

    .email-add-row {
      margin-top: 12px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    /* --------------------------------------------------------------
       MODAL (Add User)
       -------------------------------------------------------------- */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 99999;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      background: var(--panel-bg);
      padding: 24px;
      width: 360px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 8px 30px rgba(0,0,0,0.2);
      animation: fadeIn 0.2s ease-out;
    }

    .modal-btn-row {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
    }

    /* Fade animation */
    @keyframes fadeIn {
      from {opacity: 0; transform: scale(0.96);}
      to {opacity: 1; transform: scale(1);}
    }

    /* --------------------------------------------------------------
       DARK MODE
       -------------------------------------------------------------- */
    body.dark {
      background: var(--dark-bg);
      color: var(--dark-text);
    }

    body.dark .card-shell,
    body.dark .panel,
    body.dark .modal-content {
      background: var(--dark-panel);
      border-color: var(--dark-border);
    }

    body.dark th {
      background: #1f2937;
      color: var(--dark-text);
    }

    body.dark td {
      border-color: #2d333b;
    }

    body.dark .search-box {
      background: #22272e;
      border-color: var(--dark-border);
    }

    body.dark select,
    body.dark input,
    body.dark textarea {
      background: #1d2228;
      color: var(--dark-text);
      border-color: var(--dark-border);
    }

    body.dark .btn-primary {
      background: var(--ocsi-blue);
      border-color: var(--ocsi-blue);
    }

    body.dark .btn,
    body.dark .action-btn {
      border-color: var(--dark-border);
      color: var(--dark-text);
      background: #22272e;
    }

    body.dark .drag-divider {
      background: #27303a;
    }

    body.dark .drag-divider:hover {
      background: var(--ocsi-blue);
    }

  </style>
</head>

<body>

  <!-- ============================================================
       FIXED HEADER
       ============================================================ -->
  <header class="hero">
    <div class="hero-left">
      <!-- Your actual uploaded logo -->
      <img src="OCSI_MonogramLogo_Color.png" class="hero-logo" />

      <div class="hero-title">OCSI Service Request</div>
    </div>

    <div class="hero-right">
      <div class="hero-user">
        <div id="who" class="hero-email">Checking session‚Ä¶</div>
      </div>
      <button id="logoutBtn" class="btn-hero-small" type="button">Log out</button>
    </div>
  </header>


  <!-- ============================================================
       MAIN CONTENT
       ============================================================ -->
  <main>
    <section class="card-shell">

      <h1>Tickets (Admin view)</h1>

      <p class="subtitle">
        View and manage all service requests from staff. Update status, assign tickets, and reply to the requester.
      </p>

      <!-- ============================================================
           TOP TOOLBAR (filters + search + split toggle)
           ============================================================ -->
      <div class="toolbar">

        <div class="search-box">
          <span>üîç</span>
          <input id="search" placeholder="Search summary, requester, location‚Ä¶" />
        </div>

        <div class="filters">
          <select id="groupFilter">
            <option value="">All groups</option>
            <option value="IT">IT</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Front Office">Front Office</option>
            <option value="Nurse">Nurse</option>
          </select>

          <select id="statusFilter">
            <option value="">All statuses</option>
            <option value="open">Open</option>
            <option value="in-progress">In progress</option>
            <option value="closed">Closed</option>
          </select>

          <!-- New Ticket -->
          <button id="newTicketBtn" class="btn btn-primary" type="button">
            ‚ûï New ticket
          </button>

          <!-- Split View Toggle -->
          <button id="toggleSplitViewBtn" class="btn-split" type="button">
            ‚Üï Split View
          </button>
        </div>
      </div>

      <p id="listStatus" class="small-text">Loading tickets‚Ä¶</p>


      <!-- ============================================================
           SPLIT VIEW CONTAINER
           ============================================================ -->
      <div id="splitContainer" class="split-container">

        <!-- ========================
             TOP PANE ‚Äî TICKET LIST
             ======================== -->
        <div id="topPane" class="top-pane">

          <section class="panel">
            <h2>Ticket list</h2>

            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Summary</th>
                    <th>Group</th>
                    <th>Priority</th>
                    <th>Status</th>
                    <th>Assignee</th>
                    <th>Requester</th>
                    <th>Created</th>
                  </tr>
                </thead>

                <tbody id="ticketsBody">
                  <tr><td colspan="8">Loading‚Ä¶</td></tr>
                </tbody>
              </table>
            </div>
          </section>

        </div>

        <!-- Draggable Divider -->
        <div id="dragDivider" class="drag-divider"></div>

        <!-- ========================
             BOTTOM PANE ‚Äî DETAILS
             (details panel inserted in Part 3)
             ======================== -->
        <!-- ============================================================
             BOTTOM PANE ‚Äî DETAILS PANEL
             ============================================================ -->
        <div id="bottomPane" class="bottom-pane">

          <section class="panel">
            <h2>Ticket details & replies</h2>

            <p class="muted" id="detailsHint">
              No ticket selected yet.
            </p>

            <div id="detailsPlaceholder" class="comment-muted" style="margin-bottom:8px;">
              Select a ticket above to view its details.
            </div>

            <!-- ===============================
                 TICKET EDIT BLOCK (hidden until click)
                 =============================== -->
            <div id="ticketEditBlock" class="ticket-edit hidden">

              <div class="ticket-top-grid">

                <div>
                  <div class="field-label">Group</div>
                  <select id="groupInput" class="field-select">
                    <option value="IT">IT</option>
                    <option value="Maintenance">Maintenance</option>
                    <option value="Front Office">Front Office</option>
                    <option value="Nurse">Nurse</option>
                  </select>
                </div>

                <div>
                  <div class="field-label">Status</div>
                  <select id="statusInput" class="field-select">
                    <option value="open">Open</option>
                    <option value="in-progress">In progress</option>
                    <option value="closed">Closed</option>
                  </select>
                </div>

                <div>
                  <div class="field-label">Priority</div>
                  <select id="priorityInput" class="field-select">
                    <option value="medium">Medium</option>
                    <option value="high">High</option>
                    <option value="low">Low</option>
                  </select>
                </div>

                <!-- ASSIGNEE BLOCK -->
                <div>
                  <div class="field-label">Assignee</div>

                  <div class="assign-row">

                    <!-- Free-text assignment -->
                    <input id="assigneeInput" class="field-input user-select" placeholder="Unassigned" />

                    <!-- Assign to me -->
                    <button id="assignMeBtn" class="action-btn success" type="button">
                      ‚úî Me
                    </button>

                    <!-- Unassign -->
                    <button id="unassignBtn" class="action-btn danger" type="button">
                      ‚úñ Unassign
                    </button>

                    <!-- Add User (modal button) -->
                    <button id="openModalBtn" class="action-btn primary" type="button">
                      ‚ûï Add user
                    </button>

                  </div>
                </div>

              </div> <!-- end ticket-top-grid -->

              <!-- READ ONLY BLOCKS -->
              <div class="field-label">Summary</div>
              <input id="summaryInput" class="field-input" readonly />

              <div class="field-label">Description</div>
              <textarea id="descriptionInput" class="field-textarea" readonly></textarea>

              <div class="field-label">Location</div>
              <input id="locationInput" class="field-input" readonly />

              <div class="field-label">Requested completion date</div>
              <input id="dueDateInput" type="date" class="field-input" readonly />

              <div class="field-label">Urgency</div>
              <select id="urgencyInput" class="field-select" disabled>
                <option value="1">1 ‚Äì Low</option>
                <option value="2">2</option>
                <option value="3">3 ‚Äì Normal</option>
                <option value="4">4</option>
                <option value="5">5 ‚Äì Very urgent</option>
              </select>

              <div class="ticket-btn-row">
                <button id="saveTicketBtn" class="btn btn-primary" type="button">
                  üíæ Save ticket
                </button>
              </div>

              <div id="formStatus" class="status-bar"></div>

            </div> <!-- END ticketEditBlock -->

            <!-- COMMENTS -->
            <div>
              <div class="field-label">Conversation</div>

              <div id="commentsList" class="comment-list">
                <div class="comment-muted">No ticket selected yet.</div>
              </div>

              <div class="field-label" style="margin-top:10px;">Add reply</div>
              <textarea id="replyInput" class="field-textarea" placeholder="Reply to the requester or add internal notes"></textarea>

              <button id="addReplyBtn" class="btn" type="button" style="margin-top:6px;">
                üí¨ Add reply
              </button>
            </div>

          </section> <!-- END details panel -->

        </div> <!-- END bottomPane -->

      </div> <!-- END splitContainer -->


      <!-- ============================================================
           GROUP NOTIFICATION MEMBERS (Dropdown + Chips)
           ============================================================ -->
      <section class="panel">
        <h2>Group notification members</h2>
        <p class="muted">
          Select a group, add/remove email addresses, and save.
        </p>

        <div>
          <div class="field-label">Select group</div>
          <select id="groupSelect" class="field-select" style="max-width:250px;">
            <option value="IT">IT</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Front Office">Front Office</option>
            <option value="Nurse">Nurse</option>
          </select>
        </div>

        <div class="field-label" style="margin-top:12px;">Group members</div>
        <div id="emailChipContainer" class="chip-area"></div>

        <div class="email-add-row">
          <input id="newEmailInput" class="field-input" placeholder="Enter email‚Ä¶" />
          <button id="addEmailBtn" class="action-btn primary" type="button">‚ûï Add</button>
        </div>

        <button id="saveGroupBtn" class="btn" type="button" style="margin-top:12px;">
          üíæ Save list
        </button>

        <div id="groupStatus" class="status-bar"></div>
      </section>

    </section> <!-- END card-shell -->
  </main>


  <!-- ============================================================
       ADD USER MODAL (Used to add assignee + group users)
       ============================================================ -->
  <div id="addUserModal" class="modal hidden">
    <div class="modal-content">
      <h3 style="margin-top:0;">Add User</h3>

      <div class="field-label">User name</div>
      <input id="newUserName" class="field-input" placeholder="e.g., John Doe" />

      <div class="field-label" style="margin-top:12px;">User email</div>
      <input id="newUserEmail" class="field-input" placeholder="e.g., john@ocsi.org" />

      <div class="modal-btn-row">
        <button id="cancelModalBtn" class="btn">Cancel</button>
        <button id="saveModalBtn" class="btn btn-primary">Add</button>
      </div>
    </div>
  </div>


  <!-- ============================================================
       FULL JAVASCRIPT LOGIC
       ============================================================ -->
  <script type="module">
    import { db, watchAuth } from "./firebase.js";
    import {
      collection, doc, addDoc, getDocs, updateDoc, setDoc,
      serverTimestamp, query, orderBy, limit
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";


    /* ============================================================
       DOM ELEMENTS (abbreviated for clarity)
       ============================================================ */
    const whoEl = document.getElementById("who");
    const logoutBtn = document.getElementById("logoutBtn");

    const ticketsBody = document.getElementById("ticketsBody");
    const listStatus = document.getElementById("listStatus");

    const searchEl = document.getElementById("search");
    const groupFilterEl = document.getElementById("groupFilter");
    const statusFilterEl = document.getElementById("statusFilter");
    const newTicketBtn = document.getElementById("newTicketBtn");

    const splitContainer = document.getElementById("splitContainer");
    const dragDivider = document.getElementById("dragDivider");
    const toggleSplitBtn = document.getElementById("toggleSplitViewBtn");

    const ticketEditBlock = document.getElementById("ticketEditBlock");
    const detailsHint = document.getElementById("detailsHint");
    const detailsPlaceholder = document.getElementById("detailsPlaceholder");

    const groupInput = document.getElementById("groupInput");
    const statusInput = document.getElementById("statusInput");
    const priorityInput = document.getElementById("priorityInput");
    const assigneeInput = document.getElementById("assigneeInput");

    const assignMeBtn = document.getElementById("assignMeBtn");
    const unassignBtn = document.getElementById("unassignBtn");
    const openModalBtn = document.getElementById("openModalBtn");

    const summaryInput = document.getElementById("summaryInput");
    const descriptionInput = document.getElementById("descriptionInput");
    const locationInput = document.getElementById("locationInput");
    const dueDateInput = document.getElementById("dueDateInput");
    const urgencyInput = document.getElementById("urgencyInput");

    const saveTicketBtn = document.getElementById("saveTicketBtn");
    const formStatus = document.getElementById("formStatus");

    const commentsList = document.getElementById("commentsList");
    const replyInput = document.getElementById("replyInput");
    const addReplyBtn = document.getElementById("addReplyBtn");

    const groupSelect = document.getElementById("groupSelect");
    const emailChipContainer = document.getElementById("emailChipContainer");
    const newEmailInput = document.getElementById("newEmailInput");
    const addEmailBtn = document.getElementById("addEmailBtn");
    const saveGroupBtn = document.getElementById("saveGroupBtn");
    const groupStatus = document.getElementById("groupStatus");

    /* Modal */
    const addUserModal = document.getElementById("addUserModal");
    const cancelModalBtn = document.getElementById("cancelModalBtn");
    const saveModalBtn = document.getElementById("saveModalBtn");
    const newUserName = document.getElementById("newUserName");
    const newUserEmail = document.getElementById("newUserEmail");


    /* ============================================================
       STATE
       ============================================================ */
    let currentUser = null;
    let allTickets = [];
    let selectedTicketId = null;

    let groupEmailList = [];
    let knownUsers = []; // Users added through modal are stored here


    /* ============================================================
       AUTH HANDLING
       ============================================================ */
    watchAuth({
      allowedRoles: ["admin", "it", "viewer"],
      whoEl,
      onReady: async (user, role) => {
        currentUser = user;

        if (!user || (role !== "admin" && role !== "it")) {
          alert("Admin/IT only");
          window.location.href = "tickets.html";
          return;
        }

        searchEl.addEventListener("input", renderTickets);
        groupFilterEl.addEventListener("change", renderTickets);
        statusFilterEl.addEventListener("change", renderTickets);

        ticketsBody.addEventListener("click", onRowClick);

        newTicketBtn.addEventListener("click", () =>
          window.location.href = "submit-request.html"
        );

        assignMeBtn.addEventListener("click", () => {
          assigneeInput.value = currentUser.displayName || currentUser.email;
        });

        unassignBtn.addEventListener("click", () => {
          assigneeInput.value = "Unassigned";
        });

        addReplyBtn.addEventListener("click", addReply);
        saveTicketBtn.addEventListener("click", saveTicket);

        toggleSplitBtn.addEventListener("click", toggleSplitView);

        /* Modal */
        openModalBtn.addEventListener("click", () => addUserModal.classList.remove("hidden"));
        cancelModalBtn.addEventListener("click", () => addUserModal.classList.add("hidden"));
        saveModalBtn.addEventListener("click", saveNewUser);

        /* Group system */
        groupSelect.addEventListener("change", loadSelectedGroup);
        addEmailBtn.addEventListener("click", addEmailToList);
        saveGroupBtn.addEventListener("click", saveGroupEmails);

        await loadTickets();
        await loadSelectedGroup();
      }
    });


    /* ============================================================
       LOAD TICKETS
       ============================================================ */
    async function loadTickets() {
      const snap = await getDocs(collection(db, "tickets"));
      allTickets = snap.docs.map(ds => ({ id: ds.id, ...ds.data() }));

      allTickets.sort((a,b) => {
        const ta = a.createdAt?.toMillis?.() || 0;
        const tb = b.createdAt?.toMillis?.() || 0;
        return tb - ta;
      });

      renderTickets();
    }

    function renderTickets() {
      const term = searchEl.value.toLowerCase();
      const gf = groupFilterEl.value;
      const sf = statusFilterEl.value;

      const rows = allTickets.filter(t => {
        const st = (t.status || "open").toLowerCase();

        if (gf && t.group !== gf) return false;
        if (sf && st !== sf) return false;

        if (term) {
          const hay = [
            t.summary,
            t.description,
            t.requesterName,
            t.requesterEmail,
            t.location
          ].join(" ").toLowerCase();

          return hay.includes(term);
        }

        return true;
      });

      if (!rows.length) {
        ticketsBody.innerHTML = `<tr><td colspan="8">No match.</td></tr>`;
        return;
      }

      ticketsBody.innerHTML = rows.map((t,i) => `
        <tr data-id="${t.id}">
          <td>${i+1}</td>
          <td>${escapeHtml(t.summary)}</td>
          <td>${t.group}</td>
          <td>${capitalize(t.priority)}</td>
          <td>${statusPill(t.status)}</td>
          <td>${t.assigneeName || "Unassigned"}</td>
          <td>${t.requesterName || t.requesterEmail}</td>
          <td>${formatDate(t.createdAt)}</td>
        </tr>
      `).join("");
    }


    /* ============================================================
       SELECT / HIDE DETAILS
       ============================================================ */
    function onRowClick(e) {
      const tr = e.target.closest("tr[data-id]");
      if (!tr) return;

      const id = tr.getAttribute("data-id");

      if (id === selectedTicketId && !ticketEditBlock.classList.contains("hidden")) {
        hideDetails();
        return;
      }

      const ticket = allTickets.find(t => t.id === id);
      if (ticket) selectTicket(ticket);
    }

    function hideDetails() {
      selectedTicketId = null;
      ticketEditBlock.classList.add("hidden");
      commentsList.innerHTML = `<div class="comment-muted">No ticket selected.</div>`;
      detailsHint.textContent = "No ticket selected yet.";
      detailsPlaceholder.textContent = "Select a ticket above.";
    }

    function selectTicket(t) {
      selectedTicketId = t.id;

      detailsHint.textContent =
        `Ticket ${t.id.slice(0,8)} ‚Äì ${t.requesterName || t.requesterEmail}`;

      detailsPlaceholder.textContent = "";
      ticketEditBlock.classList.remove("hidden");

      groupInput.value = t.group;
      statusInput.value = t.status;
      priorityInput.value = t.priority;

      assigneeInput.value = t.assigneeName || "Unassigned";

      summaryInput.value = t.summary;
      descriptionInput.value = t.description;
      locationInput.value = t.location;
      dueDateInput.value = t.requestedDate || "";
      urgencyInput.value = t.urgency || 3;

      loadComments(t.id);
    }


    /* ============================================================
       SAVE TICKET
       ============================================================ */
    async function saveTicket() {
      if (!selectedTicketId) return;

      const payload = {
        group: groupInput.value,
        status: statusInput.value,
        priority: priorityInput.value,
        urgency: Number(urgencyInput.value),
        updatedAt: serverTimestamp()
      };

      const asg = assigneeInput.value.trim();
      if (asg && asg.toLowerCase() !== "unassigned") {
        payload.assigneeName = asg;
      } else {
        payload.assigneeName = "";
      }

      await updateDoc(doc(db,"tickets",selectedTicketId), payload);

      formStatus.textContent = "Saved";
      await loadTickets();
    }


    /* ============================================================
       COMMENTS
       ============================================================ */
    async function loadComments(ticketId) {
      commentsList.innerHTML = `<div class="comment-muted">Loading‚Ä¶</div>`;

      const q = query(
        collection(db,"tickets",ticketId,"comments"),
        orderBy("createdAt","asc"),
        limit(200)
      );

      const snap = await getDocs(q);
      const rows = snap.docs.map(ds => ({ id: ds.id, ...ds.data() }));

      if (!rows.length) {
        commentsList.innerHTML = `<div class="comment-muted">No replies yet.</div>`;
        return;
      }

      commentsList.innerHTML = rows.map(c => `
        <div class="comment">
          <div class="comment-meta">
            ${escapeHtml(c.authorName || "Unknown")} ‚Ä¢ ${formatDate(c.createdAt)}
          </div>
          <div>${escapeHtml(c.message)}</div>
        </div>
      `).join("");
    }

    async function addReply() {
      if (!selectedTicketId) return;

      const msg = replyInput.value.trim();
      if (!msg) return;

      await addDoc(
        collection(db,"tickets",selectedTicketId,"comments"),
        {
          message: msg,
          authorEmail: currentUser.email,
          authorName: currentUser.displayName,
          createdAt: serverTimestamp()
        }
      );

      replyInput.value = "";
      loadComments(selectedTicketId);
    }


    /* ============================================================
       GROUP NOTIFICATION SYSTEM
       ============================================================ */
    async function loadSelectedGroup() {
      const group = groupSelect.value;
      groupEmailList = [];

      const snap = await getDocs(collection(db,"ticket_groups"));
      const map = {};
      snap.forEach(ds => map[ds.id] = ds.data());

      if (map[group]?.emails) {
        groupEmailList = [...map[group].emails];
      }

      renderEmailChips();
    }

    function renderEmailChips() {
      if (!groupEmailList.length) {
        emailChipContainer.innerHTML =
          `<div class="comment-muted">No emails yet.</div>`;
        return;
      }

      emailChipContainer.innerHTML = groupEmailList.map(e => `
        <span class="chip">
          ${e}
          <button onclick="removeEmail('${e}')">√ó</button>
        </span>
      `).join("");
    }

    window.removeEmail = (email) => {
      groupEmailList = groupEmailList.filter(x => x !== email);
      renderEmailChips();
    };

    function addEmailToList() {
      const email = newEmailInput.value.trim();
      if (!email || !email.includes("@")) return;

      if (!groupEmailList.includes(email)) {
        groupEmailList.push(email);
      }

      newEmailInput.value = "";
      renderEmailChips();
    }

    async function saveGroupEmails() {
      const group = groupSelect.value;

      await setDoc(doc(db,"ticket_groups",group), {
        emails: groupEmailList,
        updatedAt: serverTimestamp()
      });

      groupStatus.textContent = "Saved.";
    }


    /* ============================================================
       ADD USER MODAL (Adds to knownUsers + group + assignee list)
       ============================================================ */
    function saveNewUser() {
      const name = newUserName.value.trim();
      const email = newUserEmail.value.trim();

      if (!name || !email || !email.includes("@")) return;

      const full = `${name} <${email}>`;

      knownUsers.push(full);

      // Immediately available in assignee input autocomplete
      assigneeInput.value = full;

      addUserModal.classList.add("hidden");
      newUserName.value = "";
      newUserEmail.value = "";
    }


    /* ============================================================
       SPLIT VIEW TOGGLE + DRAG HANDLE
       ============================================================ */
    let splitEnabled = false;
    const topPane = document.getElementById("topPane");
    const bottomPane = document.getElementById("bottomPane");

    function toggleSplitView() {
      splitEnabled = !splitEnabled;
      splitContainer.classList.toggle("split", splitEnabled);

      // Reset height if disabling split
      if (!splitEnabled) {
        topPane.style.height = "auto";
      } else {
        topPane.style.height = "350px";
      }
    }

    // Drag handle
    let isDragging = false;

    dragDivider.addEventListener("mousedown", () => {
      if (!splitEnabled) return;
      isDragging = true;
      document.body.style.userSelect = "none";
    });

    document.addEventListener("mousemove", (e) => {
      if (!isDragging) return;

      const rect = splitContainer.getBoundingClientRect();
      let newHeight = e.clientY - rect.top;

      if (newHeight < 200) newHeight = 200;
      if (newHeight > window.innerHeight - 250) newHeight = window.innerHeight - 250;

      topPane.style.height = newHeight + "px";
    });

    document.addEventListener("mouseup", () => {
      isDragging = false;
      document.body.style.userSelect = "";
    });


    /* ============================================================
       HELPERS
       ============================================================ */
    function statusPill(s) {
      const st = s?.toLowerCase() || "open";
      if (st === "closed") return `<span class="pill pill-closed">Closed</span>`;
      if (st === "in-progress") return `<span class="pill pill-progress">In progress</span>`;
      return `<span class="pill pill-open">Open</span>`;
    }

    function formatDate(v) {
      if (!v) return "";
      const d = v.toDate?.() || v;
      return d.toLocaleString();
    }

    function escapeHtml(s) {
      return (s || "").replace(/[&<>"']/g, c => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[c]));
    }

    function capitalize(s) {
      return s ? s.charAt(0).toUpperCase() + s.slice(1) : "";
    }

  </script>

</body>
</html>

