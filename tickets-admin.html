<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Service Request ‚Äì Admin Tickets</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --red1:#c53030; --red2:#f56565; --brand:#1a73e8; --border:#e5e7eb;
      --btn-bg:#ffffff; --btn-text:#2d3748; --btn-border:#cbd5e1;
      --btn-hover:#f1f5f9; --chip-bg:#edf2f7; --chip-text:#2d3748;
    }

    *{ box-sizing:border-box; }
    body{ margin:0; font-family:system-ui,-apple-system,Segoe UI,sans-serif; background:#f7fafc; color:#1a202c; }

    .hero{
      position:sticky; top:0; z-index:2000;
      background:linear-gradient(90deg,var(--red1),var(--red2));
      color:white; padding:18px 26px; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,0.25);
    }

    .hero-left{ display:flex; align-items:center; gap:28px; }
    .hero-title{ font-size:1.8rem; font-weight:600; }
    .hero-menu a{ color:white; text-decoration:none; opacity:.95; }
    .hero-right{ display:flex; align-items:center; gap:20px; }
    .hero-user-inline{ font-size:.9rem; opacity:.95; white-space:nowrap; }

    .btn-hero-small{
      border:none; border-radius:999px; padding:6px 14px; font-size:.82rem;
      background:rgba(255,255,255,.16); color:white; cursor:pointer;
    }

    /* GRID LAYOUT FOR ANALYTICS SIDEBAR */
    .wrap{
      display: grid;
      grid-template-columns: 1fr 300px; /* Left column grows, right is fixed */
      gap: 24px;
      max-width: 1450px;
      margin: 0 auto;
      padding: 34px 16px;
    }

    @media(max-width: 1100px) { .wrap { grid-template-columns: 1fr; } }

    .card-shell{
      background:white; border-radius:12px; border:1px solid var(--border);
      padding:18px; box-shadow:0 10px 30px rgba(15,23,42,.06);
    }

    /* SIDEBAR ANALYTICS */
    .sidebar-sticky { position: sticky; top: 100px; display: flex; flex-direction: column; gap: 20px; }
    .chart-box { background: white; border: 1px solid var(--border); border-radius: 12px; padding: 15px; }
    .chart-label { font-size: 0.75rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 10px; display: block; }

    h1{ margin:0 0 4px; font-size:1.3rem; }
    .subtitle{ margin:0 0 14px; font-size:.9rem; color:#4a5568; }

    .toolbar{ display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; gap:10px; flex-wrap:wrap; }
    .search-box{
      display:flex; align-items:center; gap:6px; background:white; border:1px solid var(--border);
      border-radius:999px; padding:4px 10px; width:100%; max-width: 320px;
    }
    .search-box input{ border:none; outline:none; font-size:.88rem; width:100%; background:transparent; }

    .table-wrap{ border-radius:10px; border:1px solid var(--border); overflow-y:auto; max-height:430px; position:relative; }
    table{ width:100%; border-collapse:collapse; min-width:750px; font-size:.85rem; }
    th,td{ padding:8px 10px; border-bottom:1px solid #f1f5f9; text-align:left; }
    th{ background:#f8fafc; color:#4b5563; font-weight:600; position:sticky; top:0; z-index:10; }
    tr:hover td{ background:#f9fafb; cursor: pointer; }

    .pill{ padding:2px 8px; border-radius:999px; font-size:.75rem; }
    .pill-open{ background:#ebf8ff; color:#2b6cb0; }
    .pill-closed{ background:#e6fffa; color:#2c7a7b; }
    .pill-progress{ background:#fff3cd; color:#b7791f; }

    .ticket-edit{ border-radius:8px; border:1px solid #e5e7eb; padding:15px; background:#fdfefe; margin-bottom:10px; }
    .ticket-top-grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:10px; }
    .field-label{ font-size:.8rem; font-weight:600; margin-bottom:3px; }
    .field-input, .field-select, .field-textarea{ width:100%; padding:7px 9px; border-radius:8px; border:1px solid #cbd5e1; font-size:.9rem; }
    .field-textarea{ min-height:80px; resize:vertical; }

    .comment-list{ max-height:220px; overflow:auto; border:1px solid #e5e7eb; border-radius:8px; padding:8px 10px; font-size:.82rem; background:#f9fafb; }
    .hidden{ display:none; }
    .chip{ background:var(--chip-bg); color:var(--chip-text); padding:4px 10px; border-radius:999px; font-size:.82rem; margin:4px; display:inline-flex; align-items:center; }
    .chip button{ margin-left:6px; border:none; background:transparent; cursor:pointer; color:#c53030; }
  </style>
</head>
<body>

<header class="hero">
  <div class="hero-left">
    <div class="hero-title">OCSI Service Request</div>
    <nav class="hero-menu"><a href="tickets.html">Requester view</a></nav>
  </div>
  <div class="hero-right">
    <div id="who" class="hero-user-inline">Checking session‚Ä¶</div>
    <button id="logoutBtn" class="btn-hero-small" type="button">Log out</button>
  </div>
</header>

<main class="wrap">
  <section class="card-shell">
    <h1>Tickets (Admin view)</h1>
    <p class="subtitle">Update status, assign tickets, and reply to the requester.</p>

    <div class="toolbar">
      <div class="search-box">
        <span>üîç</span>
        <input id="search" placeholder="Search summary, requester, location‚Ä¶"/>
      </div>
      <div class="filters">
        <select id="groupFilter">
          <option value="">All groups</option>
          <option value="IT">IT</option>
          <option value="Front Office">Front Office</option>
        </select>
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option value="open">Open</option>
          <option value="in-progress">In progress</option>
          <option value="closed">Closed</option>
        </select>
        <button id="newTicketBtn" class="btn" style="background:var(--brand); color:white; padding: 6px 15px; border-radius: 20px;">‚ûï New ticket</button>
      </div>
    </div>

    <p id="listStatus" class="small-text">Loading tickets‚Ä¶</p>

    <div class="table-wrap">
      <table>
        <thead>
          <tr><th>#</th><th>Summary</th><th>Group</th><th>Priority</th><th>Status</th><th>Assignee</th><th>Requester</th><th>Created</th></tr>
        </thead>
        <tbody id="ticketsBody"></tbody>
      </table>
    </div>

    <div style="margin-top:25px;">
      <h2>Ticket details &amp; replies</h2>
      <p class="muted" id="detailsHint">No ticket selected yet.</p>
      <div id="ticketEditBlock" class="ticket-edit hidden">
        <div class="ticket-top-grid">
          <div><div class="field-label">Group</div><select id="groupInput" class="field-select"><option value="IT">IT</option><option value="Front Office">Front Office</option></select></div>
          <div><div class="field-label">Status</div><select id="statusInput" class="field-select"><option value="open">Open</option><option value="in-progress">In progress</option><option value="closed">Closed</option></select></div>
          <div><div class="field-label">Priority</div><select id="priorityInput" class="field-select"><option value="medium">Medium</option><option value="high">High</option><option value="low">Low</option></select></div>
          <div><div class="field-label">Assignee</div><input id="assigneeInput" class="field-input" placeholder="Name"/></div>
        </div>
        <div class="field-label">Summary</div><input id="summaryInput" class="field-input" readonly style="margin-bottom:10px;"/>
        <div class="field-label">Description</div><textarea id="descriptionInput" class="field-textarea" readonly style="margin-bottom:10px;"></textarea>
        <button id="saveTicketBtn" class="btn" style="background:var(--brand); color:white;">üíæ Save ticket</button>
        <div id="formStatus"></div>
      </div>

      <div style="margin-top:20px;">
        <div class="field-label">Conversation</div>
        <div id="commentsList" class="comment-list"></div>
        <textarea id="replyInput" class="field-textarea" style="margin-top:10px;" placeholder="Add a reply..."></textarea>
        <button id="addReplyBtn" class="btn" style="margin-top:6px; background:#edf2f7;">üí¨ Add reply</button>
      </div>
    </div>
  </section>

  <aside>
    <div class="sidebar-sticky">
      <div class="chart-box">
        <span class="chart-label">Workload: IT vs FO</span>
        <canvas id="deptChart" height="200"></canvas>
      </div>
      <div class="chart-box">
        <span class="chart-label">Ticket Status</span>
        <canvas id="statusChart" height="200"></canvas>
      </div>
      <div class="chart-box" style="text-align: center;">
        <span class="chart-label">Active Tickets</span>
        <h1 id="activeTotal" style="font-size: 3.5rem; color: var(--brand); margin: 10px 0;">0</h1>
      </div>
    </div>
  </aside>
</main>

<script type="module">
import { db, watchAuth } from "./firebase.js";
import { collection, doc, addDoc, getDocs, updateDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* STATE */
let currentUser = null, allTickets = [], selectedTicketId = null, charts = {};

/* AUTH */
watchAuth({
  allowedRoles:["admin","it"],
  onReady: async (user, role)=>{
    currentUser = user;
    document.getElementById("who").textContent = user.email;
    initRealtime();
  }
});

/* REAL-TIME SYNC & ANALYTICS */
function initRealtime() {
  const q = query(collection(db, "tickets"), orderBy("createdAt", "desc"));
  onSnapshot(q, (snap) => {
    // Filter IT/Front Office only for this admin view
    allTickets = snap.docs
      .map(d => ({id: d.id, ...d.data()}))
      .filter(t => t.group === "IT" || t.group === "Front Office");
    
    renderTickets();
    updateAnalytics();
  });
}

function renderTickets(){
  const term = document.getElementById("search").value.toLowerCase();
  const gfilt = document.getElementById("groupFilter").value;
  const sfilt = document.getElementById("statusFilter").value;

  const rows = allTickets.filter(t => {
    const hay = Object.values(t).join(" ").toLowerCase();
    const matchSearch = !term || hay.includes(term);
    const matchGroup = !gfilt || t.group === gfilt;
    const matchStat = !sfilt || t.status === sfilt;
    return matchSearch && matchGroup && matchStat;
  });

  document.getElementById("ticketsBody").innerHTML = rows.map((t, i) => `
    <tr onclick="window.sel('${t.id}')">
      <td>${i+1}</td>
      <td><b>${escapeHtml(t.summary)}</b></td>
      <td>${t.group}</td>
      <td>${t.priority || 'medium'}</td>
      <td><span class="pill pill-${t.status || 'open'}">${t.status || 'open'}</span></td>
      <td>${t.assigneeName || 'Unassigned'}</td>
      <td>${t.requesterName || t.requesterEmail}</td>
      <td>${t.createdAt?.toDate().toLocaleDateString() || ''}</td>
    </tr>
  `).join("");
  document.getElementById("listStatus").textContent = `Displaying ${rows.length} tickets`;
}

function updateAnalytics() {
  const depts = { IT: 0, "Front Office": 0 }, stats = { open: 0, closed: 0, "in-progress": 0 };
  allTickets.forEach(t => {
    if(depts.hasOwnProperty(t.group)) depts[t.group]++;
    const s = t.status || 'open';
    if(stats.hasOwnProperty(s)) stats[s]++;
  });

  document.getElementById("activeTotal").textContent = stats.open + stats["in-progress"];

  if(charts.d) charts.d.destroy();
  if(charts.s) charts.s.destroy();

  charts.d = new Chart(document.getElementById('deptChart'), {
    type: 'bar',
    data: { labels: ['IT', 'FO'], datasets: [{ data: [depts.IT, depts["Front Office"]], backgroundColor: '#3b82f6' }] },
    options: { plugins: { legend: false }, responsive: true }
  });

  charts.s = new Chart(document.getElementById('statusChart'), {
    type: 'doughnut',
    data: { labels: ['Open', 'Closed', 'Progress'], datasets: [{ data: [stats.open, stats.closed, stats["in-progress"]], backgroundColor: ['#ef4444','#10b981','#f59e0b'] }] },
    options: { cutout: '70%', responsive: true }
  });
}

/* TICKET SELECTION */
window.sel = (id) => {
  selectedTicketId = id;
  const t = allTickets.find(x => x.id === id);
  document.getElementById("ticketEditBlock").classList.remove("hidden");
  document.getElementById("detailsHint").textContent = `Viewing #${id.slice(-5)}`;
  
  document.getElementById("groupInput").value = t.group;
  document.getElementById("statusInput").value = t.status || "open";
  document.getElementById("assigneeInput").value = t.assigneeName || "";
  document.getElementById("summaryInput").value = t.summary;
  document.getElementById("descriptionInput").value = t.description;
  loadComments(id);
};

/* HELPERS */
async function loadComments(id){
  const snap = await getDocs(query(collection(db, "tickets", id, "comments"), orderBy("createdAt", "asc")));
  document.getElementById("commentsList").innerHTML = snap.docs.map(d => {
    const c = d.data();
    return `<div style="margin-bottom:8px;"><b>${c.authorName}:</b> ${c.message}</div>`;
  }).join("") || "No replies yet.";
}

function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"})[c]); }

document.getElementById("search").oninput = renderTickets;
document.getElementById("groupFilter").onchange = renderTickets;
document.getElementById("statusFilter").onchange = renderTickets;
document.getElementById("logoutBtn").onclick = () => window.location.href="login.html";
</script>
</body>
</html>
