<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OCSI Service Request – Admin Panel</title>

  <style>
    :root {
      --red1:#c53030; --red2:#f56565; --brand:#1a73e8; --border:#e2e8f0;
      --bg-main: #f8fafc; --text-dark: #1e293b;
    }

    * { box-sizing: border-box; }
    body { 
      margin: 0; font-family: system-ui, -apple-system, sans-serif; 
      background: var(--bg-main); color: var(--text-dark); 
      height: 100vh; display: flex; flex-direction: column;
    }

    /* HEADER */
    .hero {
      background: linear-gradient(90deg, var(--red1), var(--red2));
      color: white; padding: 14px 24px;
      display: flex; align-items: center; justify-content: space-between;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-shrink: 0;
    }
    .hero-menu a { color: white; text-decoration: none; font-size: 0.9rem; margin-right: 15px; opacity: 0.9; }

    /* LAYOUT: MASTER-DETAIL */
    .admin-wrap {
      display: flex; flex: 1; overflow: hidden; padding: 20px; gap: 20px;
    }

    /* LEFT PANEL: LIST */
    .list-panel {
      flex: 1; background: white; border-radius: 12px; border: 1px solid var(--border);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .toolbar { padding: 15px; border-bottom: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
    .table-scroll { flex: 1; overflow-y: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.88rem; }
    th { position: sticky; top: 0; background: #f8fafc; padding: 12px; text-align: left; border-bottom: 2px solid var(--border); z-index: 10; }
    td { padding: 12px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
    tr.selected td { background: #eff6ff; border-left: 4px solid var(--brand); }
    tr:hover:not(.selected) td { background: #f9fafb; }

    /* RIGHT PANEL: DETAILS */
    .detail-panel {
      width: 450px; background: white; border-radius: 12px; border: 1px solid var(--border);
      display: flex; flex-direction: column; padding: 20px; overflow-y: auto;
    }

    /* UI ELEMENTS */
    .pill { padding: 3px 10px; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
    .pill-open { background: #fee2e2; color: #991b1b; }
    .pill-in-progress { background: #fef3c7; color: #92400e; }
    .pill-closed { background: #dcfce7; color: #166534; }
    
    .u-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 5px; }
    .u-5 { background: #ef4444; box-shadow: 0 0 5px #ef4444; }
    .u-1 { background: #10b981; }

    .comment-list { background: #f8fafc; border-radius: 8px; padding: 12px; margin: 15px 0; font-size: 0.85rem; flex: 1; }
    .comment-item { background: white; border: 1px solid var(--border); padding: 10px; border-radius: 6px; margin-bottom: 10px; }
    
    .field-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; margin-top: 15px; }
    .field-input, .field-select, .field-textarea { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid var(--border); font-size: 0.9rem; }
    
    .hidden { display: none; }
  </style>
</head>
<body>

<header class="hero">
  <div style="display:flex; align-items:center; gap:20px;">
    <span style="font-weight:700; font-size:1.2rem;">OCSI Service Desk</span>
    <nav class="hero-menu">
      <a href="tickets.html">Requester View</a>
      <a href="ticket-analytics.html">Analytics</a>
      <a href="settings.html">Settings</a>
    </nav>
  </div>
  <div style="display:flex; align-items:center; gap:15px;">
    <div id="who" style="font-size:0.85rem;"></div>
    <button id="logoutBtn" style="background:rgba(0,0,0,0.2); border:none; color:white; padding:6px 12px; border-radius:6px; cursor:pointer;">Logout</button>
  </div>
</header>

<main class="admin-wrap">
  <section class="list-panel">
    <div class="toolbar">
      <input type="text" id="search" placeholder="Search by summary or email..." style="flex:1; padding:8px; border-radius:6px; border:1px solid var(--border);">
      <select id="statusFilter" class="field-select" style="width:150px;">
        <option value="">All Statuses</option>
        <option value="open">Open</option>
        <option value="in-progress">In Progress</option>
        <option value="closed">Closed</option>
      </select>
    </div>
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th>Summary</th>
            <th>Group</th>
            <th>Urgency</th>
            <th>Status</th>
            <th>Last Updated</th>
          </tr>
        </thead>
        <tbody id="ticketsBody"></tbody>
      </table>
    </div>
  </section>

  <section id="detailPanel" class="detail-panel">
    <div id="noSelection" style="text-align:center; margin-top:100px; color:#94a3b8;">
      <h3>No Ticket Selected</h3>
      <p>Select a ticket from the left to manage it.</p>
    </div>

    <div id="detailContent" class="hidden">
      <h2 id="detSummary" style="margin:0; font-size:1.2rem;"></h2>
      <p id="detRequester" style="color:#64748b; font-size:0.85rem; margin:5px 0;"></p>
      
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
        <div>
          <div class="field-label">Status</div>
          <select id="statusInput" class="field-select">
            <option value="open">Open</option>
            <option value="in-progress">In Progress</option>
            <option value="closed">Closed</option>
          </select>
        </div>
        <div>
          <div class="field-label">Priority</div>
          <select id="priorityInput" class="field-select">
            <option value="low">Low</option>
            <option value="medium">Medium</option>
            <option value="high">High</option>
          </select>
        </div>
      </div>

      <div class="field-label">Description</div>
      <div id="detDesc" style="font-size:0.9rem; line-height:1.4; background:#f1f5f9; padding:10px; border-radius:6px;"></div>

      <div class="field-label">Conversation</div>
      <div id="commentsList" class="comment-list"></div>

      <textarea id="replyInput" class="field-textarea" placeholder="Type a reply..." style="height:70px;"></textarea>
      <div style="display:flex; gap:10px; margin-top:10px;">
        <button id="saveBtn" style="flex:1; background:var(--brand); color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:600;">Save Changes</button>
        <button id="replyBtn" style="flex:1; background:#1e293b; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:600;">Post Reply</button>
      </div>
      <div id="statusMsg" style="font-size:0.8rem; margin-top:10px; text-align:center;"></div>
    </div>
  </section>
</main>

<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import { 
    collection, doc, updateDoc, addDoc, onSnapshot, query, orderBy, serverTimestamp, getDocs 
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const ticketsBody = document.getElementById("ticketsBody");
  const searchInput = document.getElementById("search");
  const statusFilter = document.getElementById("statusFilter");
  
  let allTickets = [];
  let selectedId = null;
  let previousTicketIds = new Set();
  const alertSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3');

  watchAuth({
    allowedRoles: ["admin", "it"],
    onReady: (user) => {
      document.getElementById("who").textContent = user.email;
      if (Notification.permission !== "granted") Notification.requestPermission();

      // LIVE SNAPSHOT
      const q = query(collection(db, "tickets"), orderBy("updatedAt", "desc"));
      onSnapshot(q, (snap) => {
        const freshData = [];
        snap.docChanges().forEach(change => {
            if (change.type === "added") {
                const t = change.doc.data();
                if (previousTicketIds.size > 0 && !previousTicketIds.has(change.doc.id)) {
                    triggerAlert(t.summary, t.requesterEmail);
                }
                previousTicketIds.add(change.doc.id);
            }
        });

        allTickets = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderList();
      });
    }
  });

  function triggerAlert(title, email) {
      if (Notification.permission === "granted") {
          alertSound.play().catch(e => console.log("Sound blocked"));
          new Notification("New OCSI Ticket", { body: `${title} from ${email}` });
      }
  }

  function renderList() {
    const term = searchInput.value.toLowerCase();
    const sFilt = statusFilter.value;

    const filtered = allTickets.filter(t => {
      const matchesSearch = (t.summary + (t.requesterEmail || "")).toLowerCase().includes(term);
      const matchesStatus = !sFilt || t.status === sFilt;
      return matchesSearch && matchesStatus;
    });

    ticketsBody.innerHTML = filtered.map(t => `
      <tr onclick="viewTicket('${t.id}')" class="${selectedId === t.id ? 'selected' : ''}">
        <td><strong>${t.summary}</strong></td>
        <td>${t.group}</td>
        <td><span class="u-dot u-${t.urgency || 3}"></span> ${t.urgency || 3}</td>
        <td><span class="pill pill-${t.status || 'open'}">${t.status || 'open'}</span></td>
        <td style="color:#64748b">${t.updatedAt?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || '...'}</td>
      </tr>
    `).join('');
  }

  window.viewTicket = async (id) => {
    selectedId = id;
    const t = allTickets.find(x => x.id === id);
    document.getElementById("noSelection").classList.add("hidden");
    document.getElementById("detailContent").classList.remove("hidden");
    
    document.getElementById("detSummary").textContent = t.summary;
    document.getElementById("detRequester").textContent = `By ${t.requesterName || t.requesterEmail}`;
    document.getElementById("detDesc").textContent = t.description;
    document.getElementById("statusInput").value = t.status || "open";
    document.getElementById("priorityInput").value = t.priority || "medium";

    loadComments(id);
    renderList();
  };

  async function loadComments(id) {
    const q = query(collection(db, "tickets", id, "comments"), orderBy("createdAt", "asc"));
    const snap = await getDocs(q);
    const commentsList = document.getElementById("commentsList");
    commentsList.innerHTML = snap.docs.map(d => {
        const c = d.data();
        return `<div class="comment-item">
            <div style="font-size:0.7rem; color:#64748b; margin-bottom:4px;">${c.authorEmail} • ${c.createdAt?.toDate().toLocaleString() || '...'}</div>
            <div>${c.message}</div>
        </div>`;
    }).join('') || "No replies yet.";
  }

  document.getElementById("saveBtn").onclick = async () => {
    const newStatus = document.getElementById("statusInput").value;
    const currentT = allTickets.find(t => t.id === selectedId);
    
    const payload = {
        status: newStatus,
        priority: document.getElementById("priorityInput").value,
        updatedAt: serverTimestamp()
    };

    if (newStatus === "closed" && currentT.status !== "closed") {
        payload.resolvedAt = serverTimestamp();
    } else if (newStatus !== "closed") {
        payload.resolvedAt = null;
    }

    await updateDoc(doc(db, "tickets", selectedId), payload);
    document.getElementById("statusMsg").textContent = "Update saved.";
    setTimeout(() => document.getElementById("statusMsg").textContent = "", 2000);
  };

  document.getElementById("replyBtn").onclick = async () => {
    const msg = document.getElementById("replyInput").value.trim();
    if (!msg) return;
    
    await addDoc(collection(db, "tickets", selectedId, "comments"), {
        message: msg,
        authorEmail: document.getElementById("who").textContent,
        createdAt: serverTimestamp()
    });
    
    document.getElementById("replyInput").value = "";
    loadComments(selectedId);
  };

  searchInput.oninput = renderList;
  statusFilter.onchange = renderList;
</script>

</body>
</html>
