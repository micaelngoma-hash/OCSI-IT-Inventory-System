<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Login â€¢ OCSI IT Inventory</title>
<style>
  body{margin:0;font-family:system-ui;background:#0f172a;color:white;display:grid;place-items:center;height:100vh;}
  .card{background:white;color:#0f172a;border-radius:14px;padding:22px;width:min(420px,92vw);box-shadow:0 12px 30px rgba(0,0,0,.25);}
  input{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:9px;margin-top:8px;}
  button{width:100%;border:none;padding:10px;border-radius:9px;margin-top:12px;font-weight:700;cursor:pointer;}
  .google{background:#fff;border:1px solid #cbd5e1;color:#0f172a;display:flex;align-items:center;justify-content:center;gap:8px;}
  .emailpass{background:#1a73e8;color:white;}
  .muted{color:#64748b;font-size:.9rem;margin-top:8px;}
  .sep{display:flex;align-items:center;gap:8px;margin:12px 0;color:#94a3b8;}
  .sep:before,.sep:after{content:"";flex:1;height:1px;background:#e2e8f0;}
</style>
</head>
<body>
<div class="card">
  <h2>OCSI IT Inventory</h2>
  <p class="muted">Sign in with your school Google account.</p>

  <!-- GOOGLE SSO -->
  <button id="googleBtn" class="google">
    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"/>
    Sign in with Google
  </button>

  <div class="sep">or</div>

  <!-- EMAIL/PASSWORD fallback -->
  <input id="email" type="email" placeholder="Email"/>
  <input id="pass" type="password" placeholder="Password"/>
  <button id="loginBtn" class="emailpass">Login with Email</button>

  <div id="msg" class="muted"></div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
  import {
    getAuth, onAuthStateChanged,
    signInWithEmailAndPassword,
    GoogleAuthProvider, signInWithPopup, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };

  const app=initializeApp(firebaseConfig);
  try{getAnalytics(app);}catch(e){}
  const auth=getAuth(app);
  const db=getFirestore(app);

  const msg=document.getElementById("msg");
  const SCHOOL_DOMAIN="ocsi.school"; // <-- change to your real domain

  onAuthStateChanged(auth,u=>{
    if(u) location.href="index.html";
  });

  // ---- Google SSO ----
  document.getElementById("googleBtn").addEventListener("click", async ()=>{
    msg.textContent="";
    try{
      const provider=new GoogleAuthProvider();
      provider.setCustomParameters({ prompt: "select_account" });

      const res=await signInWithPopup(auth, provider);
      const user=res.user;

      // Domain restriction
      const email=user.email || "";
      if(!email.endsWith("@"+SCHOOL_DOMAIN)){
        await signOut(auth);
        msg.textContent="Please use your school Google account only.";
        return;
      }

      // Create user doc if missing (default role viewer)
      const userRef=doc(db,"users",user.uid);
      const userSnap=await getDoc(userRef);

      if(!userSnap.exists()){
        await setDoc(userRef,{
          email: user.email,
          name: user.displayName || "",
          role: "viewer",           // default role
          createdAt: serverTimestamp(),
          lastLoginAt: serverTimestamp()
        });
      } else {
        await setDoc(userRef,{
          lastLoginAt: serverTimestamp()
        }, { merge:true });
      }

      location.href="index.html";
    }catch(e){
      msg.textContent="Google sign-in failed: "+e.message;
    }
  });

  // ---- Email/Password fallback ----
  document.getElementById("loginBtn").addEventListener("click", async ()=>{
    msg.textContent="";
    const email=document.getElementById("email").value.trim();
    const pass=document.getElementById("pass").value.trim();
    try{
      await signInWithEmailAndPassword(auth,email,pass);
      location.href="index.html";
    }catch(e){
      msg.textContent="Login failed: "+e.message;
    }
  });
</script>
</body>
</html>
