<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Software Product Form • OCSI IT Inventory</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="topbar">
  <div>
    <div class="topbar-title">Software Product</div>
    <div class="topbar-sub">Create or update a software title</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <span id="roleBadge" class="badge viewer">…</span>
    <span id="who" style="opacity:.85;">Loading…</span>
    <button id="logoutBtn" class="logout">Logout</button>
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html">Dashboard</a>
      <a href="inventory-list.html">Inventory</a>
      <a class="active" href="software-dashboard.html">Software</a>
      <a href="admin-fields.html">Admin Fields</a>
      <a href="admin-categories.html">Admin Categories</a>
      <a href="admin-users.html">User Roles</a>
    </nav>
  </aside>

  <main class="content">
    <div class="card">
      <h3 id="formTitle">New Software Product</h3>
      <p class="muted" id="formSubtitle">
        Define software name, version, publisher, and category used across licenses and devices.
      </p>

      <form id="form">
        <label>Software Name</label>
        <input id="softwareName" required placeholder="e.g. Microsoft 365, Adobe Photoshop">

        <label>Version</label>
        <input id="version" placeholder="e.g. 2024, 16.0, Online">

        <label>Publisher</label>
        <input id="publisher" placeholder="e.g. Microsoft, Adobe, Google">

        <label>Category</label>
        <select id="softwareCategory">
          <option value="">Select category…</option>
          <option value="OS">OS</option>
          <option value="Office Suite">Office Suite</option>
          <option value="Security">Security</option>
          <option value="Educational">Educational</option>
          <option value="Utility">Utility</option>
          <option value="Other">Other</option>
        </select>

        <label>Lifecycle Status</label>
        <select id="lifecycleStatus">
          <option value="Active">Active</option>
          <option value="Deprecated">Deprecated</option>
          <option value="Retired">Retired</option>
        </select>

        <label>Description</label>
        <textarea id="description" placeholder="Short description of the software, usage, notes…"></textarea>

        <div class="spacer"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button type="submit" class="btn" id="saveBtn">Save</button>
          <a href="software-products.html" class="btn secondary">Back to Software List</a>
          <span id="status" class="muted"></span>
        </div>
      </form>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };

  const app=initializeApp(firebaseConfig);
  try{getAnalytics(app);}catch(e){}
  const auth=getAuth(app);
  const db=getFirestore(app);

  const ALLOWED_ROLES=["admin","it"]; // only Admin + IT

  function setBadge(role){
    const badge=document.getElementById("roleBadge");
    if(!badge) return;
    const r=(role||"viewer").toLowerCase();
    badge.className="badge "+r;
    badge.textContent=r.toUpperCase();
  }

  document.getElementById("logoutBtn").addEventListener("click",()=>{
    signOut(auth).then(()=>location.href="login.html");
  });

  function getId(){
    const p=new URLSearchParams(location.search);
    return p.get("id");
  }
  const id=getId();

  const form=document.getElementById("form");
  const statusEl=document.getElementById("status");
  const saveBtn=document.getElementById("saveBtn");
  const formTitle=document.getElementById("formTitle");
  const formSub=document.getElementById("formSubtitle");

  async function loadIfEditing(){
    if(!id) return;
    formTitle.textContent="Edit Software Product";
    formSub.textContent="Update software details. Changes will affect associated licenses.";
    const ref=doc(db,"software_product",id);
    const snap=await getDoc(ref);
    if(!snap.exists()){
      statusEl.textContent="Software not found.";
      return;
    }
    const s=snap.data();
    document.getElementById("softwareName").value   = s.softwareName || s.name || "";
    document.getElementById("version").value        = s.version || "";
    document.getElementById("publisher").value      = s.publisher || "";
    document.getElementById("softwareCategory").value = s.softwareCategory || "";
    document.getElementById("lifecycleStatus").value  = s.lifecycleStatus || "Active";
    document.getElementById("description").value    = s.description || "";
  }

  onAuthStateChanged(auth, async (u)=>{
    if(!u){location.href="login.html";return;}
    const who=document.getElementById("who");
    if(who) who.textContent=u.email||"";

    const us=await getDoc(doc(db,"users",u.uid));
    const role=us.exists()? (us.data().role||"viewer"):"viewer";
    setBadge(role);
    if(!ALLOWED_ROLES.includes(role)){
      alert("Only Admin or IT may manage software products.");
      location.href="software-products.html";
      return;
    }

    await loadIfEditing();
  });

  form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    statusEl.textContent="";
    saveBtn.disabled=true;
    saveBtn.textContent="Saving…";

    try{
      const data={
        softwareName: document.getElementById("softwareName").value.trim(),
        version:      document.getElementById("version").value.trim(),
        publisher:    document.getElementById("publisher").value.trim(),
        softwareCategory: document.getElementById("softwareCategory").value || "",
        lifecycleStatus:  document.getElementById("lifecycleStatus").value || "Active",
        description:  document.getElementById("description").value.trim(),
        updatedAt:    serverTimestamp()
      };
      if(!data.softwareName){
        statusEl.textContent="Software Name is required.";
        saveBtn.disabled=false;
        saveBtn.textContent="Save";
        return;
      }

      if(!id){
        const newRef=doc(collection(db,"software_product"));
        data.createdAt=serverTimestamp();
        await setDoc(newRef,data);
      }else{
        await updateDoc(doc(db,"software_product",id),data);
      }
      statusEl.textContent="Saved.";
      setTimeout(()=>location.href="software-products.html",800);
    }catch(err){
      statusEl.textContent="Error: "+err.message;
    }finally{
      saveBtn.disabled=false;
      saveBtn.textContent="Save";
    }
  });
</script>
</body>
</html>
