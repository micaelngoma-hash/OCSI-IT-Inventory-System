<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Software Dashboard</title>
<style>
  :root{
    --bg:#0f172a;
    --bg2:#111827;
    --brand:#1a73e8;
    --accent:#10b981;
    --warn:#f59e0b;
    --danger:#ef4444;
  }
  *{box-sizing:border-box;}
  body{
    margin:0;
    font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:#f3f4f6;
    color:#0f172a;
  }

  /* Top bar */
  .topbar{
    position:sticky;
    top:0;
    z-index:10;
    background:var(--bg);
    color:white;
    padding:10px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    box-shadow:0 2px 6px rgba(15,23,42,.5);
  }
  .topbar-title{
    font-weight:700;
    font-size:1.1rem;
  }
  .topbar-sub{
    font-size:.8rem;
    opacity:.7;
  }

  /* Layout */
  .layout{
    display:grid;
    grid-template-columns:230px 1fr;
    min-height:calc(100vh - 52px);
  }
  .sidebar{
    background:var(--bg2);
    color:white;
    padding:14px 10px;
  }
  .logo{
    font-weight:700;
    font-size:1rem;
    margin-bottom:10px;
    padding:0 8px;
  }
  .nav a{
    display:flex;
    align-items:center;
    gap:8px;
    padding:9px 10px;
    margin-bottom:5px;
    border-radius:8px;
    color:#d1d5db;
    text-decoration:none;
    font-size:.9rem;
  }
  .nav a span.icon{
    width:18px;
    text-align:center;
    opacity:.8;
  }
  .nav a:hover,
  .nav a.active{
    background:#1f2937;
    color:#fff;
  }

  .content{
    padding:18px 20px;
    max-width:1300px;
    width:100%;
    margin:0 auto;
  }

  .muted{color:#6b7280;font-size:.85rem;}
  .section-title{
    font-weight:600;
    margin-bottom:4px;
  }

  /* Summary tiles (top row) */
  .summary-row{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(210px,1fr));
    gap:14px;
    margin-bottom:18px;
  }
  .summary-card{
    background:white;
    border-radius:12px;
    padding:14px 16px;
    box-shadow:0 1px 3px rgba(15,23,42,.08);
    border:1px solid #e5e7eb;
    display:flex;
    flex-direction:column;
    justify-content:space-between;
  }
  .summary-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:8px;
    font-size:.85rem;
    text-transform:uppercase;
    letter-spacing:.06em;
    color:#6b7280;
  }
  .summary-icon{
    font-size:1.3rem;
    opacity:.7;
  }
  .summary-value{
    font-size:2rem;
    font-weight:700;
    color:#111827;
    text-align:left;
  }
  .summary-footer{
    font-size:.8rem;
    color:#6b7280;
    margin-top:4px;
  }
  .summary-link{
    font-size:.8rem;
    color:var(--brand);
    text-decoration:none;
    font-weight:500;
  }
  .summary-link:hover{text-decoration:underline;}

  /* Middle cards */
  .grid-2{
    display:grid;
    grid-template-columns:2fr 1.5fr;
    gap:16px;
  }
  @media(max-width:900px){
    .layout{grid-template-columns:1fr;}
    .sidebar{display:none;} /* optional: hide on mobile */
    .grid-2{grid-template-columns:1fr;}
  }
  .card{
    background:white;
    border-radius:12px;
    padding:14px 16px;
    border:1px solid #e5e7eb;
    box-shadow:0 1px 3px rgba(15,23,42,.08);
  }

  /* Seat usage mini chart */
  .usage-row{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-top:6px;
    font-size:.85rem;
    color:#4b5563;
  }
  .usage-bar-wrap{
    margin-top:10px;
    background:#e5e7eb;
    border-radius:999px;
    height:10px;
    overflow:hidden;
  }
  .usage-bar{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,var(--accent),var(--brand));
    transition:width .4s ease-out;
  }

  /* Quick links */
  .quick-list{
    margin-top:8px;
    display:grid;
    grid-template-columns:1fr;
    gap:8px;
    font-size:.85rem;
  }
  .quick-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:6px 0;
    border-bottom:1px solid #f3f4f6;
  }
  .quick-item:last-child{border-bottom:none;}
  .btn-link{
    padding:4px 9px;
    border-radius:6px;
    border:1px solid var(--brand);
    color:var(--brand);
    text-decoration:none;
    font-size:.78rem;
    font-weight:500;
  }
  .btn-link:hover{
    background:var(--brand);
    color:white;
  }
</style>
</head>
<body>

<div class="topbar">
  <div>
    <div class="topbar-title">Software Dashboard</div>
    <div class="topbar-sub">Licensing overview for OCSI IT Inventory</div>
  </div>
  <div id="who" style="opacity:.85;font-size:.85rem;">Loading‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <div class="logo">OCSI IT Inventory</div>
    <nav class="nav">
      <a href="index.html">
        <span class="icon">üè†</span><span>Main Dashboard</span>
      </a>
      <a class="active" href="#">
        <span class="icon">üíª</span><span>Software Dashboard</span>
      </a>
      <a href="software-products.html">
        <span class="icon">üì¶</span><span>Software Products</span>
      </a>
      <a href="software-licenses.html">
        <span class="icon">üßæ</span><span>License Pools</span>
      </a>
      <a href="assign-license.html">
        <span class="icon">üé´</span><span>Assign License</span>
      </a>
      <a href="software-compliance.html">
        <span class="icon">‚ö†Ô∏è</span><span>Compliance</span>
      </a>
    </nav>
  </aside>

  <main class="content">
    <!-- TOP SUMMARY TILES -->
    <div class="summary-row">

      <div class="summary-card">
        <div class="summary-header">
          <span>Software Products</span>
          <span class="summary-icon">üì¶</span>
        </div>
        <div class="summary-value" id="prodCount">--</div>
        <div class="summary-footer">
          Tracked titles in the catalog.<br>
          <a class="summary-link" href="software-products.html">Open product list ‚Üí</a>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-header">
          <span>License Pools</span>
          <span class="summary-icon">üßæ</span>
        </div>
        <div class="summary-value" id="licCount">--</div>
        <div class="summary-footer">
          Grouped licenses for each vendor/product.<br>
          <a class="summary-link" href="software-licenses.html">View all licenses ‚Üí</a>
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-header">
          <span>Available Seats</span>
          <span class="summary-icon">üéü</span>
        </div>
        <div class="summary-value" id="availSeats">--</div>
        <div class="summary-footer">
          Remaining seats across all license pools.
        </div>
      </div>

      <div class="summary-card">
        <div class="summary-header">
          <span>Compliance Alerts</span>
          <span class="summary-icon">‚ö†Ô∏è</span>
        </div>
        <div class="summary-value" id="alerts">--</div>
        <div class="summary-footer">
          Expiring soon or over-assigned.<br>
          <a class="summary-link" href="software-compliance.html">Open compliance view ‚Üí</a>
        </div>
      </div>

    </div>

    <!-- SECOND ROW: usage + quick links -->
    <div class="grid-2">
      <div class="card">
        <div class="section-title">Seat Usage</div>
        <p class="muted">
          Overview of total vs assigned seats for all license pools.
        </p>
        <div class="usage-row">
          <div>Total seats: <strong id="seatTotal">--</strong></div>
          <div>Assigned: <strong id="seatUsed">--</strong></div>
        </div>
        <div class="usage-row" style="margin-top:4px;">
          <div class="muted">Utilization</div>
          <div id="seatUsage" class="muted">--</div>
        </div>
        <div class="usage-bar-wrap">
          <div class="usage-bar" id="seatUsageBar"></div>
        </div>
      </div>

      <div class="card">
        <div class="section-title">Quick Actions</div>
        <p class="muted">Frequently used pages for software management.</p>

        <div class="quick-list">
          <div class="quick-item">
            <span>Register a new software product</span>
            <a href="software-products.html" class="btn-link">Open Products</a>
          </div>
          <div class="quick-item">
            <span>Create or update a license pool</span>
            <a href="software-licenses.html" class="btn-link">License Pools</a>
          </div>
          <div class="quick-item">
            <span>Assign a license to a user or device</span>
            <a href="assign-license.html" class="btn-link">Assign License</a>
          </div>
          <div class="quick-item">
            <span>Review compliance (expiry / overuse)</span>
            <a href="software-compliance.html" class="btn-link">Compliance View</a>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth= getAuth(app);

  // ‚úÖ Viewer allowed
  const ALLOWED_ROLES=["admin","it","viewer"];

  const who        = document.getElementById("who");
  const prodCount  = document.getElementById("prodCount");
  const licCount   = document.getElementById("licCount");
  const availSeats = document.getElementById("availSeats");
  const alertsEl   = document.getElementById("alerts");

  const seatTotalEl = document.getElementById("seatTotal");
  const seatUsedEl  = document.getElementById("seatUsed");
  const seatUsageEl = document.getElementById("seatUsage");
  const seatBar     = document.getElementById("seatUsageBar");

  onAuthStateChanged(auth, async user=>{
    if(!user){ location.href="login.html"; return; }

    const uSnap = await getDoc(doc(db,"users",user.uid));
    const role  = uSnap.exists()? (uSnap.data().role||"viewer"):"viewer";

    if(!ALLOWED_ROLES.includes(role)){
      alert("Access denied.");
      location.href="index.html";
      return;
    }
    who.textContent = `${user.email} (${role})`;

    await loadStats();
  });

  function toDate(x){ return x?.toDate?.() || (x? new Date(x):null); }

  async function loadStats(){
    // Products
    const prodSnap = await getDocs(collection(db,"software_product"));
    prodCount.textContent = prodSnap.size;

    // Licenses
    const licSnap = await getDocs(collection(db,"software_license"));
    licCount.textContent = licSnap.size;

    let totalSeats=0, usedSeats=0, alertCount=0;
    const now   = new Date();
    const lim30 = new Date(now.getTime()+30*24*60*60*1000);

    licSnap.forEach(ds=>{
      const l = ds.data();
      totalSeats += Number(l.totalSeats||0);
      usedSeats  += Number(l.assignedSeats||0);

      if(Number(l.totalSeats||0)>0 &&
         Number(l.assignedSeats||0)>Number(l.totalSeats||0)) alertCount++;

      const exp = toDate(l.expiryDate);
      if(exp && exp<=lim30) alertCount++;
    });

    const available = Math.max(0,totalSeats-usedSeats);
    availSeats.textContent = available;
    alertsEl.textContent   = alertCount;

    // Seat usage card
    seatTotalEl.textContent = totalSeats;
    seatUsedEl.textContent  = usedSeats;
    const pct = totalSeats>0 ? Math.round(usedSeats*100/totalSeats) : 0;
    seatUsageEl.textContent = `${pct}% used`;
    seatBar.style.width     = `${pct}%`;
  }
</script>

</body>
</html>
