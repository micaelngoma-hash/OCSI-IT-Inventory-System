<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory – Software Dashboard</title>

<style>
  :root{ --bg:#0f172a; --bg2:#0b1020; --brand:#1a73e8; --border:#e5e7eb; }
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    background:var(--bg);color:white;padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .sidebar{background:var(--bg2);padding:14px;color:white;}
  .content{padding:28px;max-width:1300px;margin:0 auto;width:100%;}

  h1{margin:0 0 20px;font-size:1.6rem;}

  .grid{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(240px,1fr));
    gap:18px;
  }

  .card{
    background:white;border-radius:14px;
    padding:22px;border:1px solid var(--border);
    display:flex;flex-direction:column;
    gap:6px;box-shadow:0 2px 8px rgba(0,0,0,.05);
  }

  .card h3{
    margin:0;font-size:1rem;color:#475569;
    font-weight:600;
  }

  .stat{
    font-size:2.6rem;font-weight:800;color:#0f172a;
  }

  .muted{
    color:#64748b;font-size:.9rem;
  }

  .btn{
    margin-top:8px;padding:8px 12px;
    background:var(--brand);color:white;
    border-radius:8px;text-decoration:none;
    font-size:.85rem;width:max-content;
  }
</style>

</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> – Software Dashboard</div>
  <div id="who" style="font-size:.85rem;opacity:.8;">Checking session…</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">
    <h1>Software Overview</h1>

    <div class="grid">
      <div class="card">
        <h3>Software Products</h3>
        <div class="stat" id="prodCount">--</div>
        <div class="muted">Tracked titles</div>
        <a href="software-licenses.html" class="btn">Manage Software</a>
      </div>

      <div class="card">
        <h3>Licenses</h3>
        <div class="stat" id="licCount">--</div>
        <div class="muted">License pools in inventory</div>
        <a href="software-licenses.html" class="btn">Open Licenses</a>
      </div>

      <div class="card">
        <h3>Available Seats</h3>
        <div class="stat" id="availSeats">--</div>
        <div class="muted">Seats not yet assigned</div>
      </div>

      <div class="card">
        <h3>Compliance Alerts</h3>
        <div class="stat" id="alerts">--</div>
        <div class="muted">Expiring/over-assigned licenses</div>
        <a href="software-licenses.html" class="btn">View Compliance</a>
      </div>
    </div>

  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const who           = document.getElementById("who");
  const prodCount     = document.getElementById("prodCount");
  const licCount      = document.getElementById("licCount");
  const availSeats    = document.getElementById("availSeats");
  const alerts        = document.getElementById("alerts");

  watchAuth({
    allowedRoles:["admin","it","viewer"],
    whoEl: who,
    onReady: loadStats
  });

  function toDate(x){
    return x?.toDate?.() || (x ? new Date(x) : null);
  }

  async function loadStats(){
    const prodSnap = await getDocs(collection(db,"software_product"));
    const licSnap  = await getDocs(collection(db,"software_license"));

    prodCount.textContent = prodSnap.size;
    licCount.textContent  = licSnap.size;

    let totalSeats=0, usedSeats=0, alertCount=0;

    const now = new Date();
    const lim30 = new Date(now.getTime() + 30*24*60*60*1000);

    licSnap.forEach(ds=>{
      const l = ds.data();
      totalSeats += Number(l.totalSeats||0);
      usedSeats  += Number(l.assignedSeats||0);

      if( Number(l.assignedSeats||0) > Number(l.totalSeats||0) )
        alertCount++;

      const exp = toDate(l.expiryDate);
      if(exp && exp <= lim30) alertCount++;
    });

    availSeats.textContent = Math.max(0, totalSeats - usedSeats);
    alerts.textContent = alertCount;
  }
</script>

</body>
</html>
