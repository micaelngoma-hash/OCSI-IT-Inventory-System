<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate QR Code ‚Äì OCSI IT Inventory</title>
    <style>
        /* --- UI STYLES (Screen) --- */
        body { 
            font-family: system-ui, sans-serif; background: #f5f7fb; margin: 0; 
            display: flex; align-items: center; justify-content: center; height: 100vh; overflow: hidden; 
        }
        .page-container { width: 100%; max-width: 420px; padding: 10px; text-align: center; }

        /* Larger Preview on Screen */
        .label-preview-box {
            background: white; margin: 0 auto 20px;
            border-radius: 8px; border: 1px solid #cbd5e1;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 3.5in; height: 2in; 
            padding: 15px;
            box-sizing: border-box;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        #assetId { 
            margin: 0 0 10px 0; color: #000; font-weight: 800; 
            font-size: 1.3rem; width: 100%; text-align: center;
        }

        #qrBox { width: 100%; display: flex; justify-content: center; }
        #qrBox canvas { height: auto !important; width: 1.4in !important; display: block; } 

        /* Buttons */
        .controls-card { background: white; padding: 20px; border-radius: 12px; border: 1px solid #e5e7eb; }
        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        button { 
            padding: 12px; border-radius: 8px; border: none; cursor: pointer; 
            font-size: .95rem; font-weight: 600; display: inline-flex; align-items: center; justify-content: center; gap: 8px; 
        }
        .btn-primary { background: #1a73e8; color: white; }
        .btn-success { background: #16a34a; color: white; }
        .btn-ghost { background: #f1f5f9; color: #334155; }

        /* --- CRITICAL PRINT LOGIC (Strict 1-Page Fix) --- */
        @media print {
            @page { size: 2in 1in; margin: 0; }
            html, body { height: 1in; overflow: hidden; margin: 0; padding: 0; }
            body * { visibility: hidden; }
            #labelContainer, #labelContainer * { visibility: visible; }
            #labelContainer {
                position: fixed; left: 0; top: 0;
                width: 2in !important; height: 1in !important;
                max-height: 1in !important; 
                margin: 0 !important; padding: 0 !important;
                display: flex !important; flex-direction: column !important;
                align-items: center !important; justify-content: center !important;
                border: none !important;
                overflow: hidden !important;
            }
            #assetId { 
                font-size: 10pt !important; 
                margin-bottom: 2px !important; 
                font-weight: bold !important;
            }
            #qrBox canvas { 
                width: 0.72in !important; height: 0.72in !important; 
            }
        }
    </style>
</head>
<body>

<div class="page-container">
    <div id="labelContainer" class="label-preview-box">
        <div id="assetId"></div>
        <div id="qrBox"></div>
    </div>

    <div class="controls-card">
        <div class="btn-group">
            <button onclick="window.print()" class="btn-success">üñ®Ô∏è Print Label (2x1")</button>
            <button id="btnDownload" class="btn-primary">‚¨áÔ∏è Download High-Res PNG</button>
            <button onclick="goBack()" class="btn-ghost">‚¨Ö Back to Device</button>
        </div>
    </div>
</div>

<script type="module">
    import QRCode from 'https://cdn.skypack.dev/qrcode';
    import { db } from "./firebase.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const assetEl = document.getElementById("assetId");
    const qrBox = document.getElementById("qrBox");

    document.addEventListener("DOMContentLoaded", async () => {
        const params = new URLSearchParams(location.search);
        const itemId = params.get("id");

        if (!itemId) { assetEl.textContent = "ID Missing"; return; }

        try {
            const snap = await getDoc(doc(db, "items", itemId));
            if (!snap.exists()) { assetEl.textContent = "Not Found"; return; }

            const d = snap.data();
            const assetId = d.assetId || "No ID";
            assetEl.innerHTML = `<strong>Asset ID: ${assetId}</strong>`;

            const url = `${window.location.origin}/item.html?id=${itemId}`;
            
            // Base canvas with high internal resolution
            QRCode.toCanvas(url, { 
                width: 800, 
                margin: 2, 
                errorCorrectionLevel: 'H' 
            }, (err, canvas) => {
                if (err) throw err;
                qrBox.innerHTML = '';
                qrBox.appendChild(canvas);
                
                // HIGH QUALITY PNG LOGIC
                document.getElementById("btnDownload").onclick = () => {
                    const downloadCanvas = document.createElement("canvas");
                    const ctx = downloadCanvas.getContext("2d", { alpha: false });
                    
                    // 2400x1200 for maximum print sharpness
                    downloadCanvas.width = 2400;
                    downloadCanvas.height = 1200;
                    
                    ctx.imageSmoothingEnabled = true;
                    ctx.imageSmoothingQuality = 'high';
                    
                    ctx.fillStyle = "white";
                    ctx.fillRect(0, 0, downloadCanvas.width, downloadCanvas.height);
                    
                    ctx.fillStyle = "black";
                    ctx.font = "bold 120px sans-serif";
                    ctx.textAlign = "center";
                    ctx.fillText(`Asset ID: ${assetId}`, 1200, 220);
                    
                    const qrSize = 800;
                    const xPos = (downloadCanvas.width - qrSize) / 2;
                    const yPos = 320;
                    ctx.drawImage(canvas, xPos, yPos, qrSize, qrSize);
                    
                    const link = document.createElement('a');
                    link.download = `Label-${assetId}.png`;
                    link.href = downloadCanvas.toDataURL("image/png", 1.0);
                    link.click();
                };
            });

        } catch (err) {
            console.error(err);
            assetEl.textContent = "Error loading data";
        }
    });

    // Updated to go back to item details
    window.goBack = () => {
        const params = new URLSearchParams(location.search);
        const itemId = params.get("id");
        if (itemId) window.location.href = `item.html?id=${itemId}`;
        else history.back();
    };
</script>
</body>
</html>
