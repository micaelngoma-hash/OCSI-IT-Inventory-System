<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Generate QR Code – OCSI IT Inventory</title>
<style>
body {
  font-family: system-ui, sans-serif;
  background: #f5f7fb;
  padding: 30px;
  text-align: center;
}
.card {
  background: white;
  padding: 20px;
  max-width: 420px;
  margin: 0 auto;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
}
#qrBox svg {
  width: 100%;
  height: auto;
}
button {
  padding: 10px 18px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: .9rem;
  margin: 10px;
}
.btn-primary {
  background: #1a73e8;
  color: white;
}
.btn-ghost {
  background:white;
  border:1px solid #cbd5e1;
}
</style>

<script type="module">
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.esm.js"; [web:1]
import { db } from "./firebase.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const itemId = params.get("id");

  const nameEl = document.getElementById("deviceName");
  const assetEl = document.getElementById("assetId");
  const qrBox = document.getElementById("qrBox");
  const btnDL = document.getElementById("btnDownload");

  if (!itemId) {
    nameEl.textContent = "Missing item ID";
    return;
  }

  try {
    const snap = await getDoc(doc(db, "items", itemId));
    if (!snap.exists()) {
      nameEl.textContent = "Item not found";
      return;
    }

    const d = snap.data();
    nameEl.textContent = d.deviceName || "Unnamed Device";
    assetEl.textContent = d.assetId || "(no asset ID)";

    const url = `${location.origin}/item.html?id=${itemId}`;
    const svgCode = await QRCode.toString(url, {
      type: "svg",
      margin: 2,
      scale: 12,
      errorCorrectionLevel: "H"
    }); [web:1]

    qrBox.innerHTML = svgCode;

    btnDL.onclick = () => {
      const blob = new Blob([svgCode], { type: "image/svg+xml" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `OCSI-${itemId}.svg`;
      a.click();
    };
  } catch (err) {
    console.error(err);
    nameEl.textContent = "Error loading QR code";
  }
});
</script>
</head>
<body>
<h1>QR Code for Device</h1>
<div class="card">
  <h2 id="deviceName">Loading...</h2>
  <p style="color:#555">Asset ID: <span id="assetId"></span></p>
  <div id="qrBox" style="margin:20px 0;"></div>
  <button id="btnDownload" class="btn-primary">⬇️ Download QR (SVG)</button>
  <button onclick="history.back()" class="btn-ghost">Back</button>
</div>
</body>
</html>
