<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory â€“ Device Details</title>
<style>
:root{--bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;--success:#22c55e;--danger:#ef4444;}
*{box-sizing:border-box;}
body{margin:0;font-family:system-ui;background:#f5f7fb;}
.topbar{position:sticky;top:0;z-index:20;background:var(--bg);color:white;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;}
.layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 52px);}
.sidebar{background:var(--bg2);color:white;padding:14px;}
.content{padding:18px;max-width:1100px;margin:0 auto;width:100%;}
h1{margin:0 0 6px;font-size:1.4rem;}
.sub{color:#64748b;font-size:.9rem;margin-bottom:12px;}
.toolbar{display:flex;justify-content:flex-end;gap:8px;margin-bottom:12px;flex-wrap:wrap;}
.btn{border:none;cursor:pointer;padding:6px 12px;border-radius:999px;font-size:.85rem;font-weight:500;text-decoration:none;display:inline-flex;align-items:center;gap:6px;}
.btn-primary{background:var(--brand);color:white;}.btn-success{background:var(--success);color:white;}.btn-ghost{background:white;color:#0f172a;border:1px solid #cbd5e1;}
.btn-danger{background:var(--danger);color:white;}
.card{background:white;border:1px solid var(--border);border-radius:12px;padding:14px 16px;margin-bottom:12px;}
.card h2{margin:0 0 8px;font-size:1.05rem;}
.grid-2{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:6px 16px;}
.field-label{font-size:.78rem;color:#94a3b8;}.field-value{font-size:.92rem;color:#0f172a;}
.status-pill{display:inline-flex;align-items:center;gap:6px;padding:3px 9px;border-radius:999px;font-size:.78rem;background:#e5f3ff;color:#1d4ed8;}
.notes{white-space:pre-wrap;font-size:.92rem;color:#0f172a;margin-top:4px;}
@media(max-width:768px){.layout{grid-template-columns: 1fr;}.sidebar{display:none;}.toolbar{justify-content: flex-start;}}
</style>
</head>
<body>
<div class="topbar"><div><strong>OCSI IT Inventory</strong> â€“ Device Details</div><div id="who">Checking sessionâ€¦</div></div>
<div class="layout">
<aside class="sidebar" id="sidebar-root">
    <nav style="display:flex; flex-direction:column; gap:10px;">
        <a href="index.html" style="color:white; text-decoration:none;">ğŸ“Š Dashboard</a>
        <a href="inventory-list.html" style="color:white; text-decoration:none;">ğŸ’» Inventory</a>
        <a href="scan.html" style="color:white; text-decoration:none;">ğŸ“± QR Scanner</a>
    </nav>
</aside>
<main class="content">
<h1 id="title">Device</h1><div class="sub" id="subtitle">Loading deviceâ€¦</div>
<div class="toolbar">
<a href="scan.html" class="btn btn-success">ğŸ“± Scan Another</a>
<a id="editLink" class="btn btn-primary">âœï¸ Edit</a>
<a id="qrLink" class="btn btn-ghost">ğŸ“ QR Code</a>
<button id="btnDelete" class="btn btn-danger" style="display:none;">ğŸ—‘ï¸ Delete</button>
<button class="btn btn-ghost" onclick="window.location.href='inventory-list.html'">â¬… Back</button>
</div>

<section class="card"><h2>Identification</h2><div class="grid-2">
<div><div class="field-label">Asset ID</div><div id="f_assetId" class="field-value">â€“</div></div>
<div><div class="field-label">Device Name</div><div id="f_deviceName" class="field-value">â€“</div></div>
<div><div class="field-label">Asset Type</div><div id="f_assetType" class="field-value">â€“</div></div>
<div><div class="field-label">Manufacturer</div><div id="f_manufacturer" class="field-value">â€“</div></div>
<div><div class="field-label">Serial Number</div><div id="f_serialNumber" class="field-value">â€“</div></div>
<div><div class="field-label">Status</div><span id="f_status" class="status-pill">â€“</span></div>
</div></section>

<section class="card"><h2>Location & Assignment</h2><div class="grid-2">
<div><div class="field-label">Assigned To</div><div id="f_assignedTo" class="field-value">â€“</div></div>
<div><div class="field-label">Department</div><div id="f_department" class="field-value">â€“</div></div>
<div><div class="field-label">Location</div><div id="f_location" class="field-value">â€“</div></div>
<div><div class="field-label">Building / Floor</div><div id="f_buildingFloor" class="field-value">â€“</div></div>
</div></section>

<section class="card"><h2>Network & System</h2><div class="grid-2">
<div><div class="field-label">IP Address</div><div id="f_ipAddress" class="field-value">â€“</div></div>
<div><div class="field-label">MAC Address</div><div id="f_macAddress" class="field-value">â€“</div></div>
<div><div class="field-label">OS Version</div><div id="f_osVersion" class="field-value">â€“</div></div>
</div></section>
<section class="card"><h2>Notes</h2><div id="f_notes" class="notes">No notes recorded.</div></section>
</main>
</div>

<script src="sidebar.js"></script>
<script type="module">
import { db, watchAuth, logAudit } from "./firebase.js";
import { doc, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const params = new URLSearchParams(location.search);
const itemId = params.get("id");
const qrLink = document.getElementById("qrLink");
const editLink = document.getElementById("editLink");
const btnDelete = document.getElementById("btnDelete");

watchAuth({
    allowedRoles: ["admin", "it", "viewer"],
    whoEl: document.getElementById("who"),
    onReady: async (user, role) => {
        if (!itemId) {
            alert("No Device ID provided.");
            window.location.href = "inventory-list.html";
            return;
        }

        // Use current URL structure to avoid 404s on GitHub Pages
        qrLink.href = `generate-qr.html?id=${encodeURIComponent(itemId)}`;
        
        // UI Permissions based on role
        if (role === "viewer") { 
            editLink.style.display = "none"; 
            btnDelete.style.display = "none";
        } else { 
            editLink.href = `item-form.html?id=${encodeURIComponent(itemId)}`; 
            btnDelete.style.display = "inline-flex";
        }

        try {
            // Updated to "items" collection
            const snap = await getDoc(doc(db, "items", itemId));
            if (snap.exists()) {
                const d = snap.data();
                
                // Map fields exactly as seen in Firestore
                document.getElementById("title").textContent = d.deviceName || d.assetId || "Unnamed Device";
                document.getElementById("subtitle").textContent = d.assetType || "Hardware Item";
                document.getElementById("f_assetId").textContent = d.assetId || "â€“";
                document.getElementById("f_deviceName").textContent = d.deviceName || "â€“";
                document.getElementById("f_assetType").textContent = d.assetType || "â€“";
                document.getElementById("f_manufacturer").textContent = d.manufacturer || "â€“";
                document.getElementById("f_serialNumber").textContent = d.macAddress || "â€“"; // Assuming Mac is serial or needs mapping
                document.getElementById("f_status").textContent = d.status || "â€“";
                document.getElementById("f_assignedTo").textContent = d.assignedTo || "â€“";
                document.getElementById("f_department").textContent = d.department || "â€“";
                document.getElementById("f_location").textContent = d.location || "â€“";
                document.getElementById("f_buildingFloor").textContent = d.buildingFloor || "â€“";
                document.getElementById("f_ipAddress").textContent = d.ipAddress || "â€“";
                document.getElementById("f_macAddress").textContent = d.macAddress || "â€“";
                document.getElementById("f_osVersion").textContent = d.osVersion || "â€“";
                document.getElementById("f_notes").textContent = d.notes || "No notes recorded.";

                await logAudit("view", d.assetId || itemId, `Viewed device details.`);

                btnDelete.onclick = async () => {
                    if (confirm(`Delete ${d.assetId || 'this device'}?`)) {
                        try {
                            await deleteDoc(doc(db, "items", itemId));
                            await logAudit("delete", d.assetId || itemId, `Deleted device.`);
                            alert("Deleted.");
                            location.href = "inventory-list.html";
                        } catch (err) { alert("Error deleting."); }
                    }
                };
            } else {
                document.getElementById("subtitle").innerHTML = "<b style='color:red;'>Device not found in 'items' collection.</b>";
            }
        } catch (err) {
            console.error(err);
            document.getElementById("subtitle").textContent = "Error loading data.";
        }
    }
});
</script>
</body>
</html>
