<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Generate QR Code ‚Äì OCSI IT Inventory</title>
<style>
body {
  font-family: system-ui, sans-serif;
  background: #f5f7fb;
  padding: 30px;
  text-align: center;
}
.card {
  background: white;
  padding: 20px;
  max-width: 420px;
  margin: 0 auto;
  border-radius: 14px;
  border: 1px solid #e5e7eb;
  box-shadow: 0 4px 14px rgba(0,0,0,0.1);
}
#qrBox svg {
  width: 100%;
  height: auto;
  max-width: 250px;
  margin: 0 auto;
}
button {
  padding: 10px 18px;
  border-radius: 999px;
  border: none;
  cursor: pointer;
  font-size: .9rem;
  margin: 5px;
  display: inline-flex;
  align-items: center;
  gap: 8px;
  font-weight: 500;
}
.btn-primary { background: #1a73e8; color: white; }
.btn-success { background: #16a34a; color: white; }
.btn-ghost { background: white; border: 1px solid #cbd5e1; color: #334155; }

/* PRINT STYLES: Only show the label content when printing */
@media print {
  body { background: white; padding: 0; margin: 0; }
  h1, button, .btn-ghost { display: none !important; }
  .card { 
    border: none; 
    box-shadow: none; 
    padding: 0; 
    margin-top: 20px;
    max-width: 100%; 
  }
  #qrBox svg { max-width: 300px; }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", async () => {
  const params = new URLSearchParams(location.search);
  const itemId = params.get("id");

  const nameEl = document.getElementById("deviceName");
  const assetEl = document.getElementById("assetId");
  const qrBox  = document.getElementById("qrBox");
  const btnDL  = document.getElementById("btnDownload");

  if (!itemId) {
    nameEl.textContent = "Missing item ID";
    return;
  }

  try {
    const snap = await getDoc(doc(db, "items", itemId));
    if (!snap.exists()) {
      nameEl.textContent = "Item not found";
      return;
    }

    const d = snap.data();
    nameEl.textContent  = d.deviceName || "Unnamed Device";
    assetEl.textContent = d.assetId    || "(no asset ID)";

    // Points the QR code to the details page
    const url = `${location.origin}/item.html?id=${itemId}`;

    const svgCode = await window.QRCode.toString(url, {
      type: "svg",
      margin: 2,
      scale: 12,
      errorCorrectionLevel: "H"
    });

    qrBox.innerHTML = svgCode;

    // Download Logic
    btnDL.onclick = () => {
      const blob = new Blob([svgCode], { type: "image/svg+xml" });
      const a    = document.createElement("a");
      a.href     = URL.createObjectURL(blob);
      a.download = `QR-${d.assetId || itemId}.svg`;
      a.click();
    };

  } catch (err) {
    console.error(err);
    nameEl.textContent = "Error loading QR code";
  }
});
</script>
</head>
<body>

<h1>Device QR Label</h1>

<div class="card">
  <h2 id="deviceName" style="margin-bottom:5px;">Loading...</h2>
  <p style="color:#64748b; margin-top:0;">Asset ID: <span id="assetId"></span></p>
  
  <div id="qrBox"></div>

  <div style="margin-top: 20px;">
    <button onclick="window.print()" class="btn-success">üñ®Ô∏è Print Label</button>
    <button id="btnDownload" class="btn-primary">‚¨áÔ∏è Download SVG</button>
    <button onclick="history.back()" class="btn-ghost">Back</button>
  </div>
</div>

</body>
</html>
