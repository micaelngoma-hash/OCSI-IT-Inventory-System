<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory – QR Scan Device</title>
<style>
  :root{ --bg:#0f172a; --bg2:#0b1020; --brand:#1a73e8; --border:#e5e7eb; }
  body{margin:0;font-family:system-ui;background:#f5f7fb;}
  .topbar{
    background:var(--bg);color:white;padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
    position:sticky;top:0;z-index:20;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .sidebar{background:var(--bg2);padding:16px;color:white;}
  .content{padding:22px;max-width:700px;margin:0 auto;}

  #preview{
    width:100%;border-radius:12px;
    box-shadow:0 2px 10px rgba(0,0,0,.15);
    margin-bottom:14px;
  }
  .btn{
    padding:10px 18px;border-radius:999px;
    background:var(--brand);color:white;
    text-decoration:none;border:none;cursor:pointer;
    font-size:1rem;
  }
  #status{
    margin-top:12px;font-size:1.05rem;color:#334155;
  }
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> – QR Scan Device</div>
  <div id="who" style="opacity:.8;font-size:.85rem;">Checking session…</div>
</div>

<div class="layout">
  <aside id="sidebar-root" class="sidebar"></aside>

  <main class="content">
    <h1>Scan QR Code</h1>
    <p>Point your camera at the device QR sticker.</p>

    <video id="preview" autoplay playsinline></video>

    <div id="status">Initializing camera…</div>
  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
  import { watchAuth } from "./firebase.js";

  // Permissions
  watchAuth({
    allowedRoles:["admin","it","viewer"],
    whoEl: document.getElementById("who"),
  });

  // Camera initialization
  const video = document.getElementById("preview");
  const status = document.getElementById("status");

  async function startCamera(){
    try{
      const stream = await navigator.mediaDevices.getUserMedia({ video:{ facingMode:"environment" }});
      video.srcObject = stream;
      status.textContent = "Point at a QR code…";
      startScanner();
    }catch(err){
      status.textContent = "Camera access blocked.";
    }
  }

  // Simple QR detection using barcode detector (Chrome/Android/iOS)
  async function startScanner(){
    if(!("BarcodeDetector" in window)){
      status.textContent = "QR scanning not supported in this browser.";
      return;
    }

    const detector = new BarcodeDetector({ formats:["qr_code"] });
    setInterval(async ()=>{
      try{
        const codes = await detector.detect(video);
        if(codes.length){
          const text = codes[0].rawValue;
          status.textContent = "QR detected → opening…";
          if(text.startsWith("device:")){
            const id = text.replace("device:","");
            location.href = `item.html?id=${encodeURIComponent(id)}`;
          }else{
            status.textContent = "Invalid QR code.";
          }
        }
      }catch(e){}
    }, 400);
  }

  startCamera();
</script>

</body>
</html>


