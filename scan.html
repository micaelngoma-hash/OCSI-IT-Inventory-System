<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory ‚Äì QR Scan Device</title>

<!-- QR Scanner library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  /* TOP BAR */
  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }

  /* PAGE LAYOUT */
  .layout{
    display:grid;
    grid-template-columns:240px 1fr;
    min-height:calc(100vh - 52px);
  }

  .sidebar{
    background:var(--bg2);color:white;padding:14px;
  }

  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .nav .icon{width:18px;text-align:center;opacity:.8;}

  .content{
    padding:18px;
    max-width:900px;
    margin:0 auto;
    width:100%;
  }

  /* HEADINGS */
  h1{margin:0 0 10px;font-size:1.45rem;}
  .sub{margin:0 0 16px;font-size:.9rem;color:#64748b;}

  /* SCAN BOX */
  #reader{
    width:100%;
    max-width:420px;
    margin:0 auto;
    border-radius:14px;
    overflow:hidden;
    background:white;
    border:1px solid var(--border);
  }

  .status{
    margin-top:12px;
    font-size:.9rem;
    text-align:center;
    color:#475569;
  }

  /* MANUAL SEARCH */
  .input-box{
    margin-top:24px;
    padding:14px;
    background:white;
    border:1px solid var(--border);
    border-radius:14px;
  }
  input{
    width:100%;
    padding:10px;
    border-radius:10px;
    border:1px solid var(--border);
    font-size:1rem;
    margin-top:6px;
  }
  .btn{
    margin-top:12px;
    padding:8px 14px;
    background:var(--brand);
    color:white;
    border:none;
    border-radius:999px;
    font-size:.9rem;
    cursor:pointer;
    width:100%;
  }
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì QR Scan Device</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üìä</span>Main Dashboard</a>
      <a href="software-dashboard.html"><span class="icon">üíª</span>Software Dashboard</a>
      <a href="software-licenses.html"><span class="icon">üîë</span>Licenses & Compliance</a>
      <a href="inventory-list.html"><span class="icon">üìã</span>Inventory List</a>
      <a class="active" href="scan.html"><span class="icon">üì±</span>QR Scan Device</a>
      <a href="admin-console.html"><span class="icon">‚öôÔ∏è</span>Admin Console</a>
      <a href="export.html"><span class="icon">‚¨áÔ∏è</span>Export</a>
      <a href="audits.html"><span class="icon">üïí</span>Audits</a>
      <a href="login.html"><span class="icon">üö™</span>Logout</a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <h1>Scan Device QR Code</h1>
    <p class="sub">Camera will start automatically. Point it at the device‚Äôs QR label.</p>

    <div id="reader"></div>
    <div id="scanStatus" class="status">Starting camera‚Ä¶</div>

    <div class="input-box">
      <label>Or manually enter Asset ID</label>
      <input id="manualId" placeholder="Example: LAPTOP-0453"/>
      <button class="btn" id="manualBtn">Open Device</button>
    </div>
  </main>

</div>

<script type="module">
  import { db, auth, watchAuth } from "./firebase.js";

  const whoEl = document.getElementById("who");
  const scanStatus = document.getElementById("scanStatus");

  // ------------------------------
  // AUTH CHECK
  // ------------------------------
  watchAuth({
    allowedRoles:["admin","it","viewer"],
    whoEl,
    onReady:()=> startScanner()
  });

  // ------------------------------
  // AUTO CAMERA START
  // ------------------------------
  let scanner;

  function startScanner(){
    scanner = new Html5Qrcode("reader");
    const config = { fps:10, qrbox:250 };

    Html5Qrcode.getCameras().then(cameras =>{
      if(cameras.length === 0){
        scanStatus.textContent = "No camera found.";
        return;
      }

      // Prefer rear camera
      let camId = cameras[0].id;
      const backCam = cameras.find(c => c.label.toLowerCase().includes("back"));
      if(backCam) camId = backCam.id;

      scanner.start(
        camId,
        config,
        qrText => onScanSuccess(qrText),
        () => {} // ignore decoding errors
      ).then(()=>{
        scanStatus.textContent = "Scanning‚Ä¶ Point at a QR code.";
      }).catch(err=>{
        scanStatus.textContent = "Camera error: " + err;
      });

    }).catch(err=>{
      scanStatus.textContent = "Camera access denied.";
    });
  }

  // ------------------------------
  // QR SUCCESS HANDLER
  // ------------------------------
  function onScanSuccess(text){
    scanner.stop();
    scanStatus.textContent = "QR detected!";
    const id = text.trim();
    location.href = `item.html?id=${encodeURIComponent(id)}`;
  }

  // ------------------------------
  // MANUAL SEARCH
  // ------------------------------
  document.getElementById("manualBtn").onclick = ()=>{
    const id = document.getElementById("manualId").value.trim();
    if(!id) return alert("Enter an Asset ID.");
    location.href = `item.html?id=${encodeURIComponent(id)}`;
  };
</script>

</body>
</html>
