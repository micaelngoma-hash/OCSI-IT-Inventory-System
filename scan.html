<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory â€“ QR Scan Device</title>

<!-- QR Scanner library -->
<script src="https://unpkg.com/html5-qrcode"></script>

<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }

  .layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 52px);}
  .sidebar{background:var(--bg2);color:white;padding:14px;}

  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;
    margin-bottom:6px;font-size:.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .nav .icon{width:18px;text-align:center;opacity:.8;}

  .content{padding:18px;max-width:900px;margin:0 auto;width:100%;}
  h1{margin:0 0 4px;font-size:1.4rem;}
  .sub{margin:0 0 16px;font-size:.9rem;color:#64748b;}

  #reader{
    width:100%;
    max-width:420px;
    margin:0 auto;
    border-radius:14px;
    overflow:hidden;
    background:white;
    border:1px solid var(--border);
  }

  .input-box{
    margin-top:20px;
    background:white;border:1px solid var(--border);
    padding:12px;border-radius:12px;
  }

  input{
    width:100%;padding:10px;
    border:1px solid var(--border);
    border-radius:8px;font-size:1rem;
  }

  .btn{
    margin-top:10px;
    display:inline-block;padding:8px 16px;
    background:var(--brand);color:white;
    border-radius:8px;text-decoration:none;
    cursor:pointer;font-size:.9rem;
    border:none;
  }

  .status{
    margin-top:8px;font-size:.88rem;color:#475569;
    text-align:center;
  }
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> â€“ QR Scan Device</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking sessionâ€¦</div>
</div>

<div class="layout">

  <!-- SIDEBAR EMBEDDED -->
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">ğŸ“Š</span>Main Dashboard</a>
      <a href="software-dashboard.html"><span class="icon">ğŸ’»</span>Software Dashboard</a>
      <a href="software-licenses.html"><span class="icon">ğŸ”‘</span>Licenses & Compliance</a>
      <a href="inventory-list.html"><span class="icon">ğŸ“‹</span>Inventory List</a>
      <a class="active" href="scan.html"><span class="icon">ğŸ“±</span>QR Scan Device</a>
      <a href="admin-console.html"><span class="icon">âš™ï¸</span>Admin Console</a>
      <a href="export.html"><span class="icon">â¬‡ï¸</span>Export</a>
      <a href="audits.html"><span class="icon">ğŸ•’</span>Audits</a>
      <a href="login.html"><span class="icon">ğŸšª</span>Logout</a>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="content">
    <h1>Scan Device QR Code</h1>
    <p class="sub">Point your camera at a device QR label. The scanner will open automatically.</p>

    <div id="reader"></div>
    <div class="status" id="scanStatus">Initializing cameraâ€¦</div>

    <div class="input-box">
      <label>Or manually enter asset ID:</label>
      <input id="manualId" placeholder="Example: DEV-00123"/>
      <button class="btn" id="manualBtn">Open Device</button>
    </div>
  </main>

</div>

<script type="module">
  import { db, auth, watchAuth } from "./firebase.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const whoEl = document.getElementById("who");
  const scanStatus = document.getElementById("scanStatus");

  // ------------------------------
  // AUTH PROTECTION
  // ------------------------------
  watchAuth({
    allowedRoles:["admin","it","viewer"],
    whoEl,
    onReady:()=>{ startScanner(); }
  });

  // ------------------------------
  // AUTO-START QR SCANNER
  // ------------------------------
  let scanner;

  function startScanner(){
    scanner = new Html5Qrcode("reader");

    const config = { fps: 10, qrbox: 250 };

    Html5Qrcode.getCameras().then(cameras => {
      if (cameras.length === 0){
        scanStatus.textContent = "No camera found.";
        return;
      }

      // Auto-select the first rear camera
      let camId = cameras[0].id;

      // prefer back camera when available
      const backCam = cameras.find(c => c.label.toLowerCase().includes("back"));
      if (backCam) camId = backCam.id;

      scanner.start(
        camId,
        config,
        qrText => onScanSuccess(qrText),
        () => {} // ignore scan failure spam
      ).then(()=>{
        scanStatus.textContent = "Scanningâ€¦ Point the camera at a QR code.";
      }).catch(err=>{
        scanStatus.textContent = "Camera error: " + err;
      });

    }).catch(err=>{
      scanStatus.textContent = "Camera access denied.";
    });
  }

  // ------------------------------
  // WHEN QR CODE IS DETECTED
  // ------------------------------
  function onScanSuccess(text){
    scanner.stop();
    scanStatus.textContent = "QR detected: " + text;

    const id = text.trim();
    location.href = `item.html?id=${encodeURIComponent(id)}`;
  }

  // ------------------------------
  // MANUAL LOOKUP
  // ------------------------------
  document.getElementById("manualBtn").onclick = ()=>{
    const id = document.getElementById("manualId").value.trim();
    if(!id) return alert("Enter an Asset ID.");
    location.href = `item.html?id=${encodeURIComponent(id)}`;
  };
</script>

</body>
</html>
