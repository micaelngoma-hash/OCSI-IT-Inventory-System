<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>License Details • OCSI IT Inventory</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
<div class="topbar">
  <div>
    <div class="topbar-title">License Details</div>
    <div class="topbar-sub">License pool and assignments</div>
  </div>
  <div style="display:flex;align-items:center;gap:8px;">
    <span id="roleBadge" class="badge viewer">…</span>
    <span id="who" style="opacity:.85;">Loading…</span>
    <button id="logoutBtn" class="logout">Logout</button>
  </div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html">Dashboard</a>
      <a href="inventory-list.html">Inventory</a>
      <a class="active" href="software-dashboard.html">Software</a>
      <a href="admin-fields.html">Admin Fields</a>
      <a href="admin-categories.html">Admin Categories</a>
      <a href="admin-users.html">User Roles</a>
    </nav>
  </aside>

  <main class="content">
    <div class="card">
      <h3 id="licenseTitle">Loading license…</h3>
      <p class="muted" id="licenseSub"></p>
      <div class="spacer"></div>
      <table>
        <tbody id="licenseBody"></tbody>
      </table>
      <div class="spacer"></div>
      <a id="editLink" class="btn small" href="#">Edit License</a>
      <a href="software-licenses.html" class="btn small secondary">Back to Licenses</a>
    </div>

    <div class="spacer"></div>

    <div class="card">
      <h4>Assignments</h4>
      <p class="muted">
        Where this license is currently assigned (devices or users).
      </p>
      <div class="spacer"></div>
      <table>
        <thead>
          <tr>
            <th>Device</th>
            <th>User</th>
            <th>Assignment Date</th>
          </tr>
        </thead>
        <tbody id="assignBody">
          <tr><td colspan="3" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-analytics.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, collection, getDocs,
    query, where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };

  const app=initializeApp(firebaseConfig);
  try{getAnalytics(app);}catch(e){}
  const auth=getAuth(app);
  const db=getFirestore(app);

  const ALLOWED_ROLES=["admin","it","viewer"];

  function setBadge(role){
    const badge=document.getElementById("roleBadge");
    if(!badge) return;
    const r=(role||"viewer").toLowerCase();
    badge.className="badge "+r;
    badge.textContent=r.toUpperCase();
  }

  document.getElementById("logoutBtn").addEventListener("click",()=>{
    signOut(auth).then(()=>location.href="login.html");
  });

  function getId(){
    const p=new URLSearchParams(location.search);
    return p.get("id");
  }
  const id=getId();

  const titleEl=document.getElementById("licenseTitle");
  const subEl  =document.getElementById("licenseSub");
  const bodyEl =document.getElementById("licenseBody");
  const assignBody=document.getElementById("assignBody");
  const editLink=document.getElementById("editLink");

  if(id){
    editLink.href=`software-license-form.html?id=${encodeURIComponent(id)}`;
  }else{
    editLink.style.display="none";
  }

  function fmtDate(ts){
    if(!ts) return "—";
    try{
      const d=ts.toDate ? ts.toDate() : new Date(ts);
      return d.toISOString().slice(0,10);
    }catch{return "—";}
  }

  async function loadLicense(){
    if(!id){
      titleEl.textContent="No license selected";
      bodyEl.innerHTML='<tr><td colspan="2" class="muted">Missing ?id parameter in URL.</td></tr>';
      return;
    }
    const snap=await getDoc(doc(db,"software_license",id));
    if(!snap.exists()){
      titleEl.textContent="License not found";
      bodyEl.innerHTML='<tr><td colspan="2" class="muted">This license does not exist.</td></tr>';
      return;
    }
    const l=snap.data();
    const name=l.softwareName || "Software license";
    titleEl.textContent=name;
    subEl.textContent = `Vendor: ${l.vendor || "—"} • Seats: ${l.assignedSeats||0}/${l.totalSeats||0}`;

    bodyEl.innerHTML = `
      <tr><th style="width:180px;">Software</th><td>${name}</td></tr>
      <tr><th>License Key</th><td>${l.licenseKey||"<span class='muted'>—</span>"}</td></tr>
      <tr><th>Total Seats</th><td>${l.totalSeats||0}</td></tr>
      <tr><th>Assigned Seats</th><td>${l.assignedSeats||0}</td></tr>
      <tr><th>Vendor</th><td>${l.vendor||"<span class='muted'>—</span>"}</td></tr>
      <tr><th>Cost</th><td>${l.cost!=null? l.cost : "<span class='muted'>—</span>"}</td></tr>
      <tr><th>Purchase Date</th><td>${fmtDate(l.purchaseDate)}</td></tr>
      <tr><th>Expiry Date</th><td>${fmtDate(l.expiryDate)}</td></tr>
    `;
  }

  async function loadAssignments(){
    if(!id){
      assignBody.innerHTML='<tr><td colspan="3" class="muted">No license selected.</td></tr>';
      return;
    }
    const qAssign=query(collection(db,"software_assignment"),where("softwareLicenseId","==",id));
    const snap=await getDocs(qAssign);
    if(snap.empty){
      assignBody.innerHTML='<tr><td colspan="3" class="muted">No assignments for this license.</td></tr>';
      return;
    }
    const assigns=snap.docs.map(d=>({id:d.id,...d.data()}));

    // Preload device names
    const deviceIds=[...new Set(assigns.map(a=>a.deviceId).filter(Boolean))];
    const deviceMap={};
    for(const did of deviceIds){
      const dsnap=await getDoc(doc(db,"items",did));
      if(dsnap.exists()){
        const it=dsnap.data();
        deviceMap[did]=it.deviceName || it.assetId || did;
      }
    }

    assignBody.innerHTML=assigns.map(a=>{
      const deviceName=a.deviceId ? (deviceMap[a.deviceId] || a.deviceId) : "—";
      const userLabel=a.userId || "—";
      const d=a.assignmentDate && a.assignmentDate.toDate
        ? a.assignmentDate.toDate().toISOString().slice(0,10)
        : "—";
      return `
        <tr>
          <td>${deviceName}</td>
          <td>${userLabel}</td>
          <td>${d}</td>
        </tr>
      `;
    }).join("");
  }

  onAuthStateChanged(auth, async (u)=>{
    if(!u){location.href="login.html";return;}
    const who=document.getElementById("who");
    if(who) who.textContent=u.email||"";

    const us=await getDoc(doc(db,"users",u.uid));
    const role=us.exists()? (us.data().role||"viewer"):"viewer";
    setBadge(role);

    if(!ALLOWED_ROLES.includes(role)){
      alert("Access denied for role: "+role);
      location.href="index.html";
      return;
    }

    await loadLicense();
    await loadAssignments();
  });
</script>
</body>
</html>
