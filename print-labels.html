<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Print QR Labels ‚Äì OCSI IT Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f5f7fb;
    margin: 0;
    padding: 20px;
  }
  h1 { margin-top: 0; font-size: 2rem; }
  .top-controls {
    background: white;
    padding: 14px 18px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin-bottom: 20px;
  }
  .layout-option {
    padding: 8px 16px;
    border-radius: 12px;
    border: 1px solid #cbd5e1;
    cursor: pointer;
    margin-right: 8px;
    background: white;
    font-size: .9rem;
  }
  .layout-option.active {
    background: #1a73e8;
    color: white;
    border-color: #1a73e8;
  }
  #status {
    background: white;
    padding: 12px;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    margin-bottom: 20px;
    text-align: center;
    font-weight: 500;
  }
  #labelsArea {
    display: grid;
    gap: 12px;
    justify-content: center;
  }
  .label {
    background: white;
    border: 1px solid #e5e7eb;
    padding: 12px;
    text-align: center;
    border-radius: 8px;
    width: 100%;
    page-break-inside: avoid;
  }
  .label svg {
    width: 100%;
    height: auto;
    display: block;
  }
  @media print {
    body { background: white; padding: 0; margin: 0; }
    .top-controls, #status { display: none !important; }
    #labelsArea { gap: 0; }
  }
  .grid-test {
    width: 100%;
    height: 90vh;
    border: 1px dashed #999;
    background-size: 20px 20px;
    background-image:
      linear-gradient(to right, #ccc 1px, transparent 1px),
      linear-gradient(to bottom, #ccc 1px, transparent 1px);
    page-break-inside: avoid;
  }
  .btn {
    padding:10px 22px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-weight:500;
    margin-right:10px;
  }
  .btn-primary { background:#1a73e8; color:white; }
  .btn-success { background:#16a34a; color:white; }
  .btn-secondary { background:#6b7280; color:white; }
</style>
</head>

<body>

<h1>Bulk QR Label Printing</h1>

<div class="top-controls">
  <strong>Choose label layout:</strong><br><br>

  <button id="btn6"  class="layout-option">6 per page (Large)</button>
  <button id="btn12" class="layout-option active">12 per page (Medium)</button>
  <button id="btn24" class="layout-option">24 per page (Small)</button>

  <br><br>

  <button id="btnPreview" class="btn btn-primary">üëÅÔ∏è Preview Labels</button>
  
  <button onclick="window.print()" class="btn btn-primary">
    üñ® Print Labels
  </button>

  <button id="btnPDF" class="btn btn-success">
    üìÑ Download PDF
  </button>

  <button id="btnTest" class="btn btn-secondary">
    üìê Print Test Grid
  </button>
</div>

<div id="status" style="display:none;"></div>

<div id="testGrid" style="display:none;">
  <div class="grid-test"></div>
</div>

<div id="labelsArea"></div>

<script type="module">
  import { db } from "./firebase.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebase-firestore.js";
  import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.esm.js";

  const labelsArea = document.getElementById("labelsArea");
  const statusEl = document.getElementById("status");
  const btnPreview = document.getElementById("btnPreview");
  const btnPDF = document.getElementById("btnPDF");
  const btnTest = document.getElementById("btnTest");
  const testGrid = document.getElementById("testGrid");

  const params = new URLSearchParams(location.search);
  const rawIds = params.get("ids") || "";
  const idList = rawIds.split(",").map(s => s.trim()).filter(Boolean);

  let layout = 12;
  let labelsData = [];
  updateGrid();

  // Layout buttons
  document.getElementById("btn6").onclick  = () => setLayout(6);
  document.getElementById("btn12").onclick = () => setLayout(12);
  document.getElementById("btn24").onclick = () => setLayout(24);

  function setLayout(n) {
    layout = n;
    document.querySelectorAll(".layout-option").forEach(b => b.classList.remove("active"));
    document.getElementById("btn" + n).classList.add("active");
    updateGrid();
    if (labelsData.length > 0) renderLabels();
  }

  function updateGrid() {
    labelsArea.style.gridTemplateColumns =
      layout === 6  ? "repeat(2, 1fr)" :
      layout === 12 ? "repeat(3, 1fr)" :
                      "repeat(4, 1fr)";
  }

  // Load data on page load
  loadData();

  async function loadData() {
    console.log("üîç Loading IDs:", idList);
    
    if (idList.length === 0) {
      statusEl.textContent = "No item IDs specified in URL.";
      statusEl.style.display = "block";
      statusEl.style.background = "#fee2e2";
      return;
    }

    statusEl.textContent = "Loading items...";
    statusEl.style.display = "block";
    statusEl.style.background = "#dbeafe";

    const items = [];
    for (const id of idList) {
      try {
        const snap = await getDoc(doc(db, "items", id));
        if (snap.exists()) {
          const data = snap.data();
          items.push({ id, ...data });
        }
      } catch (e) {
        console.error("Error fetching", id, ":", e);
      }
    }

    if (items.length === 0) {
      statusEl.textContent = "No items found. Check Firestore rules.";
      statusEl.style.background = "#fee2e2";
      return;
    }

    labelsData = items;
    statusEl.textContent = `Loaded ${items.length} labels. Click Preview to generate QR codes.`;
    statusEl.style.background = "#dcfce7";
    console.log("‚úÖ Loaded items:", items.length);
  }

  function renderLabels() {
    if (labelsData.length === 0) return;

    labelsArea.innerHTML = "";
    statusEl.style.display = "none";

    for (const item of labelsData) {
      const div = document.createElement("div");
      div.className = "label";

      // QR encodes ASSET ID only
      const qrText = item.assetId || item.id || "No ID";
      
      // Generate QR (async but we don't await here for preview speed)
      QRCode.toString(qrText, {
        type: "svg",
        margin: 0,
        scale: 8,  // Smaller for faster preview
        errorCorrectionLevel: "H"
      }).then(svg => {
        div.innerHTML = `
          <div>${svg}</div>
          <div style="font-size:.85rem;margin-top:4px;font-weight:600;">
            ${item.assetId || ""}
          </div>
          <div style="font-size:.7rem;color:#666;margin-top:2px;">
            ${item.deviceName || ""}
          </div>
        `;
        labelsArea.appendChild(div);
      }).catch(err => {
        console.error("QR Error:", err);
        div.innerHTML = `<div style="color:red;font-size:.7rem;">QR Error</div>`;
      });
    }
  }

  // Preview button - generates full quality QR codes
  btnPreview.onclick = async () => {
    console.log("üëÅÔ∏è Generating preview...");
    renderLabels();
  };

  // Fixed PDF Download
  btnPDF.onclick = async () => {
    if (labelsData.length === 0) {
      alert("No labels to export. Click Preview first.");
      return;
    }

    console.log("üìÑ Generating PDF...");
    await new Promise(r => setTimeout(r, 500)); // Wait for SVGs

    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF("p", "mm", "a4");
    
    // Higher quality for PDF
    for (let i = 0; i < labelsData.length; i += layout) {
      const pageLabels = labelsData.slice(i, i + layout);
      
      // Clear and regenerate high-quality SVGs
      labelsArea.innerHTML = "";
      for (const item of pageLabels) {
        const div = document.createElement("div");
        div.className = "label";
        const qrText = item.assetId || item.id || "No ID";
        
        const svg = await QRCode.toString(qrText, {
          type: "svg",
          margin: 0,
          scale: 12,  // High quality for PDF
          errorCorrectionLevel: "H"
        });
        
        div.innerHTML = `
          <div>${svg}</div>
          <div style="font-size:1rem;margin-top:6px;font-weight:600;">${item.assetId || ""}</div>
          <div style="font-size:.8rem;color:#444;">${item.deviceName || ""}</div>
        `;
        labelsArea.appendChild(div);
      }

      const canvas = await html2canvas(labelsArea, { 
        scale: 3,
        useCORS: true,
        allowTaint: true
      });
      
      const imgData = canvas.toDataURL('image/png');
      const imgWidth = 190;
      const pageHeight = 277;
      const imgHeight = (canvas.height * imgWidth) / canvas.width;
      const heightLeft = imgHeight > pageHeight ? imgHeight - pageHeight : 0;

      pdf.addImage(imgData, 'PNG', 10, 10, imgWidth, imgHeight);
      
      if (heightLeft > 0 && i + layout < labelsData.length) {
        pdf.addPage();
      }
    }
    
    pdf.save(`OCSI-QR-Labels-${new Date().toISOString().slice(0,10)}.pdf`);
  };

  // Test Grid
  btnTest.onclick = () => {
    labelsArea.style.display = "none";
    statusEl.style.display = "none";
    testGrid.style.display = "block";
    window.print();
    setTimeout(() => {
      testGrid.style.display = "none";
      labelsArea.style.display = "grid";
      statusEl.style.display = "block";
    }, 1000);
  };
</script>

</body>
</html>
