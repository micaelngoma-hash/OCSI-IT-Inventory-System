<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Print QR Labels â€“ OCSI IT Inventory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: system-ui, sans-serif; background: #f5f7fb; margin: 0; padding: 20px; }
        h1 { margin-top: 0; font-size: 2rem; }
        .top-controls {
            background: white; padding: 14px 18px; border-radius: 12px;
            border: 1px solid #e5e7eb; margin-bottom: 20px;
        }
        .layout-option {
            padding: 8px 16px; border-radius: 12px; border: 1px solid #cbd5e1;
            cursor: pointer; margin-right: 8px; background: white; font-size: .9rem;
        }
        .layout-option.active { background: #1a73e8; color: white; border-color: #1a73e8; }
        #labelsArea { display: grid; gap: 12px; justify-content: center; }
        .label {
            background: white; border: 1px solid #e5e7eb; padding: 12px;
            text-align: center; border-radius: 8px; width: 100%;
            box-sizing: border-box;
        }
        .label svg { width: 100% !important; height: auto !important; max-width: 150px; }
        
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .top-controls { display: none !important; }
        }
    </style>
</head>
<body>

<h1>Bulk QR Label Printing</h1>

<div class="top-controls">
    <strong>Choose label layout:</strong><br><br>
    <button id="btn6"  class="layout-option">6 per page (Large)</button>
    <button id="btn12" class="layout-option active">12 per page (Medium)</button>
    <button id="btn24" class="layout-option">24 per page (Small)</button>
    <br><br>
    <button onclick="window.print()" style="padding:10px 22px;border-radius:999px;background:#1a73e8;color:white;border:none;cursor:pointer;margin-right:10px;">
        ðŸ–¨ Print Labels
    </button>
    <button id="btnPDF" style="padding:10px 22px;border-radius:999px;background:#16a34a;color:white;border:none;cursor:pointer;">
        ðŸ“„ Download PDF
    </button>
</div>

<div id="labelsArea"></div>

<script type="module">
    // Modern Module Imports
    import QRCode from 'https://cdn.skypack.dev/qrcode';
    import { watchAuth, db } from "./firebase.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const labelsArea = document.getElementById("labelsArea");
    const btnPDF = document.getElementById("btnPDF");

    const params = new URLSearchParams(location.search);
    const idList = (params.get("ids") || "").split(",").filter(id => id.trim() !== "");

    let layout = 12;
    updateGrid();

    document.getElementById("btn6").onclick  = () => setLayout(6);
    document.getElementById("btn12").onclick = () => setLayout(12);
    document.getElementById("btn24").onclick = () => setLayout(24);

    function setLayout(n) {
        layout = n;
        document.querySelectorAll(".layout-option").forEach(b => b.classList.remove("active"));
        document.getElementById("btn" + n).classList.add("active");
        updateGrid();
    }

    function updateGrid() {
        labelsArea.style.gridTemplateColumns =
            layout === 6  ? "repeat(2, 1fr)" :
            layout === 12 ? "repeat(3, 1fr)" :
                            "repeat(4, 1fr)";
    }

    watchAuth({
        allowedRoles: ["admin", "it", "viewer"],
        whoEl: null,
        onReady: () => loadLabels()
    });

    async function loadLabels() {
        if (idList.length === 0) {
            labelsArea.innerHTML = "<p>No IDs provided in URL.</p>";
            return;
        }

        labelsArea.innerHTML = "<p>Loading labels...</p>";
        const items = [];

        for (const id of idList) {
            try {
                const snap = await getDoc(doc(db, "items", id));
                if (snap.exists()) {
                    items.push({ id, ...snap.data() });
                }
            } catch (err) {
                console.error("Firebase Error:", id, err);
            }
        }

        if (items.length === 0) {
            labelsArea.innerHTML = "<p>No matching items found in Database.</p>";
            return;
        }

        labelsArea.innerHTML = "";

        for (const item of items) {
            const div = document.createElement("div");
            div.className = "label";

            // The URL the QR code will point to
            const qrURL = `${window.location.origin}/item.html?id=${item.id}`;

            try {
                // Generate SVG using the imported QRCode module
                const svgString = await QRCode.toString(qrURL, {
                    type: 'svg',
                    margin: 2,
                    errorCorrectionLevel: 'H',
                    color: {
                        dark: '#000000',
                        light: '#ffffff'
                    }
                });

                div.innerHTML = `
                    <div class="qr-container">${svgString}</div>
                    <div style="font-size:.85rem; margin-top:8px; font-weight:700; color:#111;">
                        ${item.assetId || "No ID"}
                    </div>
                    <div style="font-size:.7rem; color:#666; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        ${item.deviceName || "Unnamed Device"}
                    </div>
                `;
            } catch (qrErr) {
                console.error("QR Error:", qrErr);
                div.innerHTML = `<p style="font-size:10px;">Error generating QR</p>`;
            }
            labelsArea.appendChild(div);
        }
    }

    // PDF Generation
    btnPDF.onclick = async () => {
        const { jsPDF } = window.jspdf;
        const canvas = await html2canvas(labelsArea, { scale: 2, useCORS: true });
        const imgData = canvas.toDataURL("image/png");
        
        const pdf = new jsPDF("p", "mm", "a4");
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("Inventory-Labels.pdf");
    };
</script>

</body>
</html>
