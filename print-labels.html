<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bulk Print QR Labels â€“ OCSI IT Inventory</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        body { font-family: system-ui, sans-serif; background: #f5f7fb; margin: 0; padding: 20px; }
        h1 { margin-top: 0; font-size: 1.8rem; color: #0f172a; }
        
        .top-controls {
            background: white; padding: 16px; border-radius: 12px;
            border: 1px solid #e5e7eb; margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .layout-option {
            padding: 8px 16px; border-radius: 12px; border: 1px solid #cbd5e1;
            cursor: pointer; margin-right: 8px; background: white; font-size: .9rem;
            font-weight: 600;
        }
        .layout-option.active { background: #1a73e8; color: white; border-color: #1a73e8; }
        
        #labelsArea { 
            display: grid; 
            gap: 20px; 
            justify-content: center; 
            background: white; 
            padding: 20px;
            border-radius: 8px;
        }

        /* The Label Design with 2mm Cutting Border */
        .label {
            background: white; 
            /* Light border for easy cutting */
            border: 1px solid #cbd5e1; 
            /* 2mm padding creates the safety gap between content and the cut line */
            padding: 2mm; 
            text-align: center; 
            border-radius: 4px; 
            width: 100%;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .label-id {
            font-size: 11pt;
            font-weight: 800;
            color: #000;
            margin-bottom: 4px;
            /* Ensures format matches "Asset ID: OCSI-XXXX" */
            white-space: nowrap; 
        }

        .qr-container {
            display: flex;
            justify-content: center;
            width: 100%;
        }

        .qr-container canvas {
            display: block;
            width: 100% !important;
            height: auto !important;
            /* Sized for high visibility on standard labels */
            max-width: 130px; 
        }
        
        @media print {
            body { background: white; padding: 0; margin: 0; }
            .top-controls, h1 { display: none !important; }
            #labelsArea { padding: 10mm; gap: 10px; }
            /* Keep the border visible for cutting on physical paper */
            .label { border: 1px solid #cccccc !important; } 
        }
    </style>
</head>
<body>

<h1>Bulk QR Label Printing</h1>

<div class="top-controls">
    <strong>Choose label layout:</strong><br><br>
    <button id="btn6"  class="layout-option">6 per page (Large)</button>
    <button id="btn12" class="layout-option active">12 per page (Medium)</button>
    <button id="btn24" class="layout-option">24 per page (Small)</button>
    <br><br>
    <button onclick="window.print()" style="padding:10px 22px;border-radius:999px;background:#16a34a;color:white;border:none;cursor:pointer;margin-right:10px;font-weight:bold;">
        ðŸ–¨ Print Labels
    </button>
    <button id="btnPDF" style="padding:10px 22px;border-radius:999px;background:#1a73e8;color:white;border:none;cursor:pointer;font-weight:bold;">
        ðŸ“„ Download PDF
    </button>
</div>

<div id="labelsArea"></div>

<script type="module">
    import QRCode from 'https://cdn.skypack.dev/qrcode';
    import { watchAuth, db } from "./firebase.js";
    import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const labelsArea = document.getElementById("labelsArea");
    const btnPDF = document.getElementById("btnPDF");

    const params = new URLSearchParams(location.search);
    const idList = (params.get("ids") || "").split(",").filter(id => id.trim() !== "");

    let layout = 12;
    updateGrid();

    document.getElementById("btn6").onclick  = () => setLayout(6);
    document.getElementById("btn12").onclick = () => setLayout(12);
    document.getElementById("btn24").onclick = () => setLayout(24);

    function setLayout(n) {
        layout = n;
        document.querySelectorAll(".layout-option").forEach(b => b.classList.remove("active"));
        document.getElementById("btn" + n).classList.add("active");
        updateGrid();
    }

    function updateGrid() {
        labelsArea.style.gridTemplateColumns =
            layout === 6  ? "repeat(2, 1fr)" :
            layout === 12 ? "repeat(3, 1fr)" :
                            "repeat(4, 1fr)";
    }

    watchAuth({
        allowedRoles: ["admin", "it", "viewer"],
        whoEl: null,
        onReady: () => loadLabels()
    });

    async function loadLabels() {
        if (idList.length === 0) {
            labelsArea.innerHTML = "<p>No IDs provided in URL.</p>";
            return;
        }

        labelsArea.innerHTML = "<p>Loading labels...</p>";
        const items = [];

        for (const id of idList) {
            try {
                const snap = await getDoc(doc(db, "items", id));
                if (snap.exists()) {
                    items.push({ id, ...snap.data() });
                }
            } catch (err) {
                console.error("Firebase Error:", id, err);
            }
        }

        if (items.length === 0) {
            labelsArea.innerHTML = "<p>No matching items found in Database.</p>";
            return;
        }

        labelsArea.innerHTML = "";

        for (const item of items) {
            const div = document.createElement("div");
            div.className = "label";

            const qrURL = `${window.location.origin}/item.html?id=${item.id}`;
            // Format Asset ID string exactly as requested
            const assetIdStr = `Asset ID: ${item.assetId || "No ID"}`;

            // 1. Asset ID Text on Top
            const idDiv = document.createElement("div");
            idDiv.className = "label-id";
            idDiv.textContent = assetIdStr;
            div.appendChild(idDiv);

            // 2. QR Container
            const qrContainer = document.createElement("div");
            qrContainer.className = "qr-container";
            div.appendChild(qrContainer);

            try {
                // Generate Canvas QR for sharpest print quality
                await QRCode.toCanvas(qrURL, {
                    width: 400,
                    margin: 1,
                    errorCorrectionLevel: 'H'
                }, (err, canvas) => {
                    if (err) throw err;
                    qrContainer.appendChild(canvas);
                });
            } catch (qrErr) {
                qrContainer.innerHTML = `<p style="font-size:10px;">Error</p>`;
            }
            
            labelsArea.appendChild(div);
        }
    }

    // PDF Generation Logic
    btnPDF.onclick = async () => {
        const { jsPDF } = window.jspdf;
        // High-scale capture for crystal-clear labels
        const canvas = await html2canvas(labelsArea, { scale: 3, useCORS: true });
        const imgData = canvas.toDataURL("image/png");
        
        const pdf = new jsPDF("p", "mm", "a4");
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save("Bulk-Inventory-Labels.pdf");
    };
</script>

</body>
</html>
