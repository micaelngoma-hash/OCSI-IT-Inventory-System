<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Print QR Labels â€“ OCSI IT Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QR + PDF libraries -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:system-ui;
  background:#f5f7fb;
  margin:0;
  padding:20px;
}
.top-controls{
  background:white;
  padding:14px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  margin-bottom:20px;
}
.layout-option{
  padding:8px 14px;
  border-radius:999px;
  border:1px solid #cbd5e1;
  cursor:pointer;
  margin-right:6px;
}
.layout-option.active{
  background:#1a73e8;
  color:white;
}
#labelsArea{
  display:grid;
  gap:12px;
  justify-content:center;
}
.label{
  background:white;
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:12px;
  text-align:center;
}
.label img{
  width:100%;
  max-width:220px;
}
@media print{
  .top-controls{display:none;}
  body{background:white;padding:0;}
}
</style>
</head>

<body>

<h2>Bulk QR Label Printing</h2>

<div class="top-controls">
  <button id="btn6" class="layout-option">6</button>
  <button id="btn12" class="layout-option active">12</button>
  <button id="btn24" class="layout-option">24</button>
  <br><br>
  <button onclick="printLabels()">ðŸ–¨ Print</button>
  <button id="btnPDF">ðŸ“„ PDF</button>
</div>

<div id="labelsArea">Initializingâ€¦</div>

<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc } from
  "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ---------------- DEBUG ---------------- */
console.log("print-labels.js loaded");

/* ---------------- DOM ---------------- */
const labelsArea = document.getElementById("labelsArea");
const btnPDF = document.getElementById("btnPDF");

/* ---------------- PARAMS ---------------- */
const ids = (new URLSearchParams(location.search).get("ids") || "")
  .split(",")
  .filter(Boolean);

if(ids.length === 0){
  labelsArea.textContent = "âŒ No device IDs provided.";
  throw new Error("No IDs in query string");
}

/* ---------------- LAYOUT ---------------- */
setLayout(12);
btn6.onclick  = () => setLayout(6);
btn12.onclick = () => setLayout(12);
btn24.onclick = () => setLayout(24);

function setLayout(n){
  document.querySelectorAll(".layout-option")
    .forEach(b => b.classList.remove("active"));
  document.getElementById("btn"+n).classList.add("active");

  labelsArea.style.gridTemplateColumns =
    n===6  ? "repeat(2,1fr)" :
    n===12 ? "repeat(3,1fr)" :
             "repeat(4,1fr)";
}

/* ---------------- MAIN ---------------- */
loadLabels();

async function loadLabels(){
  console.log("loadLabels() started");
  labelsArea.innerHTML = "";

  for(const id of ids){
    console.log("Loading item:", id);

    const snap = await getDoc(doc(db,"items",id));
    if(!snap.exists()){
      console.warn("Item not found:", id);
      continue;
    }

    const d = snap.data();
    const targetURL = `${location.origin}/item.html?id=${id}`;

    /* --- QR generation (CORRECT) --- */
    const canvas = document.createElement("canvas");
    await QRCode.toCanvas(canvas, targetURL, {
      width:220,
      margin:1,
      errorCorrectionLevel:"H"
    });

    const img = document.createElement("img");
    img.src = canvas.toDataURL("image/png");

    const box = document.createElement("div");
    box.className = "label";
    box.appendChild(img);
    box.innerHTML += `
      <div style="font-weight:600;margin-top:6px">
        ${d.assetId || ""}
      </div>
      <div style="font-size:.8rem;color:#555">
        ${d.deviceName || ""}
      </div>
    `;

    labelsArea.appendChild(box);
  }

  if(labelsArea.children.length === 0){
    labelsArea.textContent = "âŒ No valid devices found.";
  }
}

/* ---------------- UTIL ---------------- */
async function waitForImages(){
  const imgs=[...labelsArea.querySelectorAll("img")];
  await Promise.all(imgs.map(i =>
    i.complete ? Promise.resolve() :
    new Promise(r => i.onload = r)
  ));
}

/* ---------------- PRINT ---------------- */
window.printLabels = async ()=>{
  await waitForImages();
  window.print();
};

/* ---------------- PDF ---------------- */
btnPDF.onclick = async ()=>{
  await waitForImages();
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const canvas = await html2canvas(labelsArea,{
    scale:2,
    backgroundColor:"#fff"
  });
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",5,5,200,0);
  pdf.save("OCSI-QR-labels.pdf");
};
</script>

</body>
</html>
