<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Bulk QR Label Printing â€“ OCSI IT Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{
  font-family:system-ui,sans-serif;
  background:#f5f7fb;
  margin:0;
  padding:20px;
}
h1{margin-top:0}

.status{
  color:#64748b;
  margin-bottom:12px;
  font-size:.9rem;
}

.controls{margin-bottom:16px}
button{
  padding:8px 16px;
  border-radius:999px;
  border:none;
  cursor:pointer;
  background:#1a73e8;
  color:white;
  font-size:.9rem;
}

#labelsArea{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}

.label{
  background:white;
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:10px;
  text-align:center;
}

.label svg{width:100%;height:auto}

.asset{
  font-size:.85rem;
  font-weight:600;
  margin-top:6px;
}

.device{
  font-size:.75rem;
  color:#555;
}

@media print{
  body{background:white;padding:0}
  .controls,.status{display:none}
}
</style>
</head>

<body>

<h1>Bulk QR Label Printing</h1>

<div id="statusMsg" class="status">Loading labelsâ€¦</div>

<div class="controls">
  <button onclick="window.print()">ðŸ–¨ Print Labels</button>
</div>

<div id="labelsArea"></div>

<script type="module">
import QRCode from "https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.esm.js";

const PROJECT_ID = "ocsi-it-iventory-system";
const COLLECTION = "items";

const labelsArea = document.getElementById("labelsArea");
const statusMsg  = document.getElementById("statusMsg");

const params = new URLSearchParams(location.search);
const ids = (params.get("ids") || "")
  .split(",")
  .map(id => id.trim())
  .filter(Boolean);

if (!ids.length) {
  statusMsg.textContent = "No item IDs provided.";
} else {
  loadLabels();
}

async function loadLabels() {
  let rendered = 0;

  for (const id of ids) {
    try {
      const url = `https://firestore.googleapis.com/v1/projects/${PROJECT_ID}/databases/(default)/documents/${COLLECTION}/${id}`;
      const res = await fetch(url);

      if (!res.ok) continue;

      const json = await res.json();
      const fields = json.fields || {};

      const assetId    = fields.assetId?.stringValue || "";
      const deviceName = fields.deviceName?.stringValue || "";

      const svg = await QRCode.toString(id, {
        type: "svg",
        scale: 8,
        margin: 0,
        errorCorrectionLevel: "H"
      });

      const div = document.createElement("div");
      div.className = "label";
      div.innerHTML = `
        ${svg}
        <div class="asset">${assetId}</div>
        <div class="device">${deviceName}</div>
      `;

      labelsArea.appendChild(div);
      rendered++;

    } catch (e) {
      console.error("Failed:", id, e);
    }
  }

  statusMsg.textContent = rendered
    ? `Loaded ${rendered} label(s).`
    : "No labels could be loaded.";
}
</script>

</body>
</html>
