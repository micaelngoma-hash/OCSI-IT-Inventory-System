<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Print QR Labels â€“ OCSI IT Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Libraries -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
body{
  font-family:system-ui,sans-serif;
  background:#f5f7fb;
  margin:0;
  padding:20px;
}
h1{margin-top:0;font-size:2rem;}

.top-controls{
  background:white;
  padding:14px 18px;
  border-radius:12px;
  border:1px solid #e5e7eb;
  margin-bottom:20px;
}

.layout-option{
  padding:8px 16px;
  border-radius:12px;
  border:1px solid #cbd5e1;
  cursor:pointer;
  margin-right:8px;
  background:white;
  font-size:.9rem;
}
.layout-option.active{
  background:#1a73e8;
  color:white;
  border-color:#1a73e8;
}

/* Grid */
#labelsArea{
  display:grid;
  gap:12px;
  justify-content:center;
}

/* Label */
.label{
  background:white;
  border:1px solid #e5e7eb;
  border-radius:8px;
  padding:6px;
  width:120px;
  box-sizing:border-box;
  text-align:center;
}

.label img{
  width:100%;
  height:auto;
  display:block;
}

.label .asset{
  font-size:.75rem;
  font-weight:600;
  margin-top:4px;
}

.label .name{
  font-size:.65rem;
  color:#444;
  line-height:1.1;
}

@media print{
  body{background:white;padding:0;margin:0;}
  .top-controls{display:none!important;}
}
</style>
</head>

<body>
<h1>Bulk QR Label Printing</h1>

<div class="top-controls">
  <strong>Choose label layout:</strong><br><br>
  <button id="btn6"  class="layout-option">6 per page</button>
  <button id="btn12" class="layout-option active">12 per page</button>
  <button id="btn24" class="layout-option">24 per page</button>
  <br><br>
  <button onclick="window.print()">ðŸ–¨ Print Labels</button>
  <button id="btnPDF">ðŸ“„ Download PDF</button>
</div>

<div id="labelsArea"></div>

<script type="module">
import { watchAuth, db } from "./firebase.js";
import { doc, getDoc } from
  "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const labelsArea = document.getElementById("labelsArea");
const btnPDF = document.getElementById("btnPDF");

const params = new URLSearchParams(location.search);
const idList = (params.get("ids") || "").split(",").filter(Boolean);

let layout = 12;
updateGrid();

btn6.onclick  = () => setLayout(6);
btn12.onclick = () => setLayout(12);
btn24.onclick = () => setLayout(24);

function setLayout(n){
  layout=n;
  document.querySelectorAll(".layout-option").forEach(b=>b.classList.remove("active"));
  document.getElementById("btn"+n).classList.add("active");
  updateGrid();
}

function updateGrid(){
  labelsArea.style.gridTemplateColumns =
    layout===6  ? "repeat(2,120px)" :
    layout===12 ? "repeat(3,120px)" :
                  "repeat(4,95px)";
}

watchAuth({
  allowedRoles:["admin","it","viewer"],
  whoEl:null,
  onReady: loadLabels
});

async function loadLabels(){
  labelsArea.innerHTML="Loading labelsâ€¦";

  const items=[];
  for(const id of idList){
    const snap=await getDoc(doc(db,"items",id));
    if(snap.exists()) items.push({id,...snap.data()});
  }

  if(items.length===0){
    labelsArea.innerHTML="No items found.";
    return;
  }

  labelsArea.innerHTML="";

  for(const item of items){
    const div=document.createElement("div");
    div.className="label";

    const qrURL=`${location.origin}/item.html?id=${item.id}`;

    try{
      const canvas=document.createElement("canvas");

      await new Promise((resolve,reject)=>{
        window.QRCode.toCanvas(
          canvas,
          qrURL,
          {
            width: layout===24 ? 85 : 110,
            margin:1,
            errorCorrectionLevel:"H"
          },
          err => err ? reject(err) : resolve()
        );
      });

      const img=document.createElement("img");
      img.src=canvas.toDataURL("image/png");

      div.appendChild(img);
      div.innerHTML+=`
        <div class="asset">${item.assetId||"No ID"}</div>
        <div class="name">${item.deviceName||"Unnamed"}</div>
      `;
    }catch(err){
      console.error("QR generation failed:", err);
      div.innerHTML=`<div style="color:red;font-size:.7rem;">QR Error</div>`;
    }

    labelsArea.appendChild(div);
  }
}

btnPDF.onclick = async ()=>{
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p","mm","a4");
  const canvas = await html2canvas(labelsArea,{scale:2});
  pdf.addImage(canvas.toDataURL("image/png"),"PNG",5,5,200,0);
  pdf.save("QR-labels.pdf");
};
</script>
</body>
</html>
