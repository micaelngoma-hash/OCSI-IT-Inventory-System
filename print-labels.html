<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Print QR Labels ‚Äì OCSI IT Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- QR Code Generator -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<!-- html2canvas + jsPDF (for PDF export) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f5f7fb;
    margin: 0;
    padding: 20px;
  }

  h1 {
    margin-top: 0;
    font-size: 2rem;
    font-weight: 700;
  }

  .top-controls {
    background: white;
    padding: 18px;
    border-radius: 14px;
    border: 1px solid #e5e7eb;
    margin-bottom: 22px;
  }

  .layout-option {
    padding: 10px 18px;
    border-radius: 12px;
    border: 1px solid #cbd5e1;
    cursor: pointer;
    margin-right: 10px;
    background: white;
    font-size: .92rem;
  }

  .layout-option.active {
    background: #1a73e8;
    color: white;
    border-color: #1a73e8;
  }

  #labelsArea {
    display: grid;
    gap: 12px;
    justify-content: center;
  }

  .label {
    background: white;
    border: 1px solid #e5e7eb;
    padding: 12px;
    text-align: center;
    border-radius: 10px;
  }

  .label svg {
    width: 100%;
    height: auto;
  }

  .test-grid {
    width: 100%;
    height: 100%;
    opacity: .25;
    background-image: repeating-linear-gradient(0deg, #000 0, #000 1px, transparent 1px, transparent 20px),
                      repeating-linear-gradient(90deg, #000 0, #000 1px, transparent 1px, transparent 20px);
  }

  /* PRINT MODE */
  @media print {
    body { background: white; padding: 0; margin: 0; }
    .top-controls { display: none !important; }
  }
</style>
</head>

<body>

<h1>Bulk QR Label Printing</h1>

<div class="top-controls">
  <strong>Choose label layout:</strong><br><br>

  <button id="btn6" class="layout-option">6 per page (Large)</button>
  <button id="btn12" class="layout-option active">12 per page (Medium)</button>
  <button id="btn24" class="layout-option">24 per page (Small)</button>

  <br><br>

  <button onclick="window.print()"
          style="padding:12px 22px;border-radius:999px;background:#1a73e8;color:white;border:none;cursor:pointer;margin-right:10px;">
    üñ® Print Labels
  </button>

  <button id="btnPDF"
          style="padding:12px 22px;border-radius:999px;background:#16a34a;color:white;border:none;cursor:pointer;margin-right:10px;">
    üìÑ Download PDF
  </button>

  <button id="btnTest"
          style="padding:12px 22px;border-radius:999px;background:#6b7280;color:white;border:none;cursor:pointer;">
    üìè Print Test Page
  </button>
</div>

<div id="labelsArea"></div>

<!-- =================================== -->
<!-- MAIN SCRIPT (FULL WORKING VERSION) -->
<!-- =================================== -->
<script type="module">
import { watchAuth, db } from "./firebase.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

/* ========== DOM ELEMENTS ========== */
const labelsArea = document.getElementById("labelsArea");
const btnPDF     = document.getElementById("btnPDF");
const btnTest    = document.getElementById("btnTest");

/* ========== URL PARAMS ========== */
const params = new URLSearchParams(location.search);
const idList = (params.get("ids") || "")
                .split(",")
                .map(v => v.trim())
                .filter(v => v !== "");

/* ========== LABEL LAYOUT GRID ========== */
let layout = 12;
updateGrid();

document.getElementById("btn6").onclick  = () => setLayout(6);
document.getElementById("btn12").onclick = () => setLayout(12);
document.getElementById("btn24").onclick = () => setLayout(24);

function setLayout(n) {
  layout = n;
  document.querySelectorAll(".layout-option").forEach(btn => btn.classList.remove("active"));
  document.getElementById("btn" + n).classList.add("active");
  updateGrid();
}

function updateGrid() {
  if (layout === 6)  labelsArea.style.gridTemplateColumns = "repeat(2, 1fr)";
  if (layout === 12) labelsArea.style.gridTemplateColumns = "repeat(3, 1fr)";
  if (layout === 24) labelsArea.style.gridTemplateColumns = "repeat(4, 1fr)";
}

/* =======================================
   üîê AUTHENTICATION (FIX FOR QR NOT LOADING)
========================================== */
watchAuth({
  allowedRoles: ["admin", "it", "viewer"],
  whoEl: null,
  onReady: () => {
    loadLabels();   // Load labels ONLY after user is authenticated
  }
});

/* =======================================
   LOAD ITEMS + GENERATE QR LABELS
========================================== */
async function loadLabels() {
  labelsArea.innerHTML = "<p>Loading QR labels‚Ä¶</p>";

  const items = [];

  for (const id of idList) {
    const snap = await getDoc(doc(db, "items", id));

    if (snap.exists()) {
      items.push({ id, ...snap.data() });
    }
  }

  if (items.length === 0) {
    labelsArea.innerHTML = "<p>No items found.</p>";
    return;
  }

  labelsArea.innerHTML = ""; // clear

  /* -------- GENERATE LABELS WITH QR CODES ---------- */
  for (const item of items) {
    const div = document.createElement("div");
    div.className = "label";

    const qrURL = `${location.origin}/item.html?id=${item.id}`;

    // Generate QR SVG (works correctly)
    const svg = await QRCode.toString(qrURL, {
      type: "svg",
      margin: 0,
      scale: 10,
      errorCorrectionLevel: "H"
    });

    div.innerHTML = `
      <div>${svg}</div>
      <div style="font-size:.9rem;margin-top:6px;font-weight:600;">
        ${item.assetId || ""}
      </div>
      <div style="font-size:.75rem;color:#444;">
        ${item.deviceName || ""}
      </div>
    `;

    labelsArea.appendChild(div);
  }
}

/* =======================================
   PDF EXPORT
========================================== */
btnPDF.onclick = async function () {
  await new Promise(r => setTimeout(r, 300));  // Ensure SVG is fully rendered

  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF("p", "mm", "a4");

  const canvas = await html2canvas(labelsArea, { scale: 2 });
  const img = canvas.toDataURL("image/png");

  const pageWidth = 210;
  const imgWidth = pageWidth - 20;
  const imgHeight = (canvas.height * imgWidth) / canvas.width;

  pdf.addImage(img, "PNG", 10, 10, imgWidth, imgHeight);
  pdf.save("QR-labels.pdf");
};

/* =======================================
   TEST PAGE GRID (for label alignment)
========================================== */
btnTest.onclick = () => {
  labelsArea.innerHTML = "";

  for (let i = 0; i < 30; i++) {
    const div = document.createElement("div");
    div.className = "label";
    div.innerHTML = `<div class="test-grid"></div>`;
    labelsArea.appendChild(div);
  }
};
</script>

</body>
</html>
