<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Print QR Labels â€“ OCSI IT Inventory</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  body {
    font-family: system-ui, sans-serif;
    background: #f5f7fb;
    margin: 0;
    padding: 20px;
  }

  h1 { margin-top: 0; }

  .top-controls {
    background: white;
    padding: 14px 18px;
    border-radius: 12px;
    border: 1px solid #e5e7eb;
    margin-bottom: 20px;
  }

  .layout-option {
    padding: 6px 12px;
    border-radius: 6px;
    border: 1px solid #cbd5e1;
    cursor: pointer;
    margin-right: 6px;
    background: white;
  }
  .layout-option.active {
    background: #1a73e8;
    color: white;
    border-color: #1a73e8;
  }

  #labelsArea {
    display: grid;
    gap: 6px;
    justify-content: center;
  }

  .label {
    background: white;
    border: 1px solid #e5e7eb;
    padding: 6px;
    text-align: center;
    border-radius: 6px;
    display: flex;
    flex-direction: column;
    justify-content: center;
  }

  .label svg {
    width: 100%;
  }

  /* A4 print settings */
  @media print {
    body { padding: 0; background: white; }

    .top-controls { display: none !important; }
  }
</style>

<script type="module">
  import { db } from "./firebase.js";
  import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const params = new URLSearchParams(location.search);
  const idList = (params.get("ids") || "").split(",").filter(v => v.trim() !== "");

  const labelsArea = document.getElementById("labelsArea");

  let layout = 12; // default grid count
  updateGrid();

  // -------------------------
  //  GRID LAYOUT SWITCHING
  // -------------------------
  function updateGrid() {
    if (layout === 6) labelsArea.style.gridTemplateColumns = "repeat(2, 1fr)";
    if (layout === 12) labelsArea.style.gridTemplateColumns = "repeat(3, 1fr)";
    if (layout === 24) labelsArea.style.gridTemplateColumns = "repeat(4, 1fr)";
  }

  window.setLayout = function(count) {
    layout = count;
    document.querySelectorAll(".layout-option").forEach(btn => btn.classList.remove("active"));
    document.getElementById("btn" + count).classList.add("active");
    updateGrid();
  };

  // -------------------------
  // LOAD ITEMS + RENDER LABELS
  // -------------------------
  async function loadAndRender() {
    labelsArea.innerHTML = "<p>Loading labelsâ€¦</p>";

    const items = [];
    for (const id of idList) {
      const snap = await getDoc(doc(db, "items", id));
      if (snap.exists()) items.push({ id, ...snap.data() });
    }

    if (items.length === 0) {
      labelsArea.innerHTML = "<p>No items found.</p>";
      return;
    }

    labelsArea.innerHTML = ""; // clear

    for (const item of items) {
      const container = document.createElement("div");
      container.className = "label";

      // QR Data
      const qrData = `${location.origin}/item.html?id=${item.id}`;

      // Generate SVG QR
      const svg = await QRCode.toString(qrData, {
        type: "svg",
        margin: 0,
        scale: 10,
        errorCorrectionLevel: "H"
      });

      container.innerHTML = `
        <div class="qr">${svg}</div>
        <div style="font-size:.8rem;margin-top:4px;font-weight:600;">
          ${item.assetId || ""}
        </div>
        <div style="font-size:.7rem;color:#555;">${item.deviceName || ""}</div>
      `;

      labelsArea.appendChild(container);
    }
  }

  loadAndRender();
</script>

</head>
<body>

<h1>Bulk QR Label Printing</h1>

<div class="top-controls">
  <strong>Choose label layout:</strong><br><br>

  <button id="btn6"  class="layout-option" onclick="setLayout(6)">6 per page (Large)</button>
  <button id="btn12" class="layout-option active" onclick="setLayout(12)">12 per page (Medium)</button>
  <button id="btn24" class="layout-option" onclick="setLayout(24)">24 per page (Small)</button>

  <br><br>
  <button onclick="window.print()"
          style="padding:10px 20px;border-radius:999px;background:#1a73e8;color:white;border:none;cursor:pointer;">
    ðŸ–¨ Print Labels
  </button>
</div>

<div id="labelsArea"></div>

</body>
</html>
