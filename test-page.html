<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>OCSI – Device QR Code</title>

<style>
  body{
    font-family:system-ui;
    background:#f5f7fb;
    padding:30px;
    text-align:center;
  }
  .card{
    background:white;
    padding:20px;
    max-width:420px;
    margin:0 auto;
    border-radius:14px;
    border:1px solid #e5e7eb;
    box-shadow:0 4px 14px rgba(0,0,0,.1);
  }
  #qrBox svg{width:100%;height:auto;}
  button{
    padding:10px 18px;
    border-radius:999px;
    border:none;
    cursor:pointer;
    font-size:.9rem;
    margin:8px;
  }
  .btn-primary{background:#1a73e8;color:white;}
  .btn-ghost{background:white;border:1px solid #cbd5e1;}
</style>

<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<script type="module">
import { db } from "./firebase.js";
import { doc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

document.addEventListener("DOMContentLoaded", async () => {

  const params = new URLSearchParams(location.search);
  const itemId = params.get("id");

  const nameEl  = document.getElementById("deviceName");
  const assetEl = document.getElementById("assetId");
  const qrBox   = document.getElementById("qrBox");
  const btnDL   = document.getElementById("btnDownload");

  if(!itemId){
    nameEl.textContent = "Missing item ID";
    return;
  }

  const snap = await getDoc(doc(db,"items",itemId));
  if(!snap.exists()){
    nameEl.textContent = "Item not found";
    return;
  }

  const d = snap.data();
  nameEl.textContent  = d.deviceName || "Unnamed Device";
  assetEl.textContent = d.assetId || "–";

  const url = `${location.origin}${location.pathname.replace("print-qr.html","item.html")}?id=${itemId}`;

  const svg = await window.QRCode.toString(url,{
    type:"svg",
    margin:2,
    scale:12,
    errorCorrectionLevel:"H"
  });

  qrBox.innerHTML = svg;

  btnDL.onclick = () => {
    const blob = new Blob([svg],{type:"image/svg+xml"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `OCSI-${d.assetId || itemId}.svg`;
    a.click();
  };
});
</script>
</head>

<body>

<h1>Device QR Code</h1>

<div class="card">
  <h2 id="deviceName">Loading…</h2>
  <p>Asset ID: <strong id="assetId"></strong></p>

  <div id="qrBox" style="margin:20px 0;"></div>

  <button id="btnDownload" class="btn-primary">⬇ Download QR (SVG)</button>
  <button class="btn-ghost" onclick="history.back()">Back</button>
</div>

</body>
</html>
