<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory ‚Äì Inventory List</title>

<!-- QRCode Library (must NOT be imported inside module) -->
<script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>

<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 52px);}
  .sidebar{background:var(--bg2);color:white;padding:14px;}
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .nav .icon{width:18px;text-align:center;opacity:.8;}

  .content{
    padding:18px;
    max-width:1150px;
    margin:0 auto;
    width:100%;
  }

  h1{margin:0 0 4px;font-size:1.4rem;}
  .subtitle{margin:0 0 14px;font-size:.9rem;color:#94a3b8;}

  /* Toolbar */
  .toolbar{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:10px;gap:10px;flex-wrap:wrap;
  }
  .search-box{
    display:flex;align-items:center;gap:6px;
    background:white;border:1px solid var(--border);
    border-radius:999px;padding:4px 10px;
    max-width:320px;width:100%;
  }
  .search-box input{
    border:none;outline:none;font-size:.88rem;width:100%;
    background:transparent;
  }
  .filters{display:flex;gap:8px;flex-wrap:wrap;}
  select{
    padding:6px 8px;border-radius:999px;
    border:1px solid var(--border);font-size:.85rem;background:white;
  }
  .btn{
    border:none;cursor:pointer;
    padding:6px 12px;border-radius:999px;
    font-size:.85rem;font-weight:500;
    display:inline-flex;align-items:center;gap:5px;
    text-decoration:none;
  }
  .btn-primary{background:var(--brand);color:white;}
  .btn-ghost{background:transparent;border:1px solid #cbd5e1;color:#0f172a;}

  .table-wrap{
    background:white;border:1px solid var(--border);
    border-radius:12px;overflow:auto;
  }
  table{border-collapse:collapse;width:100%;min-width:900px;}
  th,td{
    padding:8px 10px;border-bottom:1px solid #f1f5f9;
    font-size:.88rem;text-align:left;
  }
  th{
    background:#f8fafc;font-weight:600;color:#475569;
    position:sticky;top:0;z-index:5;
  }
  tr:hover td{background:#f9fafb;}

  /* QR Button */
  .qr-btn{
    background:white;border:1px solid #cbd5e1;
    border-radius:50%;width:32px;height:32px;
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;font-size:1.1rem;
  }
  .qr-btn:hover{background:#eef4ff;border-color:#1a73e8;color:#1a73e8;}

  /* Checkbox column */
  .chk{
    transform:scale(1.2);
    cursor:pointer;
  }

  /* Floating FAB */
  .fab-print{
    position:fixed;bottom:22px;right:22px;
    width:64px;height:64px;
    border-radius:50%;
    background:var(--brand);
    color:white;font-size:1.8rem;
    display:flex;align-items:center;justify-content:center;
    cursor:pointer;
    box-shadow:0 4px 16px rgba(0,0,0,0.25);
    display:none; /* hidden until items selected */
    z-index:50;
  }
  .fab-print:hover{background:#155cc4;}

  /* QR Modal */
  .modal-bg{
    position:fixed;top:0;left:0;width:100%;height:100%;
    background:rgba(0,0,0,0.45);display:none;
    align-items:center;justify-content:center;z-index:200;
  }
  .modal{
    background:white;border-radius:16px;padding:24px;
    width:380px;max-width:95%;
    border-top:6px solid #1a73e8;
    text-align:center;
  }
  .modal h2{margin-top:0;}
  #qrBox svg{width:100%;}
</style>
</head>

<body>

<!-- Topbar -->
<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Inventory List</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üìä</span><span>Main Dashboard</span></a>
      <a href="software-licenses.html"><span class="icon">üîë</span><span>Software Licenses</span></a>
      <a class="active" href="inventory-list.html"><span class="icon">üíª</span><span>Hardware</span></a>
      <a href="scan.html"><span class="icon">üì±</span><span>QR Scan Device</span></a>
      <a href="audits.html"><span class="icon">üïí</span><span>Audits</span></a>
      <a href="admin-console.html"><span class="icon">‚öôÔ∏è</span><span>Admin Console</span></a>
      <a href="login.html"><span class="icon">üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1>Inventory</h1>
    <p class="subtitle">Browse, search, and manage all devices.</p>

    <!-- Toolbar -->
    <div class="toolbar">
      <div class="search-box">
        <span>üîç</span>
        <input id="search" placeholder="Search by Asset ID, name, user‚Ä¶" />
      </div>

      <div class="filters">
        <select id="statusFilter">
          <option value="">All statuses</option>
          <option value="in-use">In use</option>
          <option value="in-storage">In storage</option>
          <option value="loaned">Loaned</option>
          <option value="retired">Retired</option>
          <option value="repair">Under repair</option>
        </select>

        <button id="exportBtn" class="btn btn-ghost">‚¨áÔ∏è Export CSV</button>
        <button id="importBtn" class="btn btn-ghost">üì§ Import CSV</button>
        <button id="addBtn" class="btn btn-primary">‚ûï New Device</button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th style="width:40px;"><input type="checkbox" id="chkAll"/></th>
            <th>Asset ID</th>
            <th>Device Name</th>
            <th>Type</th>
            <th>Status</th>
            <th>Assigned To</th>
            <th>Location</th>
            <th>IP</th>
            <th style="width:130px;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="9">Loading devices‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Floating Print FAB -->
    <div class="fab-print" id="fabPrint" title="Print selected QR labels">üñ®Ô∏è</div>

  </main>
</div>

<!-- QR Modal -->
<div class="modal-bg" id="qrModal">
  <div class="modal">
    <h2 id="qrTitle">QR Code</h2>
    <div id="qrBox" style="margin:20px 0;"></div>
    <button id="btnQrDownload" class="btn btn-primary">‚¨áÔ∏è Download QR (SVG)</button>
    <br><br>
    <button id="btnQrClose" class="btn btn-ghost">Close</button>
  </div>
</div>

<!-- SCRIPT -->
<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import { collection, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const whoEl = document.getElementById("who");
  const tbody = document.getElementById("tbody");
  const fabPrint = document.getElementById("fabPrint");
  const chkAll = document.getElementById("chkAll");

  let allItems = [];
  let currentRole = "viewer";
  const EDIT_ROLES = ["admin","it"];

  watchAuth({
    allowedRoles:["admin","it","viewer"],
    whoEl,
    onReady: async (_u, role)=>{
      currentRole = role;
      await loadItems();
    }
  });

  async function loadItems(){
    const snap = await getDocs(collection(db,"items"));
    allItems = [];
    snap.forEach(docSnap => allItems.push({ id: docSnap.id, ...docSnap.data() }));
    render();
  }

  function escapeHtml(s){return s?String(s).replace(/[&<>\"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])):"";}

  function render(){
    if(!allItems.length){
      tbody.innerHTML = `<tr><td colspan="9">No devices found.</td></tr>`;
      return;
    }

    tbody.innerHTML = allItems.map(it=>{
      const viewUrl = `item.html?id=${encodeURIComponent(it.id)}`;
      const editUrl = `item-form.html?id=${encodeURIComponent(it.id)}`;

      const actions = EDIT_ROLES.includes(currentRole)
        ? `<a class="btn btn-ghost" style="font-size:.8rem;padding:3px 8px;" href="${viewUrl}">View</a>
           <a class="btn btn-ghost" style="font-size:.8rem;padding:3px 8px;" href="${editUrl}">Edit</a>`
        : `<a class="btn btn-ghost" style="font-size:.8rem;padding:3px 8px;" href="${viewUrl}">View</a>`;

      return `
        <tr>
          <td><input type="checkbox" class="chk" data-id="${it.id}"/></td>
          <td>${escapeHtml(it.assetId||"")}</td>
          <td>${escapeHtml(it.deviceName||"")}</td>
          <td>${escapeHtml(it.assetType||"")}</td>
          <td>${escapeHtml(it.status||"")}</td>
          <td>${escapeHtml(it.assignedTo||"")}</td>
          <td>${escapeHtml(it.location||"")}</td>
          <td>${escapeHtml(it.ipAddress||"")}</td>
          <td>
            <button class="qr-btn" data-qr="${it.id}">üì±</button>
            ${actions}
          </td>
        </tr>`;
    }).join("");

    attachRowEvents();
  }

  function attachRowEvents(){
    // Individual QR buttons
    document.querySelectorAll("[data-qr]").forEach(btn=>{
      btn.onclick = ()=> openQrModal(btn.dataset.qr);
    });

    // Checkbox tracking
    document.querySelectorAll(".chk").forEach(ch=>{
      ch.onchange = updateFabVisibility;
    });

    chkAll.onchange = ()=>{
      const checked = chkAll.checked;
      document.querySelectorAll(".chk").forEach(c=>c.checked = checked);
      updateFabVisibility();
    };
  }

  function updateFabVisibility(){
    const selected = [...document.querySelectorAll(".chk:checked")];
    fabPrint.style.display = selected.length ? "flex" : "none";
  }

  fabPrint.onclick = ()=>{
    const ids = [...document.querySelectorAll(".chk:checked")].map(c=>c.dataset.id);
    if(!ids.length) return;
    window.location.href = "print-labels.html?ids=" + encodeURIComponent(ids.join(","));
  };

  /* QR MODAL */
  const qrModal = document.getElementById("qrModal");
  const qrTitle = document.getElementById("qrTitle");
  const qrBox = document.getElementById("qrBox");
  const btnQrDownload = document.getElementById("btnQrDownload");
  const btnQrClose = document.getElementById("btnQrClose");

  function openQrModal(itemId){
    const item = allItems.find(x => x.id === itemId);
    if(!item) return;

    qrTitle.textContent = item.deviceName || item.assetId || "QR Code";

    const url = `${location.origin}/item.html?id=${itemId}`;

    QRCode.toString(url, {
      type:"svg",
      margin:1,
      scale:10,
      errorCorrectionLevel:"H"
    }, (err,svg)=>{
      if(err) return console.error(err);
      qrBox.innerHTML = svg;

      btnQrDownload.onclick = ()=>{
        const blob = new Blob([svg], {type:"image/svg+xml"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `OCSI-${item.assetId || itemId}.svg`;
        a.click();
      };

      qrModal.style.display = "flex";
    });
  }

  btnQrClose.onclick = ()=> qrModal.style.display="none";
  qrModal.onclick = (e)=>{ if(e.target===qrModal) qrModal.style.display="none"; };

</script>

</body>
</html>
