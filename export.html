<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Export Data</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}
  .topbar{
    background:var(--bg);color:white;
    padding:12px 16px;display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .content{padding:22px;max-width:900px;margin:0 auto;}

  h1{margin:0 0 6px;font-size:1.4rem;}
  .subtitle{color:#64748b;font-size:.9rem;margin-bottom:16px;}

  .card{
    background:white;border-radius:12px;
    padding:16px;border:1px solid var(--border);
    margin-bottom:18px;
  }
  .section-title{font-weight:600;margin-bottom:6px;}
  label{display:flex;align-items:center;gap:6px;margin-bottom:6px;font-size:.9rem;}

  .btn{
    border:none;cursor:pointer;
    padding:7px 13px;border-radius:999px;
    font-size:.85rem;font-weight:500;
    display:inline-flex;align-items:center;gap:6px;
    background:var(--brand);color:white;margin-top:10px;
  }
  .btn[disabled]{opacity:.5;cursor:not-allowed;}

  .log{font-family:monospace;font-size:.78rem;background:#0b1020;color:#e5e7eb;
       padding:8px;border-radius:8px;max-height:220px;overflow:auto;margin-top:10px;}
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> – Export Data</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session…</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">
    <h1>Export Firestore Data</h1>
    <p class="subtitle">
      Download selected collections as CSV files for backup or analysis.
    </p>

    <section class="card">
      <div class="section-title">Choose what to export</div>
      <label><input type="checkbox" id="expDevices" checked/> Devices (items)</label>
      <label><input type="checkbox" id="expLicenses" checked/> Software Licenses (software_license)</label>
      <button id="exportBtn" class="btn" type="button">⬇️ Download CSV Files</button>
    </section>

    <section class="card">
      <div class="section-title">Export Log</div>
      <div id="log" class="log">Waiting…</div>
    </section>

  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
import { db, watchAuth } from "./firebase.js";
import {
  getDocs, collection
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const whoEl      = document.getElementById("who");
const expDevices = document.getElementById("expDevices");
const expLicenses= document.getElementById("expLicenses");
const exportBtn  = document.getElementById("exportBtn");
const logEl      = document.getElementById("log");

watchAuth({
  allowedRoles:["admin","it"],
  whoEl,
  onReady: ()=>{}
});

function log(msg){
  const t = new Date().toISOString().slice(11,19);
  logEl.textContent += `\n[${t}] ${msg}`;
  logEl.scrollTop = logEl.scrollHeight;
}

exportBtn.onclick = async ()=>{
  if(!expDevices.checked && !expLicenses.checked){
    alert("Please select at least one collection to export.");
    return;
  }
  exportBtn.disabled = true;
  log("Starting export…");

  try{
    if(expDevices.checked){
      await exportCollection("items","devices");
    }
    if(expLicenses.checked){
      await exportCollection("software_license","software_licenses");
    }
    log("Export complete.");
  }catch(e){
    log("Error: "+(e.message||e));
  }finally{
    exportBtn.disabled = false;
  }
};

async function exportCollection(collName, filePrefix){
  log(`Exporting collection: ${collName}…`);
  const snap = await getDocs(collection(db, collName));
  const docs = [];
  snap.forEach(d=>{
    docs.push({ id: d.id, ...d.data() });
  });
  if(!docs.length){
    log(`No documents found in ${collName}.`);
    return;
  }
  const csv = toCsv(docs);
  triggerDownload(csv, `${filePrefix}-${new Date().toISOString().slice(0,10)}.csv`);
  log(`Exported ${docs.length} documents from ${collName}.`);
}

function toCsv(rows){
  // Collect all keys
  const keys = Array.from(
    rows.reduce((set,row)=>{
      Object.keys(row).forEach(k=>set.add(k));
      return set;
    }, new Set())
  );
  const header = keys.join(",");
  const lines = rows.map(row=>{
    return keys.map(k => csvEscape(valueToString(row[k]))).join(",");
  });
  return [header, ...lines].join("\r\n");
}

function valueToString(v){
  if(v == null) return "";
  if(v.toDate) return v.toDate().toISOString();
  if(typeof v === "object") return JSON.stringify(v);
  return String(v);
}

function csvEscape(s){
  if(s.includes(",") || s.includes("\"") || s.includes("\n")){
    return `"${s.replace(/"/g,'""')}"`;
  }
  return s;
}

function triggerDownload(text, filename){
  const blob = new Blob([text], {type:"text/csv;charset=utf-8;"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}
</script>

</body>
</html>
