<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Software Inventory Dashboard | IT Inventory System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Simple clean styling for dashboard -->
  <style>
    :root {
      --bg: #f5f7fb;
      --card-bg: #ffffff;
      --primary: #1a73e8;
      --primary-soft: #e3f2fd;
      --danger: #c62828;
      --danger-soft: #ffebee;
      --accent: #00b8a9;
      --border: #dde3f0;
      --text-main: #202124;
      --text-muted: #5f6368;
      --shadow-soft: 0 4px 12px rgba(0, 0, 0, 0.06);
      --radius-lg: 12px;
    }

    * {
      box-sizing: border-box;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      margin: 0;
      background-color: var(--bg);
      color: var(--text-main);
    }

    header {
      background: #0f172a;
      color: white;
      padding: 16px 24px;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      align-items: center;
    }

    header .title {
      font-size: 1.3rem;
      font-weight: 600;
    }

    header .subtitle {
      font-size: 0.85rem;
      color: #cbd5f5;
      margin-top: 4px;
    }

    header .roles {
      font-size: 0.8rem;
      color: #cbd5f5;
      text-align: right;
    }

    main {
      padding: 24px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .breadcrumbs {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-bottom: 16px;
    }

    .breadcrumbs span {
      color: var(--text-main);
      font-weight: 500;
    }

    .cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      padding: 16px 18px;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }

    .card-badge {
      font-size: 0.7rem;
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .card-main-value {
      font-size: 1.8rem;
      font-weight: 700;
      margin-bottom: 4px;
    }

    .card-subtext {
      font-size: 0.8rem;
      color: var(--text-muted);
    }

    .card-subtext span {
      font-weight: 600;
      color: var(--primary);
    }

    .card.danger {
      border-color: #ffcdd2;
      background: var(--danger-soft);
    }

    .card.danger .card-title {
      color: var(--danger);
    }

    .card.danger .card-main-value {
      color: var(--danger);
    }

    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 24px 0 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title small {
      font-size: 0.8rem;
      color: var(--text-muted);
      font-weight: 400;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
      background: var(--card-bg);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    thead {
      background: #f1f5f9;
    }

    th, td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--border);
      text-align: left;
    }

    th {
      font-weight: 600;
      color: var(--text-muted);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tbody tr:nth-child(even) {
      background: #f9fbff;
    }

    .tag {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      background: var(--primary-soft);
      color: var(--primary);
    }

    .tag.danger {
      background: var(--danger-soft);
      color: var(--danger);
    }

    .tag.warning {
      background: #fff8e1;
      color: #f9a825;
    }

    .muted {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .status-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      margin-right: 4px;
      background: var(--accent);
    }

    .status-dot.danger {
      background: var(--danger);
    }

    .status-dot.warning {
      background: #f9a825;
    }

    .pill {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e0ecff;
      color: #1a73e8;
      font-size: 0.75rem;
      margin-left: 4px;
    }

    .error {
      color: var(--danger);
      font-size: 0.8rem;
      margin-top: 4px;
    }

    @media (max-width: 720px) {
      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
      }
      header .roles {
        text-align: left;
      }
    }
  </style>

  <!-- Firebase SDKs (compat version for simplicity) -->
  <!-- Replace version if needed; keep compat to match this code -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>
<body>
  <header>
    <div>
      <div class="title">Software Inventory Dashboard</div>
      <div class="subtitle">
        Part of the OCSI IT Inventory & Asset Management System (Hardware, Network, Software & Licensing)
      </div>
    </div>
    <div class="roles">
      Designed for:<br />
      <strong>Administrators, IT Staff, Faculty Staff, Office Staff</strong>
    </div>
  </header>

  <main>
    <div class="breadcrumbs">
      Inventory System &gt; <span>Software Management</span> &gt; Dashboard
    </div>

    <!-- SUMMARY CARDS -->
    <section class="cards">
      <div class="card">
        <div class="card-header">
          <div class="card-title">Software Products</div>
          <div class="card-badge">Catalog</div>
        </div>
        <div class="card-main-value" id="softwareProductsCount">--</div>
        <div class="card-subtext">
          Total distinct software titles registered in the system.
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Licenses</div>
          <div class="card-badge">License Pools</div>
        </div>
        <div class="card-main-value" id="softwareLicensesCount">--</div>
        <div class="card-subtext">
          Total license pools for all products (e.g., Microsoft 365, Adobe, Antivirus).
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">Seats Usage</div>
          <div class="card-badge">Capacity</div>
        </div>
        <div class="card-main-value">
          <span id="totalSeatsUsed">--</span> / <span id="totalSeats">--</span>
        </div>
        <div class="card-subtext">
          <span id="seatUsagePercent">--%</span> of all seats are currently assigned.
        </div>
      </div>

      <div class="card danger">
        <div class="card-header">
          <div class="card-title">Compliance Alerts</div>
          <div class="card-badge">Attention</div>
        </div>
        <div class="card-main-value" id="overAssignedCount">--</div>
        <div class="card-subtext">
          License pools are over-assigned or misconfigured. Review required.
        </div>
      </div>
    </section>

    <!-- EXPIRING LICENSES TABLE -->
    <section>
      <div class="section-title">
        <span>Licenses Expiring Soon</span>
        <small>Licenses with expiry within the next 30 days.</small>
      </div>
      <div id="expiringLicensesWrapper">
        <table id="expiringLicensesTable">
          <thead>
            <tr>
              <th>Software Name</th>
              <th>Vendor</th>
              <th>Expiry Date</th>
              <th>Seats (Used / Total)</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="expiringLicensesBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
        <div class="muted" id="expiringLicensesEmpty" style="display: none; padding: 8px;">
          No licenses are expiring in the next 30 days.
        </div>
      </div>
    </section>

    <!-- OVER-ASSIGNED LICENSES TABLE -->
    <section>
      <div class="section-title">
        <span>Over-assigned / Compliance Issues</span>
        <small>License pools where assigned seats exceed allowed seats.</small>
      </div>
      <div id="complianceWrapper">
        <table id="complianceTable">
          <thead>
            <tr>
              <th>Software Name</th>
              <th>Vendor</th>
              <th>Seats (Used / Total)</th>
              <th>Over by</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody id="complianceBody">
            <!-- Filled by JS -->
          </tbody>
        </table>
        <div class="muted" id="complianceEmpty" style="display: none; padding: 8px;">
          No over-assigned licenses detected. You're in compliance.
        </div>
      </div>
    </section>

    <div class="muted" style="margin-top: 24px;">
      Note: This dashboard is read-only. Changes to software products, licenses, and assignments are managed
      from the <strong>Administration</strong> and <strong>Software License</strong> pages.
    </div>

    <div class="error" id="errorBox" style="display:none;"></div>
  </main>

  <script>
    // ============================
    // 1. Firebase Configuration
    // ============================
    // TODO: Replace with your real Firebase project config
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY_HERE",
      authDomain: "YOUR_AUTH_DOMAIN_HERE",
      projectId: "YOUR_PROJECT_ID_HERE",
      // storageBucket, messagingSenderId, appId are optional here but recommended
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const errorBox = document.getElementById('errorBox');

    function showError(message, errorObj) {
      console.error(message, errorObj || '');
      errorBox.style.display = 'block';
      errorBox.textContent = message;
    }

    // ============================
    // 2. Helper: Convert Timestamp/string to Date
    // ============================
    function toJsDate(value) {
      if (!value) return null;
      if (value.toDate) {
        // Firestore Timestamp
        return value.toDate();
      }
      if (typeof value === 'string' || typeof value === 'number') {
        const d = new Date(value);
        return isNaN(d.getTime()) ? null : d;
      }
      return null;
    }

    function formatDate(value) {
      const d = toJsDate(value);
      if (!d) return '--';
      return d.toISOString().substring(0, 10); // YYYY-MM-DD
    }

    // ============================
    // 3. Load dashboard data
    // ============================
    async function loadDashboard() {
      try {
        // 3.1. Count software products
        const productsSnap = await db.collection('software_product').get();
        const productsCount = productsSnap.size;
        document.getElementById('softwareProductsCount').textContent = productsCount;

        // 3.2. Load licenses & compute stats
        const licensesSnap = await db.collection('software_license').get();
        const licensesCount = licensesSnap.size;
        document.getElementById('softwareLicensesCount').textContent = licensesCount;

        let totalSeats = 0;
        let totalSeatsUsed = 0;

        const now = new Date();
        const days30FromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);

        const expiringLicenses = [];
        const overAssignedLicenses = [];

        licensesSnap.forEach(doc => {
          const data = doc.data();
          const total = Number(data.totalSeats || 0);
          const used = Number(data.assignedSeats || 0);
          const vendor = data.vendor || '';
          const softwareName = data.softwareName || '(Unnamed)';
          const expiry = data.expiryDate;

          totalSeats += total;
          totalSeatsUsed += used;

          // Expiry check
          const expiryDate = toJsDate(expiry);
          if (expiryDate && expiryDate <= days30FromNow) {
            expiringLicenses.push({
              id: doc.id,
              softwareName,
              vendor,
              expiryDate,
              used,
              total
            });
          }

          // Over-assigned check
          if (used > total && total > 0) {
            overAssignedLicenses.push({
              id: doc.id,
              softwareName,
              vendor,
              used,
              total,
              overBy: used - total
            });
          }
        });

        // 3.3. Update seat usage card
        document.getElementById('totalSeats').textContent = totalSeats;
        document.getElementById('totalSeatsUsed').textContent = totalSeatsUsed;
        const usagePercent = totalSeats > 0 ? Math.round((totalSeatsUsed / totalSeats) * 100) : 0;
        document.getElementById('seatUsagePercent').textContent = usagePercent + '%';

        // 3.4. Compliance card
        document.getElementById('overAssignedCount').textContent = overAssignedLicenses.length;

        // 3.5. Fill expiring licenses table
        const expBody = document.getElementById('expiringLicensesBody');
        expBody.innerHTML = '';
        if (expiringLicenses.length === 0) {
          document.getElementById('expiringLicensesEmpty').style.display = 'block';
        } else {
          document.getElementById('expiringLicensesEmpty').style.display = 'none';
          expiringLicenses
            .sort((a, b) => a.expiryDate - b.expiryDate)
            .forEach(lic => {
              const tr = document.createElement('tr');
              tr.innerHTML = `
                <td>${lic.softwareName}</td>
                <td>${lic.vendor || '-'}</td>
                <td>${formatDate(lic.expiryDate)}</td>
                <td>${lic.used} / ${lic.total}</td>
                <td>
                  <span class="status-dot warning"></span>
                  <span class="tag warning">Expiring soon</span>
                </td>
              `;
              expBody.appendChild(tr);
            });
        }

        // 3.6. Fill over-assigned/compliance table
        const compBody = document.getElementById('complianceBody');
        compBody.innerHTML = '';
        if (overAssignedLicenses.length === 0) {
          document.getElementById('complianceEmpty').style.display = 'block';
        } else {
          document.getElementById('complianceEmpty').style.display = 'none';
          overAssignedLicenses.forEach(lic => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${lic.softwareName}</td>
              <td>${lic.vendor || '-'}</td>
              <td>${lic.used} / ${lic.total}</td>
              <td>${lic.overBy}</td>
              <td>
                <span class="status-dot danger"></span>
                <span class="tag danger">Over-assigned</span>
              </td>
            `;
            compBody.appendChild(tr);
          });
        }
      } catch (err) {
        showError('Failed to load software dashboard data. Please check Firestore rules/config.', err);
      }
    }

    // ============================
    // 4. Optional: Auth guard (simple)
    // ============================
    // If you want to restrict this dashboard to signed-in users only,
    // uncomment the auth state listener below and redirect if not logged in.

    /*
    auth.onAuthStateChanged(user => {
      if (!user) {
        // Redirect to login page (adjust the path for your project)
        window.location.href = 'login.html';
      } else {
        loadDashboard();
      }
    });
    */

    // For now, load dashboard immediately (no auth guard)
    window.addEventListener('DOMContentLoaded', () => {
      loadDashboard();
    });
  </script>
</body>
</html>
