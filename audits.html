<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Audit Logs ‚Äì OCSI IT Inventory</title>
    <style>
        :root { --bg: #0f172a; --border: #e5e7eb; --blue: #1a73e8; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f5f7fb; margin: 0; color: #1e293b; }
        .content { padding: 30px; max-width: 1150px; margin: 0 auto; }
        
        .filter-bar { 
            display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; 
            background: white; padding: 16px; border-radius: 12px; border: 1px solid var(--border);
            align-items: flex-end;
        }
        .filter-group { display: flex; flex-direction: column; gap: 4px; }
        .filter-group label { font-size: 0.75rem; font-weight: 600; color: #64748b; text-transform: uppercase; }
        input, select { 
            padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border); 
            font-size: 0.9rem; outline-color: var(--blue);
        }
        .search-input { min-width: 250px; flex-grow: 1; }

        .card { background: white; border: 1px solid var(--border); border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px 16px; border-bottom: 1px solid #f1f5f9; font-size: 0.85rem; }
        th { background: #f8fafc; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.025em; }
        tr:hover td { background: #fdfdfd; }

        /* Unified Action Pills */
        .pill { padding: 3px 10px; border-radius: 999px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; }
        .pill-edit { background: #dbeafe; color: #1e40af; } /* Update/Edit */
        .pill-create { background: #dcfce7; color: #166534; }
        .pill-delete { background: #fee2e2; color: #991b1b; }
        .pill-login { background: #fef9c3; color: #854d0e; }
        .pill-view { background: #f1f5f9; color: #475569; }
        
        .btn {
            padding: 8px 14px; border-radius: 6px; border: 1px solid var(--border); 
            font-size: 0.85rem; cursor: pointer; font-weight: 500;
            display: flex; align-items: center; gap: 6px; background: white;
        }
        .btn-primary { background: var(--blue); color: white; border: none; }
        .btn:hover { opacity: 0.9; }

        code { background: #f1f5f9; padding: 2px 4px; border-radius: 4px; font-family: monospace; font-size: 0.8rem; }
        .error-box { background: #fff1f2; border: 1px solid #fda4af; color: #9f1239; padding: 15px; border-radius: 8px; display: none; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div class="content">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h1 style="margin:0;">System Audit Log</h1>
                <p style="color: #64748b; margin: 5px 0 0 0;">Tracking creations, edits, and deletions across the inventory.</p>
            </div>
            <div style="display: flex; gap: 10px;">
                <button onclick="location.href='index.html'" class="btn">üè† Dashboard</button>
                <button id="downloadCsv" class="btn btn-primary">üì• Export CSV</button>
            </div>
        </div>
        
        <div id="errorBox" class="error-box"></div>

        <div class="filter-bar">
            <div class="filter-group search-input">
                <label>Global Search</label>
                <input type="text" id="searchInput" placeholder="Search User, Asset ID, or Details...">
            </div>
            <div class="filter-group">
                <label>Action</label>
                <select id="actionFilter">
                    <option value="all">All Actions</option>
                    <option value="create">Create</option>
                    <option value="edit">Edit / Update</option>
                    <option value="delete">Delete</option>
                    <option value="view">View</option>
                    <option value="login">Login</option>
                </select>
            </div>
            <div class="filter-group">
                <label>Date</label>
                <input type="date" id="dateFilter">
            </div>
            <button id="resetFilters" class="btn">Reset</button>
        </div>

        <div class="card">
            <table id="auditTable">
                <thead>
                    <tr>
                        <th style="width: 180px;">Date & Time</th>
                        <th>User</th>
                        <th>Action</th>
                        <th>Target (Asset ID)</th>
                        <th>Details</th>
                    </tr>
                </thead>
                <tbody id="auditTableBody">
                    <tr><td colspan="5" style="text-align:center; padding: 40px; color: #94a3b8;">Connecting to database...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { db, watchAuth } from "./firebase.js";
        import { collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

        const tbody = document.getElementById("auditTableBody");
        const errorBox = document.getElementById("errorBox");
        const searchInput = document.getElementById("searchInput");
        const actionFilter = document.getElementById("actionFilter");
        const dateFilter = document.getElementById("dateFilter");
        const resetBtn = document.getElementById("resetFilters");
        const downloadBtn = document.getElementById("downloadCsv");

        let allLogs = []; 
        let currentFiltered = [];

        watchAuth({
            allowedRoles: ["admin", "it"],
            onReady: () => {
                // Listen to the 'audits' collection
                const q = query(collection(db, "audits"), orderBy("timestamp", "desc"), limit(500));
                
                onSnapshot(q, (snap) => {
                    errorBox.style.display = "none";
                    if (snap.empty) {
                        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: #94a3b8;">No audit history found yet.</td></tr>';
                        return;
                    }
                    
                    allLogs = snap.docs.map(doc => {
                        const data = doc.data();
                        // Support both 'update' and 'edit' naming for the pill color
                        const actionType = data.action === 'update' ? 'edit' : data.action;
                        
                        return {
                            id: doc.id,
                            ...data,
                            actionType: actionType,
                            dateStr: data.timestamp ? data.timestamp.toDate().toLocaleDateString('en-CA') : '',
                            displayDate: data.timestamp ? data.timestamp.toDate().toLocaleString() : 'Syncing...'
                        };
                    });

                    renderTable();
                }, (err) => {
                    errorBox.style.display = "block";
                    errorBox.innerHTML = `<strong>Access Denied:</strong> Only IT/Admins can view audit logs. Error: ${err.message}`;
                });
            }
        });

        function renderTable() {
            const searchTerm = searchInput.value.toLowerCase();
            const actionTerm = actionFilter.value;
            const dateTerm = dateFilter.value;

            currentFiltered = allLogs.filter(l => {
                const matchesSearch = (
                    (l.userEmail || '').toLowerCase().includes(searchTerm) ||
                    (l.targetId || '').toLowerCase().includes(searchTerm) ||
                    (l.details || '').toLowerCase().includes(searchTerm)
                );
                // Handle filter logic for edit/update synonym
                const matchesAction = actionTerm === "all" || 
                                     (actionTerm === "edit" ? (l.action === "edit" || l.action === "update") : l.action === actionTerm);
                
                const matchesDate = !dateTerm || l.dateStr === dateTerm;
                return matchesSearch && matchesAction && matchesDate;
            });

            if (currentFiltered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 40px; color: #94a3b8;">No matching logs found for your filters.</td></tr>';
                return;
            }

            tbody.innerHTML = currentFiltered.map(d => `
                <tr>
                    <td style="color: #64748b">${d.displayDate}</td>
                    <td><strong>${d.userEmail || 'System'}</strong></td>
                    <td><span class="pill pill-${d.actionType || 'view'}">${d.action || 'view'}</span></td>
                    <td><code>${d.targetId || '‚Äî'}</code></td>
                    <td style="color: #475569">${d.details || ''}</td>
                </tr>
            `).join('');
        }

        // CSV Export
        downloadBtn.addEventListener("click", () => {
            if (currentFiltered.length === 0) return alert("No data to export");
            const headers = ["Date_Time", "User", "Action", "Target_AssetID", "Details"];
            const rows = currentFiltered.map(l => [
                l.displayDate,
                l.userEmail || "System",
                l.action || "view",
                l.targetId || "",
                `"${(l.details || "").replace(/"/g, '""')}"`
            ]);
            const csvContent = [headers, ...rows].map(e => e.join(",")).join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Audit_Log_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
        });

        searchInput.addEventListener("input", renderTable);
        actionFilter.addEventListener("change", renderTable);
        dateFilter.addEventListener("change", renderTable);
        resetBtn.addEventListener("click", () => {
            searchInput.value = ""; actionFilter.value = "all"; dateFilter.value = "";
            renderTable();
        });
    </script>
</body>
</html>
