<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Audits & Logs</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}
  .topbar{
    background:var(--bg);color:white;
    padding:12px 16px;display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .content{padding:22px;max-width:1100px;margin:0 auto;}

  h1{margin:0 0 6px;font-size:1.4rem;}
  .subtitle{color:#64748b;font-size:.9rem;margin-bottom:16px;}

  .card{
    background:white;border-radius:12px;
    padding:16px;border:1px solid var(--border);
    margin-bottom:18px;
  }

  .filters{
    display:flex;gap:10px;flex-wrap:wrap;margin-bottom:8px;
  }
  select,input{
    padding:6px 9px;border-radius:8px;border:1px solid var(--border);font-size:.85rem;
  }
  .btn{
    border:none;cursor:pointer;
    padding:6px 11px;border-radius:999px;
    font-size:.83rem;font-weight:500;
    display:inline-flex;align-items:center;gap:6px;
    background:var(--brand);color:white;
  }

  .table-wrap{border-radius:12px;border:1px solid var(--border);overflow:auto;margin-top:6px;}
  table{border-collapse:collapse;width:100%;min-width:780px;font-size:.84rem;}
  th,td{padding:7px 9px;border-bottom:1px solid #f1f5f9;text-align:left;}
  th{background:#f8fafc;font-weight:600;color:#475569;}

  .pill{
    display:inline-flex;padding:2px 8px;border-radius:999px;font-size:.75rem;
  }
  .pill-create{background:#dcfce7;color:#166534;}
  .pill-update{background:#dbeafe;color:#1d4ed8;}
  .pill-delete{background:#fee2e2;color:#b91c1c;}
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> â€“ Audits & Logs</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking sessionâ€¦</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">
    <h1>Audit Trail</h1>
    <p class="subtitle">
      View who changed what and when across the inventory and software system.
    </p>

    <section class="card">
      <div class="filters">
        <select id="fAction">
          <option value="">All actions</option>
          <option value="create">Created</option>
          <option value="update">Updated</option>
          <option value="delete">Deleted</option>
        </select>
        <select id="fEntity">
          <option value="">All entities</option>
          <option value="item">Items</option>
          <option value="software_license">Software Licenses</option>
          <option value="software_product">Software Products</option>
        </select>
        <input id="fUser" placeholder="Filter by user emailâ€¦" />
        <button id="refreshBtn" class="btn" type="button">ðŸ”„ Refresh</button>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Time</th>
              <th>Action</th>
              <th>Entity</th>
              <th>Entity ID</th>
              <th>User</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6">Loading audit logsâ€¦</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
import { db, watchAuth } from "./firebase.js";
import {
  collection, getDocs, orderBy, query
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const whoEl     = document.getElementById("who");
const fAction   = document.getElementById("fAction");
const fEntity   = document.getElementById("fEntity");
const fUser     = document.getElementById("fUser");
const refreshBtn= document.getElementById("refreshBtn");
const tbody     = document.getElementById("tbody");

let allLogs = [];

watchAuth({
  allowedRoles:["admin","it","viewer"], // everyone can see logs
  whoEl,
  onReady: loadLogs
});

async function loadLogs(){
  const qRef = query(collection(db,"audits"), orderBy("timestamp","desc"));
  const snap = await getDocs(qRef);
  allLogs = [];
  snap.forEach(d=>{
    allLogs.push({ id:d.id, ...d.data() });
  });
  render();
}

function render(){
  const act = fAction.value;
  const ent = fEntity.value;
  const userTerm = (fUser.value || "").toLowerCase();

  const rows = allLogs.filter(log=>{
    if(act && log.action!==act) return false;
    if(ent && log.entityType!==ent) return false;
    if(userTerm && !(log.userEmail||"").toLowerCase().includes(userTerm)) return false;
    return true;
  });

  if(!rows.length){
    tbody.innerHTML = `<tr><td colspan="6">No audit events match the current filters.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.slice(0,200).map(l=>{
    const ts = l.timestamp?.toDate ? l.timestamp.toDate() : (l.timestamp ? new Date(l.timestamp) : null);
    const timeStr = ts ? ts.toISOString().replace("T"," ").slice(0,19) : "â€“";
    const actLabel = l.action || "unknown";
    const pillClass =
      actLabel==="create" ? "pill-create" :
      actLabel==="update" ? "pill-update" :
      actLabel==="delete" ? "pill-delete" : "";

    return `
      <tr>
        <td>${timeStr}</td>
        <td><span class="pill ${pillClass}">${escapeHtml(actLabel)}</span></td>
        <td>${escapeHtml(l.entityType || "")}</td>
        <td>${escapeHtml(l.entityId || "")}</td>
        <td>${escapeHtml(l.userEmail || "")}</td>
        <td>${escapeHtml(l.details || "")}</td>
      </tr>`;
  }).join("");
}

function escapeHtml(s){
  return String(s||"").replace(/[&<>"']/g,c=>(
    { "&":"&amp;","<":"&lt;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]
  ));
}

fAction.addEventListener("change", render);
fEntity.addEventListener("change", render);
fUser.addEventListener("input", render);
refreshBtn.addEventListener("click", loadLogs);
</script>

</body>
</html>
