<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory ‚Äì Audits</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
    --good:#22c55e;--warn:#f97316;--bad:#ef4444;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }

  .layout{
    display:grid;
    grid-template-columns:240px 1fr;
    min-height:calc(100vh - 52px);
  }

  .sidebar{ background:var(--bg2);color:white;padding:14px; }
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:0.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .nav .icon{width:18px;text-align:center;opacity:.8;}

  .content{ padding:18px; max-width:1200px; margin:0 auto; width:100%; }
  h1{margin:0 0 4px;font-size:1.4rem;}
  .subtitle{margin:0 0 14px;font-size:.9rem;color:#94a3b8;}

  .toolbar{
    display:flex; justify-content:space-between; align-items:center;
    gap:10px; flex-wrap:wrap; margin-bottom:15px;
  }
  .search-box{
    display:flex;align-items:center;gap:6px;
    background:white;border:1px solid var(--border);
    border-radius:8px;padding:6px 12px;
    max-width:400px;width:100%;
  }
  .search-box input{ border:none;outline:none;font-size:.88rem;width:100%; }

  .card{
    background:white;border:1px solid var(--border);
    border-radius:14px; padding:16px; margin-bottom:12px;
  }
  
  .table-wrap{
    background:white;border:1px solid var(--border);
    border-radius:12px;overflow:auto;
  }
  table{ border-collapse:collapse; width:100%; min-width:900px; }
  th,td{ padding:12px 10px; border-bottom:1px solid #f1f5f9; font-size:.85rem; text-align:left; }
  th{ background:#f8fafc; font-weight:600; color:#475569; position:sticky; top:0; }

  .pill{
    display:inline-flex; padding:2px 8px; border-radius:4px;
    font-size:.7rem; font-weight: 600; text-transform: uppercase;
  }
  .pill-create{background:#dcfce7;color:#166534;}
  .pill-update{background:#dbeafe;color:#1d4ed8;}
  .pill-delete{background:#fee2e2;color:#b91c1c;}
  .pill-role{background:#f3e8ff;color:#6b21a8;} /* Purple for Admin actions */
  .pill-invite{background:#ffedd5;color:#9a3412;} /* Orange for invites */
  .pill-gray{background:#f1f5f9;color:#475569;}

  .status-bar{ font-size:.8rem; color:#64748b; margin-top:10px; }
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Audits</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üìä</span><span>Main Dashboard</span></a>
      <a href="inventory-list.html"><span class="icon">üíª</span><span>Hardware</span></a>
      <a class="active" href="audits.html"><span class="icon">üïí</span><span>Audits</span></a>
      <a href="admin-console.html"><span class="icon">‚öôÔ∏è</span><span>Admin Console</span></a>
      <a href="login.html"><span class="icon">üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1>Audit Log</h1>
    <p class="subtitle">Real-time history of system changes and administrative actions.</p>

    <section class="card">
      <div class="toolbar">
        <div class="search-box">
          <span>üîç</span>
          <input id="search" placeholder="Search by user, asset tag, or action details..."/>
        </div>
        <div class="filters">
          <select id="actionFilter">
            <option value="">All Event Types</option>
            <option value="create">Item Created</option>
            <option value="update">Item Updated</option>
            <option value="delete">Item Deleted</option>
            <option value="user-invited">User Invited</option>
            <option value="role-change">Role Updated</option>
            <option value="login">Logins</option>
          </select>
        </div>
      </div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:180px;">Date & Time</th>
              <th>User</th>
              <th>Action</th>
              <th>Target ID</th>
              <th>Category</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="6" style="text-align:center; padding:30px;">Initializing secure connection...</td></tr>
          </tbody>
        </table>
      </div>
      <div class="status-bar" id="statusBar"></div>
    </section>
  </main>
</div>

<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import {
    collection, query, orderBy, limit, onSnapshot
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const whoEl = document.getElementById("who");
  const tbody = document.getElementById("tbody");
  const statusBar = document.getElementById("statusBar");
  const searchEl = document.getElementById("search");
  const actionFilter = document.getElementById("actionFilter");

  let allAudits = [];

  watchAuth({
    allowedRoles: ["admin", "it"],
    whoEl,
    onReady: () => {
      initRealtimeAudits();
      searchEl.addEventListener("input", render);
      actionFilter.addEventListener("change", render);
    }
  });

  // Real-time listener: The UI updates automatically when anyone saves a change
  function initRealtimeAudits() {
    setStatus("Syncing with Firestore...");
    
    const q = query(
      collection(db, "audits"),
      orderBy("timestamp", "desc"),
      limit(150)
    );

    onSnapshot(q, (snap) => {
      allAudits = [];
      snap.forEach(doc => {
        allAudits.push({ id: doc.id, ...doc.data() });
      });
      render();
      setStatus(`System Synced. Showing latest ${allAudits.length} events.`);
    }, (err) => {
      console.error("Audit Sync Error:", err);
      setStatus("Error: Connection lost.");
    });
  }

  function render() {
    const term = searchEl.value.toLowerCase();
    const actionVal = actionFilter.value;

    const filtered = allAudits.filter(ev => {
      const action = (ev.action || "").toLowerCase();
      
      // Action Dropdown Filter
      if (actionVal && action !== actionVal.toLowerCase()) return false;

      // Text Search Filter
      if (term) {
        const content = [
          ev.userEmail,
          ev.targetId,
          ev.targetType,
          ev.details,
          ev.action
        ].join(" ").toLowerCase();
        if (!content.includes(term)) return false;
      }
      return true;
    });

    if (filtered.length === 0) {
      tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:20px; color:#94a3b8;">No matching audit logs found.</td></tr>`;
      return;
    }

    tbody.innerHTML = filtered.map(ev => {
      const ts = ev.timestamp?.toDate ? ev.timestamp.toDate().toLocaleString() : "‚Äî";
      const action = (ev.action || "other").toLowerCase();
      
      // Determine Pill Style
      let pClass = "pill-gray";
      if (action.includes("create")) pClass = "pill-create";
      else if (action.includes("update")) pClass = "pill-update";
      else if (action.includes("delete")) pClass = "pill-delete";
      else if (action.includes("invite")) pClass = "pill-invite";
      else if (action.includes("role") || action.includes("admin")) pClass = "pill-role";

      return `
        <tr>
          <td style="color:#64748b; font-family:monospace;">${ts}</td>
          <td><strong>${escapeHtml(ev.userEmail || "System")}</strong></td>
          <td><span class="pill ${pClass}">${action}</span></td>
          <td><code style="background:#f1f5f9; padding:2px 4px; border-radius:4px;">${escapeHtml(ev.targetId || "N/A")}</code></td>
          <td style="text-transform: capitalize;">${escapeHtml(ev.targetType || "‚Äî")}</td>
          <td style="max-width:300px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;" title="${escapeHtml(ev.details || "")}">
            ${escapeHtml(ev.details || "‚Äî")}
          </td>
        </tr>
      `;
    }).join("");
  }

  function setStatus(msg) { statusBar.textContent = msg; }

  function escapeHtml(s) {
    if(!s) return "";
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }
</script>

</body>
</html>
