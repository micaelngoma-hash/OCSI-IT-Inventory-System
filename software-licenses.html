<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Software Licenses & Compliance</title>
<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
    --good:#22c55e;--warn:#f97316;--bad:#ef4444;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}
  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }
  .layout{display:grid;grid-template-columns:240px 1fr;min-height:calc(100vh - 52px);}
  .sidebar{background:var(--bg2);color:white;padding:14px;}
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:0.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .nav .icon{width:18px;text-align:center;opacity:.8;}
  .content{padding:18px;max-width:1250px;margin:0 auto;width:100%;}
  h1{margin:0 0 4px;font-size:1.4rem;}
  .subtitle{margin:0 0 14px;font-size:.9rem;color:#94a3b8;}
  .badge{padding:2px 7px;border-radius:999px;font-size:.75rem;}
  .badge-admin{background:rgba(34,197,94,.12);color:#16a34a;}
  .badge-it{background:rgba(59,130,246,.12);color:#1d4ed8;}
  .badge-viewer{background:rgba(148,163,184,.2);color:#475569;}

  .grid-main{
    display:grid;
    grid-template-columns:1.65fr 1.1fr;
    gap:14px;
  }
  @media(max-width:1040px){
    .layout{grid-template-columns:1fr;}
    .grid-main{grid-template-columns:1fr;}
  }

  .card{
    background:white;border:1px solid var(--border);
    border-radius:14px;padding:14px 16px;margin-bottom:10px;
  }
  .card h2{
    margin:0 0 8px;font-size:1.05rem;
    display:flex;justify-content:space-between;align-items:center;
  }
  .card h2 span.right-link{
    font-size:.8rem;font-weight:400;
  }
  .card h2 span.right-link a{
    color:var(--brand);text-decoration:none;
  }
  .card h2 span.right-link a:hover{text-decoration:underline;}
  .muted{font-size:.82rem;color:#94a3b8;margin-bottom:6px;}

  .toolbar{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:8px;gap:10px;flex-wrap:wrap;
  }
  .search-box{
    display:flex;align-items:center;gap:6px;
    background:white;border:1px solid var(--border);
    border-radius:999px;padding:4px 10px;
    max-width:280px;width:100%;
  }
  .search-box input{
    border:none;outline:none;font-size:.88rem;width:100%;
  }
  select{
    padding:6px 8px;border-radius:999px;
    border:1px solid var(--border);font-size:.85rem;background:white;
  }
  .btn{
    border:none;cursor:pointer;
    padding:6px 12px;border-radius:999px;
    font-size:.85rem;font-weight:500;
    display:inline-flex;align-items:center;gap:5px;
    text-decoration:none;
  }
  .btn-primary{background:var(--brand);color:white;}
  .btn-ghost{background:transparent;border:1px solid #cbd5e1;color:#0f172a;}

  .table-wrap{
    background:white;border:1px solid var(--border);
    border-radius:12px;overflow:auto;
  }
  table{border-collapse:collapse;width:100%;min-width:830px;}
  th,td{
    padding:7px 9px;border-bottom:1px solid #f1f5f9;
    font-size:.86rem;text-align:left;
  }
  th{background:#f8fafc;font-weight:600;color:#475569;position:sticky;top:0;z-index:5;}
  tr:hover td{background:#f9fafb;}
  tr.selected td{background:#e0f2fe !important;}

  .pill{
    padding:2px 9px;border-radius:999px;font-size:.75rem;
    display:inline-flex;align-items:center;gap:4px;
  }
  .pill-good{background:#dcfce7;color:#166534;}
  .pill-warn{background:#ffedd5;color:#c2410c;}
  .pill-bad{background:#fee2e2;color:#b91c1c;}
  .pill-neutral{background:#e5e7eb;color:#374151;}

  .stat-block{display:flex;flex-wrap:wrap;gap:8px;margin:6px 0 10px;font-size:.84rem;}
  .stat-chip{
    background:#f9fafb;border-radius:999px;border:1px solid #e5e7eb;
    padding:4px 9px;
  }

  .list{margin:4px 0 0;padding:0;list-style:none;font-size:.86rem;}
  .list li{
    display:flex;justify-content:space-between;align-items:center;
    padding:4px 0;border-bottom:1px dashed #e5e7eb;
  }
  .list li:last-child{border-bottom:none;}
  .list span.label{color:#475569;}
  .list span.value{color:#0f172a;font-weight:500;font-size:.85rem;}
  .inline-link{color:var(--brand);text-decoration:none;font-size:.83rem;}
  .inline-link:hover{text-decoration:underline;}

  .small{font-size:.78rem;color:#9ca3af;margin-top:6px;}
</style>
</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Software Licenses & Compliance</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<div class="layout">
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üìä</span><span>Main Dashboard</span></a>
      <a href="inventory-list.html"><span class="icon">üìã</span><span>Inventory List</span></a>
      <a href="software-dashboard.html"><span class="icon">üíª</span><span>Software Dashboard</span></a>
      <a class="active" href="software-licenses.html"><span class="icon">üîë</span><span>Licenses & Compliance</span></a>
      <a href="scan.html"><span class="icon">üì±</span><span>QR Scan Device</span></a>
      <a href="admin-console.html"><span class="icon">‚öôÔ∏è</span><span>Admin Console</span></a>
      <a href="export.html"><span class="icon">‚¨áÔ∏è</span><span>Export</span></a>
      <a href="audits.html"><span class="icon">üïí</span><span>Audits</span></a>
      <a href="login.html"><span class="icon">üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <main class="content">
    <h1>Software Licenses</h1>
    <p class="subtitle">
      Overview of all license pools, usage and compliance. Click a license to see its assignments.
    </p>

    <div class="grid-main">
      <!-- LEFT: licenses table -->
      <section>
        <div class="card">
          <div class="toolbar">
            <div class="search-box">
              <span>üîç</span>
              <input id="search" placeholder="Search by software, vendor, key‚Ä¶"/>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <select id="statusFilter">
                <option value="">All statuses</option>
                <option value="good">OK</option>
                <option value="warn">Expiring soon</option>
                <option value="bad">Overused / expired</option>
              </select>
              <button id="newBtn" class="btn btn-primary" type="button">
                ‚ûï New License
              </button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Software</th>
                  <th>Vendor</th>
                  <th>Seats</th>
                  <th>Used</th>
                  <th>Free</th>
                  <th>Expiry</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="tbody">
                <tr><td colspan="7">Loading licenses‚Ä¶</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- RIGHT: details & assignments -->
      <section>
        <div class="card" id="detailsCard">
          <h2>
            License Details
            <span class="right-link" id="detailsLink" style="display:none;">
              <a href="#" id="openProductLink">Open product</a>
            </span>
          </h2>
          <p class="muted" id="detailsIntro">
            Select a license on the left to see usage and assignments.
          </p>

          <div id="detailsBody" style="display:none;">
            <div style="font-size:.92rem;margin-bottom:4px;">
              <strong id="d_softName"></strong>
              <span id="d_vendor" style="color:#64748b;margin-left:4px;"></span>
            </div>
            <div class="stat-block">
              <span class="stat-chip"><strong id="d_total">0</strong> seats</span>
              <span class="stat-chip"><strong id="d_used">0</strong> used</span>
              <span class="stat-chip"><strong id="d_free">0</strong> free</span>
              <span class="stat-chip">Expiry: <span id="d_expiry">‚Äì</span></span>
              <span class="stat-chip">Status: <span id="d_statusPill" class="pill pill-neutral">‚Äì</span></span>
            </div>

            <h3 style="margin:10px 0 4px;font-size:.95rem;">Assignments</h3>
            <p class="muted">Where this license is currently used.</p>
            <ul class="list" id="assignList">
              <li><span class="label">Loading‚Ä¶</span><span class="value">‚Äì</span></li>
            </ul>
            <p class="small">
              Assignments come from the <code>software_assignment</code> collection (device &amp; user links).
              You can extend this later with inline ‚ÄúAssign / Revoke‚Äù actions.
            </p>
          </div>
        </div>
      </section>
    </div>
  </main>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { getAuth, onAuthStateChanged }
    from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7",
    measurementId: "G-CM3P9CRX1K"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  const ALLOWED_ROLES = ["admin","it","viewer"];
  const EDIT_ROLES    = ["admin","it"];

  const whoEl   = document.getElementById("who");
  const tbody   = document.getElementById("tbody");
  const searchEl = document.getElementById("search");
  const statusFilter = document.getElementById("statusFilter");
  const newBtn  = document.getElementById("newBtn");

  const detailsBody  = document.getElementById("detailsBody");
  const detailsIntro = document.getElementById("detailsIntro");
  const openProductLink = document.getElementById("openProductLink");
  const detailsLink = document.getElementById("detailsLink");
  const assignList = document.getElementById("assignList");
  const d_softName = document.getElementById("d_softName");
  const d_vendor   = document.getElementById("d_vendor");
  const d_total    = document.getElementById("d_total");
  const d_used     = document.getElementById("d_used");
  const d_free     = document.getElementById("d_free");
  const d_expiry   = document.getElementById("d_expiry");
  const d_statusPill = document.getElementById("d_statusPill");

  let currentRole = "viewer";
  let licenses = [];
  let productsById = {};
  let assignmentsByLicense = {};
  let itemsById = {};
  let usersById = {};
  let selectedId = null;

  onAuthStateChanged(auth, async user=>{
    if(!user){
      location.href="login.html";
      return;
    }
    const uSnap = await getDoc(doc(db,"users",user.uid));
    const role  = uSnap.exists()? (uSnap.data().role || "viewer") : "viewer";
    currentRole = role;

    if(!ALLOWED_ROLES.includes(role)){
      alert("Access denied.");
      location.href="login.html";
      return;
    }

    const badge = role==="admin" ? "badge-admin"
                 : role==="it" ? "badge-it" : "badge-viewer";
    whoEl.innerHTML = `${user.email} <span class="badge ${badge}">${role}</span>`;

    if(!EDIT_ROLES.includes(role)){
      newBtn.style.display="none";
    }else{
      // You can create a dedicated form page or later turn this into a modal
      newBtn.onclick = ()=> location.href="software-license-form.html";
    }

    await loadAllData();
    renderTable();
  });

  function toDate(val){
    if(!val) return null;
    if(val.toDate) return val.toDate();
    return new Date(val);
  }

  function classifyLicense(lic){
    const total = Number(lic.totalSeats || 0);
    const used  = Number(lic.assignedSeats || 0);
    const exp   = toDate(lic.expiryDate);
    const now   = new Date();
    const soon  = new Date(now.getTime() + 30*24*60*60*1000);
    let level="good", label="OK";

    if(total && used > total){
      level="bad"; label="Overused";
    }else if(exp && exp < now){
      level="bad"; label="Expired";
    }else if(exp && exp <= soon){
      level="warn"; label="Expiring soon";
    }

    return { level, label };
  }

  async function loadAllData(){
    // products
    const prodSnap = await getDocs(collection(db,"software_product"));
    productsById = {};
    prodSnap.forEach(p=>{
      productsById[p.id] = p.data();
    });

    // licenses
    const licSnap = await getDocs(collection(db,"software_license"));
    licenses = [];
    licSnap.forEach(l=>{
      licenses.push({ id:l.id, ...l.data() });
    });

    // assignments
    const assSnap = await getDocs(collection(db,"software_assignment"));
    assignmentsByLicense = {};
    const deviceIds = new Set();
    const userIds   = new Set();

    assSnap.forEach(a=>{
      const d = a.data();
      const lid = d.softwareLicenseId;
      if(!lid) return;
      if(!assignmentsByLicense[lid]) assignmentsByLicense[lid] = [];
      assignmentsByLicense[lid].push({ id:a.id, ...d });
      if(d.deviceId) deviceIds.add(d.deviceId);
      if(d.userId)   userIds.add(d.userId);
    });

    // items & users lookup (simple approach: load all)
    const itemSnap = await getDocs(collection(db,"items"));
    itemsById = {};
    itemSnap.forEach(i=>{ itemsById[i.id] = i.data(); });

    const userSnap = await getDocs(collection(db,"users"));
    usersById = {};
    userSnap.forEach(u=>{ usersById[u.id] = u.data(); });
  }

  function renderTable(){
    const term = (searchEl.value || "").toLowerCase();
    const filt = statusFilter.value;

    const rows = licenses.filter(lic=>{
      const prod = productsById[lic.softwareProductId] || {};
      const { level } = classifyLicense(lic);

      if(filt && level!==filt) return false;

      if(term){
        const hay = [
          prod.softwareName || prod.name || "",
          lic.vendor || "",
          lic.licenseKey || "",
        ].join(" ").toLowerCase();
        if(!hay.includes(term)) return false;
      }
      return true;
    });

    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="7">No licenses found.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(lic=>{
      const prod = productsById[lic.softwareProductId] || {};
      const name = prod.softwareName || prod.name || "Unknown software";

      const total = Number(lic.totalSeats || 0);
      const used  = Number(lic.assignedSeats || 0);
      const free  = total ? Math.max(0,total-used) : "‚àû";

      const exp   = toDate(lic.expiryDate);
      const expStr = exp ? exp.toISOString().slice(0,10) : "‚Äì";

      const { level, label } = classifyLicense(lic);
      const pillClass = level==="good" ? "pill-good" : level==="warn" ? "pill-warn" : "pill-bad";

      const selectedClass = (lic.id === selectedId) ? "selected" : "";

      return `
        <tr class="${selectedClass}" data-id="${lic.id}">
          <td>${escapeHtml(name)}</td>
          <td>${escapeHtml(lic.vendor || "")}</td>
          <td>${total || "‚àû"}</td>
          <td>${used}</td>
          <td>${free}</td>
          <td>${expStr}</td>
          <td><span class="pill ${pillClass}">${label}</span></td>
        </tr>`;
    }).join("");

    [...tbody.querySelectorAll("tr[data-id]")].forEach(tr=>{
      tr.addEventListener("click", ()=>{
        selectedId = tr.getAttribute("data-id");
        renderTable();     // to refresh ‚Äúselected‚Äù class
        renderDetails();
      });
    });
  }

  function renderDetails(){
    if(!selectedId){
      detailsBody.style.display="none";
      detailsIntro.style.display="block";
      return;
    }
    const lic = licenses.find(l=>l.id===selectedId);
    if(!lic){
      detailsBody.style.display="none";
      detailsIntro.style.display="block";
      return;
    }

    const prod = productsById[lic.softwareProductId] || {};
    const softName = prod.softwareName || prod.name || "Unknown software";
    d_softName.textContent = softName;
    d_vendor.textContent   = lic.vendor ? `‚Ä¢ ${lic.vendor}` : "";

    const total = Number(lic.totalSeats || 0);
    const used  = Number(lic.assignedSeats || 0);
    const free  = total ? Math.max(0,total-used) : "‚àû";

    d_total.textContent = total || "‚àû";
    d_used.textContent  = used;
    d_free.textContent  = free;

    const exp   = toDate(lic.expiryDate);
    d_expiry.textContent = exp ? exp.toISOString().slice(0,10) : "‚Äì";

    const { level, label } = classifyLicense(lic);
    d_statusPill.textContent = label;
    d_statusPill.className = "pill " + (
      level==="good" ? "pill-good" :
      level==="warn" ? "pill-warn" :
      level==="bad"  ? "pill-bad"  : "pill-neutral"
    );

    if(lic.softwareProductId){
      detailsLink.style.display="inline";
      openProductLink.href = `software-products.html?id=${encodeURIComponent(lic.softwareProductId)}`;
    }else{
      detailsLink.style.display="none";
    }

    // assignments
    const list = assignmentsByLicense[selectedId] || [];
    if(!list.length){
      assignList.innerHTML = `<li><span class="label">No assignments yet.</span><span class="value">0</span></li>`;
    }else{
      assignList.innerHTML = list.slice(0,8).map(a=>{
        let targetLabel = "";
        let type = "";
        if(a.deviceId && itemsById[a.deviceId]){
          const dev = itemsById[a.deviceId];
          targetLabel = (dev.deviceName || dev.assetId || a.deviceId);
          type = "Device";
        }else if(a.userId && usersById[a.userId]){
          const u = usersById[a.userId];
          targetLabel = u.name || u.email || a.userId;
          type = "User";
        }else if(a.deviceId){
          targetLabel = a.deviceId;
          type = "Device";
        }else if(a.userId){
          targetLabel = a.userId;
          type = "User";
        }else{
          targetLabel = "(Unknown target)";
          type = "Unknown";
        }

        const dateStr = a.assignmentDate
          ? (toDate(a.assignmentDate)?.toISOString().slice(0,10) || "")
          : "";

        return `
          <li>
            <span class="label">${escapeHtml(targetLabel)} <span style="color:#9ca3af;">(${type})</span></span>
            <span class="value">${dateStr || ""}</span>
          </li>`;
      }).join("");

      if(list.length>8){
        const more = list.length-8;
        assignList.innerHTML += `<li><span class="label">${more} more assignments‚Ä¶</span><span class="value"><a class="inline-link" href="software-compliance.html">View report</a></span></li>`;
      }
    }

    detailsIntro.style.display="none";
    detailsBody.style.display="block";
  }

  function escapeHtml(s){
    if(!s) return "";
    return String(s).replace(/[&<>"']/g, c=>(
      { "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]
    ));
  }

  searchEl.addEventListener("input", renderTable);
  statusFilter.addEventListener("change", renderTable);
</script>

</body>
</html>
