<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>OCSI IT Inventory – Software Licenses & Compliance</title>

<style>
  :root{ --bg:#0f172a; --bg2:#0b1020; --brand:#1a73e8; --border:#e5e7eb; }
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  .topbar{
    background:var(--bg);color:white;padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }

  .layout{display:grid;grid-template-columns:240px 1fr;min-height:100vh;}
  .sidebar{background:var(--bg2);padding:14px;color:white;}

  .content{padding:26px;max-width:1300px;width:100%;margin:0 auto;}

  h1{margin:0 0 20px;font-size:1.6rem;}
  h2{margin:20px 0 10px;font-size:1.2rem;}

  .btn{
    padding:6px 12px;border-radius:8px;
    background:var(--brand);color:white;
    border:none;text-decoration:none;cursor:pointer;
    font-size:.85rem;
  }
  .btn-small{padding:4px 8px;font-size:.75rem;}

  table{
    width:100%;border-collapse:collapse;
    background:white;border-radius:10px;overflow:hidden;
  }
  th,td{
    padding:10px;border-bottom:1px solid #f1f5f9;
    font-size:.88rem;text-align:left;
  }
  th{background:#f8fafc;font-weight:600;color:#475569;}

  .pill{
    padding:2px 8px;border-radius:999px;font-size:.75rem;
    display:inline-block;
  }
  .pill-green{background:#dcfce7;color:#166534;}
  .pill-red{background:#fee2e2;color:#b91c1c;}
  .pill-yellow{background:#fef9c3;color:#b45309;}
  .pill-blue{background:#dbeafe;color:#1d4ed8;}

  .separator{margin:30px 0;border-top:2px solid #e5e7eb;}
</style>

</head>
<body>

<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> – Software Licenses & Compliance</div>
  <div id="who" style="font-size:.85rem;opacity:.8;">Checking session…</div>
</div>

<div class="layout">
  <aside class="sidebar" id="sidebar-root"></aside>

  <main class="content">

    <h1>Software Licenses</h1>

    <!-- PRODUCT LIST -->
    <h2>Software Products</h2>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Vendor</th>
          <th>Category</th>
          <th>Total Licenses</th>
          <th>Seats Used</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="products-body">
        <tr><td colspan="6">Loading software…</td></tr>
      </tbody>
    </table>

    <div class="separator"></div>

    <!-- LICENSE POOLS -->
    <h2>License Pools</h2>
    <table>
      <thead>
        <tr>
          <th>Software</th>
          <th>Key / Code</th>
          <th>Total Seats</th>
          <th>Used</th>
          <th>Expiry</th>
          <th>Compliance</th>
          <th>Assign</th>
        </tr>
      </thead>
      <tbody id="licenses-body">
        <tr><td colspan="7">Loading licenses…</td></tr>
      </tbody>
    </table>

  </main>
</div>

<script src="sidebar.js"></script>

<script type="module">
  import { db, watchAuth } from "./firebase.js";
  import {
    collection, getDocs, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const who         = document.getElementById("who");
  const bodyProd    = document.getElementById("products-body");
  const bodyLic     = document.getElementById("licenses-body");

  watchAuth({
    allowedRoles:["admin","it","viewer"],
    whoEl: who,
    onReady: loadAll
  });

  function fmt(d){
    if(!d) return "—";
    if(d.toDate) d = d.toDate();
    return d.toISOString().slice(0,10);
  }

  async function loadAll(){
    const prodSnap = await getDocs(collection(db,"software_product"));
    const licSnap  = await getDocs(collection(db,"software_license"));

    const products = {};
    prodSnap.forEach(p=> products[p.id] = { id:p.id, ...p.data() });

    // RENDER PRODUCTS
    bodyProd.innerHTML = Object.values(products).map(p=>{
      const totalLic = Object.values(products).filter(x=>x.productId===p.id).length;
      return `
        <tr>
          <td>${p.name}</td>
          <td>${p.vendor||"—"}</td>
          <td>${p.category||"—"}</td>
          <td>${p.totalLicenses||0}</td>
          <td>${p.usedSeats||0}</td>
          <td>
            <a href="assign-license.html?product=${p.id}" class="btn-small">Edit</a>
          </td>
        </tr>
      `;
    }).join("");

    // RENDER LICENSE POOLS
    bodyLic.innerHTML = "";

    licSnap.forEach(lic=>{
      const l = lic.data();
      const product = products[l.productId] || {name:"(deleted)"};

      const isOver  = Number(l.assignedSeats||0) > Number(l.totalSeats||0);
      const expSoon = l.expiryDate?.toDate() <= new Date(Date.now()+30*864e5);

      let compliance = `<span class="pill pill-green">OK</span>`;
      if(isOver) compliance = `<span class="pill pill-red">Over-used</span>`;
      else if(expSoon) compliance = `<span class="pill pill-yellow">Expiring</span>`;

      bodyLic.innerHTML += `
        <tr>
          <td>${product.name}</td>
          <td>${l.licenseKey||"—"}</td>
          <td>${l.totalSeats||0}</td>
          <td>${l.assignedSeats||0}</td>
          <td>${fmt(l.expiryDate)}</td>
          <td>${compliance}</td>
          <td>
            <a href="assign-license.html?license=${lic.id}" class="btn-small">Assign</a>
          </td>
        </tr>
      `;
    });

  }
</script>

</body>
</html>
