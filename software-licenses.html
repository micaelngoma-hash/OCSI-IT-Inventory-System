<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Software Licenses & Compliance</title>

<style>
  :root{
    --bg:#0f172a;--bg2:#0b1020;--brand:#1a73e8;--border:#e5e7eb;
    --good:#22c55e;--warn:#f97316;--bad:#ef4444;
  }
  *{box-sizing:border-box;}
  body{margin:0;font-family:system-ui;background:#f5f7fb;}

  /* TOP BAR */
  .topbar{
    position:sticky;top:0;z-index:20;
    background:var(--bg);color:white;
    padding:12px 16px;
    display:flex;justify-content:space-between;align-items:center;
  }

  /* PAGE LAYOUT */
  .layout{
    display:grid;grid-template-columns:240px 1fr;
    min-height:calc(100vh - 52px);
  }
  .sidebar{
    background:var(--bg2);color:white;padding:14px;
  }
  .nav a{
    display:flex;align-items:center;gap:8px;
    padding:9px 11px;border-radius:9px;
    color:#dbe4ff;text-decoration:none;margin-bottom:6px;
    font-size:.92rem;
  }
  .nav a:hover,.nav a.active{background:#111a33;}
  .icon{width:18px;text-align:center;opacity:.8;}

  .content{
    padding:18px;max-width:1250px;margin:0 auto;width:100%;
  }
  h1{margin:0 0 4px;font-size:1.45rem;}
  .subtitle{color:#94a3b8;font-size:.9rem;margin-bottom:12px;}

  .badge{padding:2px 7px;border-radius:999px;font-size:.75rem;}
  .badge-admin{background:rgba(34,197,94,.12);color:#16a34a;}
  .badge-it{background:rgba(59,130,246,.12);color:#1d4ed8;}
  .badge-viewer{background:rgba(148,163,184,.2);color:#475569;}

  /* TABLE + BUTTONS */
  .toolbar{
    display:flex;justify-content:space-between;align-items:center;
    margin-bottom:12px;flex-wrap:wrap;gap:10px;
  }
  .btn{
    padding:6px 12px;border-radius:999px;border:none;cursor:pointer;
    font-size:.85rem;font-weight:500;
    display:flex;align-items:center;gap:6px;
    text-decoration:none;
  }
  .btn-primary{background:var(--brand);color:white;}
  .btn-ghost{background:transparent;border:1px solid #cbd5e1;color:#0f172a;}

  .table-wrap{
    background:white;border:1px solid var(--border);
    border-radius:12px;overflow:auto;
  }
  table{width:100%;border-collapse:collapse;min-width:900px;}
  th,td{
    padding:8px 10px;border-bottom:1px solid #f1f5f9;
    font-size:.88rem;text-align:left;
  }
  th{background:#f8fafc;font-weight:600;color:#475569;}

  tr:hover td{background:#f9fafb;}

  .pill{padding:2px 8px;border-radius:999px;font-size:.75rem;}
  .pill-green{background:#dcfce7;color:#166534;}
  .pill-warn{background:#ffedd5;color:#c2410c;}
  .pill-bad{background:#fee2e2;color:#b91c1c;}
  .pill-neutral{background:#e5e7eb;color:#374151;}

</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div><strong>OCSI IT Inventory</strong> ‚Äì Software Licenses & Compliance</div>
  <div id="who" style="font-size:.85rem;opacity:.9;">Checking session‚Ä¶</div>
</div>

<!-- MAIN LAYOUT -->
<div class="layout">

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <nav class="nav">
      <a href="index.html"><span class="icon">üìä</span><span>Main Dashboard</span></a>
      <a href="software-dashboard.html"><span class="icon">üíª</span><span>Software Dashboard</span></a>
      <a class="active" href="software-licenses.html"><span class="icon">üîë</span><span>Licenses & Compliance</span></a>
      <a href="inventory-list.html"><span class="icon">üìã</span><span>Inventory List</span></a>
      <a href="scan.html"><span class="icon">üì±</span><span>QR Scan Device</span></a>
      <a href="admin-console.html"><span class="icon">‚öôÔ∏è</span><span>Admin Console</span></a>
      <a href="export.html"><span class="icon">‚¨áÔ∏è</span><span>Export</span></a>
      <a href="audits.html"><span class="icon">üïí</span><span>Audits</span></a>
      <a href="login.html"><span class="icon">üö™</span><span>Logout</span></a>
    </nav>
  </aside>

  <!-- CONTENT -->
  <main class="content">

    <h1>Software Licenses</h1>
    <p class="subtitle">Overview of all tracked licenses, usage, expiry, and compliance alerts.</p>

    <div class="toolbar">
      <div></div>
      <button id="addBtn" class="btn btn-primary">‚ûï New License</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Software</th>
            <th>Total Seats</th>
            <th>Assigned</th>
            <th>Status</th>
            <th>Expiry</th>
            <th style="width:120px;">Actions</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="6">Loading licenses‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

  </main>

</div>

<!-- FIREBASE LOGIC -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { 
    getFirestore, collection, doc, getDocs, deleteDoc 
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
  import { 
    getAuth, onAuthStateChanged 
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

  /* FIREBASE CONFIG */
  const firebaseConfig = {
    apiKey: "AIzaSyCnf-hKBJXqEkmwwdM29RWwvZjSAmTMGSE",
    authDomain: "ocsi-it-iventory-system.firebaseapp.com",
    projectId: "ocsi-it-iventory-system",
    storageBucket: "ocsi-it-iventory-system.firebasestorage.app",
    messagingSenderId: "941219752022",
    appId: "1:941219752022:web:f3214e808d36a4a53833f7"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  const ALLOWED = ["admin","it","viewer"];
  const EDIT = ["admin","it"];

  const whoEl = document.getElementById("who");
  const addBtn = document.getElementById("addBtn");
  const tbody = document.getElementById("tbody");

  let currentRole = "viewer";

  /* AUTH CHECK */
  onAuthStateChanged(auth, async user=>{
    if(!user){ location.href="login.html"; return; }

    const userRef = doc(db,"users",user.uid);
    const snap = await getDocs(collection(db,"users"));
    const usrSnap = await (await import("https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js"))
      .getDoc(userRef);

    let role = usrSnap.exists()? (usrSnap.data().role || "viewer") : "viewer";
    currentRole = role;

    if(!ALLOWED.includes(role)){
      alert("Access denied.");
      location.href="index.html";
      return;
    }

    const badge = role==="admin"?"badge-admin":role==="it"?"badge-it":"badge-viewer";
    whoEl.innerHTML = `${user.email} <span class="badge ${badge}">${role}</span>`;

    if(!EDIT.includes(role)) addBtn.style.display="none";
    else addBtn.onclick = ()=>location.href="software-license-form.html";

    loadLicenses();
  });

  /* MAIN DATA LOAD */
  async function loadLicenses(){
    const snap = await getDocs(collection(db,"software_license"));
    const rows=[];
    snap.forEach(ds=> rows.push({id:ds.id, ...ds.data()}));
    render(rows);
  }

  function render(rows){
    if(!rows.length){
      tbody.innerHTML = `<tr><td colspan="6">No licenses found.</td></tr>`;
      return;
    }

    tbody.innerHTML = rows.map(l=>{
      const used = Number(l.assignedSeats||0);
      const total = Number(l.totalSeats||0);

      /* STATUS PILL */
      let status = "OK";
      let pillClass = "pill-green";

      const exp = parseDate(l.expiryDate);
      const now = new Date();
      const soon = new Date(now.getTime()+30*86400*1000);

      if(total && used>total){
        status = "Over-assigned";
        pillClass = "pill-bad";
      }
      else if(exp && exp<now){
        status = "Expired";
        pillClass = "pill-bad";
      }
      else if(exp && exp<soon){
        status = "Expiring soon";
        pillClass = "pill-warn";
      }

      const expiryText = exp ? exp.toISOString().substring(0,10) : "‚Äì";

      const viewUrl = `software-license_details.html?id=${l.id}`;
      const editUrl = `software-license-form.html?id=${l.id}`;

      const actions = EDIT.includes(currentRole)
        ? `
          <a class="btn btn-ghost" style="padding:3px 8px;font-size:.8rem;" href="${editUrl}">Edit</a>
          <button class="btn btn-ghost" style="padding:3px 8px;font-size:.8rem;color:#b91c1c;"
            onclick="deleteLicense('${l.id}')">Delete</button>`
        : `<a class="btn btn-ghost" style="padding:3px 8px;font-size:.8rem;" href="${viewUrl}">View</a>`;

      return `
        <tr>
          <td>${escapeHtml(l.softwareName||"‚Äì")}</td>
          <td>${total}</td>
          <td>${used}</td>
          <td><span class="pill ${pillClass}">${status}</span></td>
          <td>${expiryText}</td>
          <td>${actions}</td>
        </tr>
      `;
    }).join("");
  }

  /* DELETE */
  window.deleteLicense = async function(id){
    if(!confirm("Delete this license?")) return;
    await deleteDoc(doc(db,"software_license",id));
    alert("License deleted.");
    loadLicenses();
  }

  function parseDate(v){
    if(!v) return null;
    if(typeof v==="string") return new Date(v);
    if(v.toDate) return v.toDate();
    return null;
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>\"']/g, c=>({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"
    }[c]));
  }

</script>

</body>
</html>
